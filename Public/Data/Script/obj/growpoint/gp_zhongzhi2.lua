--Éú³¤ ği¬m½Å±¾,³É³¤ÏµÁĞ

--½Å±¾ºÅ
--g_ScriptId = 711001

-- Ëæ»úÒò×Ó
x711001_g_RandNum = 10000

-- Éú³¤ ği¬mĞÅÏ¢
x711001_g_GPInfo = {}

-- Éú³¤ ği¬mÀàĞÍºÅÎªË÷ÒıºÅ

-- NextGeneration: ¸ÃÉú³¤ ği¬m»ØÊÕºó³¤³ötoÕ ğµ ĞÂÉú³¤ ği¬mtoÕ ğµ ÀàĞÍ
-- MainProduct: Ö÷Òª²úÆ·toÕ ğµ ÎïÆ·ºÅ
-- ProtectDuration: ÈÃÖÖÖ²ÕßÊÕ¸îtoÕ ğµ ±£»¤Ê±¼ä
-- RecycleDuration: »ØÊÕÊ±¼ä
-- rareId: Ï¡ÓĞÆ·toÕ ğµ ÎïÆ·ºÅ,Èç¹ûÃ»ÓĞÔòÌî -1
-- rOdds: Ï¡ÓĞÆ·toÕ ğµ ³öÏÖ¼¸ÂÊ,random( x711001_g_RandNum ) <= rOdds Ê±Ï¡ÓĞÎïÆ·²úÉú,x711001_g_RandNum ¿ÉÒÔ¸ù¾İÊµ¼Ğúngé¿ö¸ü¸Ä

x711001_g_rareRules ={};
x711001_g_rareRules[1] = {{rate=77, num=1}, {rate=14, num=2}, {rate=9, num=3}};		--Íí²ú
x711001_g_rareRules[2] = {{rate=50, num=3}, {rate=30, num=4}, {rate=20, num=5}};	--Ôç²ú

x711001_g_GPInfo[	502	] = { NextGeneration =	503	, MainProduct =	20104001, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105013	, rOdds =	2000	}
x711001_g_GPInfo[	505	] = { NextGeneration =	506	, MainProduct =	20104002, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105014	, rOdds =	2000	}
x711001_g_GPInfo[	508	] = { NextGeneration =	509	, MainProduct =	20104003, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105015	, rOdds =	2000	}
x711001_g_GPInfo[	511	] = { NextGeneration =	512	, MainProduct =	20104004, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105016	, rOdds =	2000	}
x711001_g_GPInfo[	514	] = { NextGeneration =	515	, MainProduct =	20104005, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105017	, rOdds =	2000	}
x711001_g_GPInfo[	517	] = { NextGeneration =	518	, MainProduct =	20104006, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105018	, rOdds =	2000	}
x711001_g_GPInfo[	520	] = { NextGeneration =	521	, MainProduct =	20104007, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105019	, rOdds =	2000	}
x711001_g_GPInfo[	523	] = { NextGeneration =	524	, MainProduct =	20104008, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105020	, rOdds =	2000	}
x711001_g_GPInfo[	526	] = { NextGeneration =	527	, MainProduct =	20104009, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105021	, rOdds =	2000	}
x711001_g_GPInfo[	529	] = { NextGeneration =	530	, MainProduct =	20104010, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105022	, rOdds =	2000	}
x711001_g_GPInfo[	532	] = { NextGeneration =	533	, MainProduct =	20104011, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105023	, rOdds =	2000	}
x711001_g_GPInfo[	535	] = { NextGeneration =	536	, MainProduct =	20104012, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	20105024	, rOdds =	2000	}
x711001_g_GPInfo[	538	] = { NextGeneration =	539	, MainProduct =	20105001, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	541	] = { NextGeneration =	542	, MainProduct =	20105002, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	544	] = { NextGeneration =	545	, MainProduct =	20105003, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	547	] = { NextGeneration =	548	, MainProduct =	20105004, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	550	] = { NextGeneration =	551	, MainProduct =	20105005, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	553	] = { NextGeneration =	554	, MainProduct =	20105006, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	556	] = { NextGeneration =	557	, MainProduct =	20105007, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	559	] = { NextGeneration =	560	, MainProduct =	20105008, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	562	] = { NextGeneration =	563	, MainProduct =	20105009, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	565	] = { NextGeneration =	566	, MainProduct =	20105010, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	568	] = { NextGeneration =	569	, MainProduct =	20105011, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	571	] = { NextGeneration =	572	, MainProduct =	20105012, ProtectDuration =	300000, ProductCount = 1, RecycleDuration =	300000	,rareJunior = -1, rareId = 	-1	, rOdds =	0	}
                                                                                                                                              
x711001_g_GPInfo[	702	] = { NextGeneration =	703	, MainProduct =	20104001, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105013	, rOdds =	10000	}
x711001_g_GPInfo[	705	] = { NextGeneration =	706	, MainProduct =	20104002, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105014	, rOdds =	10000	}
x711001_g_GPInfo[	708	] = { NextGeneration =	709	, MainProduct =	20104003, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105015	, rOdds =	10000	}
x711001_g_GPInfo[	711	] = { NextGeneration =	712	, MainProduct =	20104004, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105016	, rOdds =	10000	}
x711001_g_GPInfo[	714	] = { NextGeneration =	715	, MainProduct =	20104005, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105017	, rOdds =	10000	}
x711001_g_GPInfo[	717	] = { NextGeneration =	718	, MainProduct =	20104006, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105018	, rOdds =	10000	}
x711001_g_GPInfo[	720	] = { NextGeneration =	721	, MainProduct =	20104007, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105019	, rOdds =	10000	}
x711001_g_GPInfo[	723	] = { NextGeneration =	724	, MainProduct =	20104008, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105020	, rOdds =	10000	}
x711001_g_GPInfo[	726	] = { NextGeneration =	727	, MainProduct =	20104009, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105021	, rOdds =	10000	}
x711001_g_GPInfo[	729	] = { NextGeneration =	730	, MainProduct =	20104010, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105022	, rOdds =	10000	}
x711001_g_GPInfo[	732	] = { NextGeneration =	733	, MainProduct =	20104011, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105023	, rOdds =	10000	}
x711001_g_GPInfo[	735	] = { NextGeneration =	736	, MainProduct =	20104012, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	20105024	, rOdds =	10000	}
x711001_g_GPInfo[	738	] = { NextGeneration =	739	, MainProduct =	20105001, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	741	] = { NextGeneration =	742	, MainProduct =	20105002, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	744	] = { NextGeneration =	745	, MainProduct =	20105003, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	747	] = { NextGeneration =	748	, MainProduct =	20105004, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	750	] = { NextGeneration =	751	, MainProduct =	20105005, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	753	] = { NextGeneration =	754	, MainProduct =	20105006, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	756	] = { NextGeneration =	757	, MainProduct =	20105007, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	759	] = { NextGeneration =	760	, MainProduct =	20105008, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	762	] = { NextGeneration =	763	, MainProduct =	20105009, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	765	] = { NextGeneration =	766	, MainProduct =	20105010, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	768	] = { NextGeneration =	769	, MainProduct =	20105011, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}
x711001_g_GPInfo[	771	] = { NextGeneration =	772	, MainProduct =	20105012, ProtectDuration =	900000, ProductCount = 10, RecycleDuration =	900000	,rareJunior =  1, rareId = 	-1	, rOdds =	0	}

function x711001_OnRecycle( sceneId, selfId, targetId )
	local growPointType = LuaFnGetItemBoxGrowPointType( sceneId, targetId )
	local GPInfo = x711001_g_GPInfo[growPointType]
	if not GPInfo then
		return 1
	end

	local itemBoxX = GetItemBoxWorldPosX( sceneId, targetId )
	local itemBoxZ = GetItemBoxWorldPosZ( sceneId, targetId )

--	local ItemBoxId = DropBoxEnterScene(	itemBoxX,itemBoxZ, sceneId )
--	for i=1,GPInfo.ProductCount do
--		AddItemToBox(sceneId,ItemBoxId,GPInfo.NextGeneration,GPInfo.MainProduct)
--	end
	
	local ItemBoxId = ItemBoxEnterScene( itemBoxX, itemBoxZ, GPInfo.NextGeneration, sceneId, 0, 0)
	for i=1,GPInfo.ProductCount do
		AddItemToBox(sceneId,ItemBoxId,QUALITY_MUST_BE_CHANGE,1,GPInfo.MainProduct)
	end
	
	-- ¼ÓÈëÏ¡ÓĞÎïÆ·
	local randomOdds = random( x711001_g_RandNum );
	if GPInfo.rareId ~= -1 and randomOdds <= GPInfo.rOdds then
		local selectrareRule;
		if GPInfo.rareJunior == 1 then
			selectrareRule = x711001_g_rareRules[2];
		else
			selectrareRule = x711001_g_rareRules[1];
		end
		
		local totalRate = 0;
		local rareRuleItem;
		for _, rareRuleItem in selectrareRule do
			totalRate = totalRate + rareRuleItem.rate;
		end

		local randomValue = random(totalRate);
		
		local itemNum = 0;
		for _, rareRuleItem in selectrareRule do
			if randomValue < rareRuleItem.rate then
				itemNum = rareRuleItem.num;
				break;
			end
			randomValue = randomValue - rareRuleItem.rate;
		end

		local itemp;
		for itemp = 0, itemNum - 1 do
			AddItemToBox(sceneId, ItemBoxId, QUALITY_MUST_BE_CHANGE, 1, GPInfo.rareId);
		end
	end

	-- ği¬mµ½Éú³¤ ği¬mtoÕ ğµ Ö÷ÈËGUID
	local ItemBoxOwnerGUID = GetItemBoxOwner( sceneId, targetId )				--²ÎÊıĞúngSceneID,ItemBoxID

	--¸øItemBoxÉè¶¨Ö÷ÈË
	SetItemBoxOwner( sceneId, ItemBoxId, ItemBoxOwnerGUID )
	SetItemBoxPickOwnerTime( sceneId, ItemBoxId, GPInfo.ProtectDuration )		--Éè¶¨°ó¶¨Ê±¼ä
	EnableItemBoxPickOwnerTime( sceneId, ItemBoxId )							--±£»¤Ê±¼ä¿ªÊ¼¼ÆÊ±

	SetItemBoxMaxGrowTime( sceneId, ItemBoxId, GPInfo.RecycleDuration )			--Éè¶¨»ØÊÕÊ±¼ä

	--È¡ ği¬mÉú³¤ ği¬mtoÕ ğµ ×ø±ê
	local GP_X = GetItemBoxWorldPosX( sceneId, targetId )
	local GP_Z = GetItemBoxWorldPosZ( sceneId, targetId )

	--ÏÂÈ¡Õû
	GP_X = floor( GP_X )
	GP_Z = floor( GP_Z )

	--ÅĞ¶ÏÖÖÖ²ÅÆtoÕ ğµ Î»ÖÃTÕi ÄÄcáiÖÖÖ²ÅÆ¹ÜÏ½toÕ ğµ ·¶Î§ÄÚ
	local num = 0
	local i = 0
	for i, findid in PLANTNPC_ADDRESS do
		if GP_X >= findid.X_MIN
		 and GP_Z >= findid.Z_MIN
		 and GP_X <= findid.X_MAX
		 and GP_Z <= findid.Z_MAX
		 and sceneId == findid.Scene then
			num = i
			break
		end
	end

	--Èç¹ûÕÒ²»µ½ÕıÈ·toÕ ğµ Î»ÖÃÔòTr· v«
	if num == 0 then
		return 1
	end

	--ÅĞ¶ÏÖÖÖ²ÅÆĞúng·ñĞúng8,Èç¹ûĞúng8ÔòÍ¨ÖªÍæ¼Ò
	if PLANTFLAG[num] == 8 then
		local strMail = format("Thñc v§t do các hÕ tr°ng ğã chín t¾i, trong %d phút s¨ tÕi ch² #G%s (%d,%d)#W thu hoÕch.",
										( GPInfo.ProtectDuration / 60000 ), GetSceneName(sceneId), GP_X, GP_Z )
		LuaFnSendMailToGUID( sceneId, ItemBoxOwnerGUID, strMail )
	end

	--ÕÒµ½ÕıÈ·toÕ ğµ ±àºÅ,°ÑÖÖÖ²ÅÆ-1
	PLANTFLAG[num] = PLANTFLAG[num] - 1

	return 1
end
