
--ÃÅÅÉÒýµ¼ÈÎÎñ

--½Å±¾ºÅ

----------------
--MisDescBegin
--½Å±¾ºÅ
x600045_g_ScriptId	= 600045

--Tiªp thøÈÎÎñNPCÊôÐÔ
x600045_g_Position_X=133
x600045_g_Position_Z=50

x600045_g_AccomplishNPC_Name="Võ ÐÕi Uy"

--ÈÎÎñºÅ
x600045_g_MissionId			= 1121

--Møc tiêu nhi®m vønpc
x600045_g_Name 					= "Võ ÐÕi Uy"
--ÈÎÎñ¹éÀà
x600045_g_MissionKind			= 50 --Íæ¼ÒThành ph¯ 
--ÐÆng c¤p nhi®m vø 
x600045_g_MissionLevel		= 10000
--Ðúng·ñÐúngTinhÓ¢ÈÎÎñ
x600045_g_IfMissionElite	= 0
--ÈÎÎñÐúng·ñÒÑ¾­Íê³É
x600045_g_IsMissionOkFail	= 0		--ÈÎÎñ²ÎÊýtoÕ ðµ µÚ0Î»

--ÈÎÎñÎÄ±¾ÃèÊö
x600045_g_MissionName			= "Tìm hi¬u tin tÑc"
--ÈÎÎñÃèÊö
x600045_g_MissionInfo			= "Bang phái nhi®m vø, lþi døng tình báo bµ tìm hi¬u này h¡n bang phái thành th¸ tß t¤n!"
--Møc tiêu nhi®m vø
x600045_g_MissionTarget		= "    C¥n cùng bän bang thành viên t± ðµi thu th§p 3 cái b¤t ð°ng bang phái thành th¸ tình báo, sau ðó ðªn #GVõ ÐÕi Uy #B[133,50]#W ch² lînh thß·ng cho!"
--Î´Hoàn t¤t nhi®m vøtoÕ ðµ npc¶Ô»°
x600045_g_ContinueInfo		= "Sñ tình tiªn tri¬n nhß thª nào r°i?"
--Hoàn t¤t nhi®m vønpcËµtoÕ ðµ »°
x600045_g_MissionComplete	= "Làm  t¯t l¡m, cäm tÕ ngß½i vì bän bang phái làm ra  c¯ng hiªn!"

--ÈÎÎñÐúng·ñÍê³É
--x600045_g_Mission_IsComplete = 0		--ÈÎÎñ²ÎÊýtoÕ ðµ µÚ0Î»
--´òÌ½µÚ¼¸cáiThành ph¯ 
x600045_g_city 				 	= 1		 --ÈÎÎñ²ÎÊýtoÕ ðµ µÚ1Î»

-- ÈÎÎñÍê³ÉÇé¿ö,ÄÚÈÝ¶¯Ì¬Ë¢ÐÂ,Õ¼ÓÃÈÎÎñ²ÎÊýtoÕ ðµ µÚ1Î»

x600045_g_Custom	= { {id="Ðã tìm hi¬u thành th¸",num=3} }
--MisDescEnd
----------------

x600045_g_SpyBook_id = 40004461;
x600045_g_ExpPrize = {}
x600045_g_ExpPrize[1] =
{
2510,2651,2789,2927,3070,3210,3351,3497,3640,3788,
7710,8050,8402,8756,9112,9461,9822,10184,10549,10906,
18165,18763,19364,19953,20560,21172,21786,22389,23010,23635,
35387,36307,37217,38147,39082,40007,40952,41902,42841,43801,
44766,45719,46694,47674,48659,49632,50627,51627,52615,53624,
54639,55641,56666,57695,58713,59752,60796,61828,62883,63942,
65006,66058,67132,68211,69277,70366,71460,72541,73644,74753,
75849,76968,78091,79220,80335,81474,82617,83747,84900,86059,
87204,88372,89545,90704,91887,93075,94250,95448,96650,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
}
x600045_g_ExpPrize[2] =
{
2510,2651,2789,2927,3070,3210,3351,3497,3640,3788,
7710,8050,8402,8756,9112,9461,9822,10184,10549,10906,
18165,18763,19364,19953,20560,21172,21786,22389,23010,23635,
35387,36307,37217,38147,39082,40007,40952,41902,42841,43801,
44766,45719,46694,47674,48659,49632,50627,51627,52615,53624,
54639,55641,56666,57695,58713,59752,60796,61828,62883,63942,
65006,66058,67132,68211,69277,70366,71460,72541,73644,74753,
75849,76968,78091,79220,80335,81474,82617,83747,84900,86059,
87204,88372,89545,90704,91887,93075,94250,95448,96650,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
}
x600045_g_ExpPrize[3] =
{
2510,2651,2789,2927,3070,3210,3351,3497,3640,3788,
7710,8050,8402,8756,9112,9461,9822,10184,10549,10906,
18165,18763,19364,19953,20560,21172,21786,22389,23010,23635,
35387,36307,37217,38147,39082,40007,40952,41902,42841,43801,
44766,45719,46694,47674,48659,49632,50627,51627,52615,53624,
54639,55641,56666,57695,58713,59752,60796,61828,62883,63942,
65006,66058,67132,68211,69277,70366,71460,72541,73644,74753,
75849,76968,78091,79220,80335,81474,82617,83747,84900,86059,
87204,88372,89545,90704,91887,93075,94250,95448,96650,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
}

x600045_g_ExpPrize[4] =
{
2510,2651,2789,2927,3070,3210,3351,3497,3640,3788,
7710,8050,8402,8756,9112,9461,9822,10184,10549,10906,
18165,18763,19364,19953,20560,21172,21786,22389,23010,23635,
35387,36307,37217,38147,39082,40007,40952,41902,42841,43801,
44766,45719,46694,47674,48659,49632,50627,51627,52615,53624,
54639,55641,56666,57695,58713,59752,60796,61828,62883,63942,
65006,66058,67132,68211,69277,70366,71460,72541,73644,74753,
75849,76968,78091,79220,80335,81474,82617,83747,84900,86059,
87204,88372,89545,90704,91887,93075,94250,95448,96650,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
}
x600045_g_ExpPrize[5] =
{
2510,2651,2789,2927,3070,3210,3351,3497,3640,3788,
7710,8050,8402,8756,9112,9461,9822,10184,10549,10906,
18165,18763,19364,19953,20560,21172,21786,22389,23010,23635,
35387,36307,37217,38147,39082,40007,40952,41902,42841,43801,
44766,45719,46694,47674,48659,49632,50627,51627,52615,53624,
54639,55641,56666,57695,58713,59752,60796,61828,62883,63942,
65006,66058,67132,68211,69277,70366,71460,72541,73644,74753,
75849,76968,78091,79220,80335,81474,82617,83747,84900,86059,
87204,88372,89545,90704,91887,93075,94250,95448,96650,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
97858,97858,97858,97858,97858,97858,97858,97858,97858,97858,
}

--**********************************
--ÈÎÎñÈë¿Úº¯Êý
--**********************************
function x600045_OnDefaultEvent( sceneId, selfId, targetId )
	local id = GetNumText();
	local msg = "";
	if id == 1 then
		BeginEvent(sceneId)
			msg = "#{DTGX_080822_1}";
			AddText(sceneId, msg);
		EndEvent()
		AddNumText(sceneId, x600045_g_ScriptId, "Nh§n nhi®m vø tìm hi¬u", 6, 3);
		AddNumText(sceneId, x600045_g_ScriptId, "Nh§n ph¥n thß·ng", 6, 4);
		AddNumText(sceneId, x600045_g_ScriptId, "V« nhi®m vø tìm hi¬u", 11, 2);
		DispatchEventList(sceneId,selfId,targetId);		
	elseif id == 2 then  																									--´òÌ½ÈÎÎñ°ïÖú
		BeginEvent(sceneId)
			AddText(sceneId, "#{DTGX_080822_7}");
		EndEvent()
		DispatchEventList(sceneId, selfId, targetId);
	elseif id == 3 then																										--Lînh ´òÌ½ÈÎÎñ
		-- ´ïµ½30c¤p?
		if GetLevel(sceneId, selfId) < 30 then
			x600045_MessageBox(sceneId, selfId, targetId, "Thñc xin l²i, phäi c¤p b§c ðÕt t¾i 30 m¾i có th¬ nh§n nhi®m vø.");
			return					
		end
		-- Íê³ÉÁË5´Î?
		local ymd = GetTime2Day();
		local dayCount = 0;			
		dayCount = GetMissionData(sceneId, selfId, MD_SPY_DAYCOUNT);
		if mod(dayCount, 10) >= 5 and ymd == floor(dayCount/10) then
			x600045_MessageBox(sceneId, selfId, targetId, "#{DTGX_080822_3}");
			return									
		end
		-- ÒÑÓÐÈÎÎñ?
		if IsHaveMission(sceneId, selfId, x600045_g_MissionId) > 0 then
			x600045_MessageBox(sceneId, selfId, targetId, "#{DTGX_080822_4}");
			return				
		end
		-- Ô ðÕo cø ðã ð¥y¸Âú?	
		if LuaFnGetTaskItemBagSpace(sceneId, selfId) < 1 then
			x600045_MessageBox(sceneId, selfId, targetId, "#{DTGX_080822_5}");
			return				
		end
		-- Ìí¼ÓÈÎÎñ
		local ret = AddMission( sceneId, selfId, x600045_g_MissionId, x600045_g_ScriptId, 0, 0, 0 ); --Ìí¼ÓÈÎÎñ
		if ret < 1 then
			return
		end
		-- Ìõ¼þThöa mãn,¸øÇé±¨²¾
		local ret = TryRecieveItem( sceneId, selfId, x600045_g_SpyBook_id, QUALITY_MUST_BE_CHANGE);
		if ret == -1 then
			return  -- ¸øµÀ¾ßth¤t bÕi	
		end		
		--MD_SPY_DAYCOUNT cáiÎ»±£´æmµt Ìì²ÎÓë´ÎÊý,ÆäÓàÎ»Êý±£´æÈÕÆÚ,Èç: 20080416´ú±í2008Äê4ÔÂ16ÈÕ
		local dayCount = GetMissionData(sceneId, selfId, MD_SPY_DAYCOUNT); 
		if floor(dayCount/10) ~= ymd then
			dayCount = 10 * ymd;
		end
		SetMissionData(sceneId, selfId, MD_SPY_DAYCOUNT, dayCount+1);  -- ±£´æ´ÎÊý
		-- ÈÕÖ¾
		AuditCitySpy(sceneId, selfId, 0);
		-- ¸øÐÅÏ¢
		BeginEvent(sceneId)
			AddText(sceneId, " #{DTGX_080822_6}");
		EndEvent()
		DispatchEventList(sceneId, selfId, targetId);
		
	elseif id == 4 then  								--Lînh Íê³É½±Àø
		--Lînh ÈÎÎñÁË?
		if IsHaveMission(sceneId, selfId, x600045_g_MissionId) == 0 then
			x600045_MessageBox(sceneId, selfId, targetId, "#{DTGX_080825_01}");
			return			
		end
		--ÈÎÎñÍê³É?
		local misIndex = GetMissionIndexByID(sceneId, selfId, x600045_g_MissionId);
		if misIndex > 10000 then			
			return
		end
		if GetMissionParam(sceneId, selfId, misIndex, 1) < 3 then
			x600045_MessageBox(sceneId, selfId, targetId, "#{DTGX_080822_17}");
			return
		end
		--¿Û³ýÇé±¨²¾
		local ret = LuaFnDelAvailableItem(sceneId, selfId, x600045_g_SpyBook_id, 1);
		if ret == 0 then
			msg = "Ngß½i s¨ không ðem tình báo bµ c¤p khóa  ði?";
			x600045_MessageBox(sceneId, selfId, targetId, msg);
			return		
		end		
		--¸ø2 ði¬m°ï¹±
		CityChangeAttr( sceneId, selfId, GUILD_CONTRIB_POINT, 2 )
		local dayCount = GetMissionData(sceneId, selfId, MD_SPY_DAYCOUNT);
		local level = GetLevel(sceneId, selfId);
		local idx = mod(dayCount, 10);
		--¸øKinh nghi®m½±Àø
		local expPrize = x600045_g_ExpPrize[idx][level-9]
		LuaFnAddExp(sceneId, selfId, expPrize);
		--ÉèÖÃÈÎÎñÍê³ÉÐÅÏ¢
		DelMission(sceneId, selfId, x600045_g_MissionId);
		-- ÈÕÖ¾
		AuditCitySpy(sceneId, selfId, 1);
		--Tr· v«ÐÅÏ¢
		msg = format("ÐÕt ðßþc  2 ði¬m bang c¯ng!");
		x600045_Tips(sceneId, selfId, msg);	
		local playerName = GetName(sceneId, selfId);
		msg = format("#{DTGX_080822_20}#{_INFOUSR%s}#{DTGX_080822_21}", playerName);
		BroadMsgByChatPipe(sceneId, selfId, msg, 6); --°ïÅÉÏûÏ¢
	end
end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x600045_OnEnumerate( sceneId, selfId, targetId )

	--ÅÐ¶Ï¸ÃnpcÐúng·ñÐúng¶ÔÓ¦ÈÎÎñtoÕ ðµ npc
	if LuaFnGetName( sceneId, targetId ) ~= x600045_g_Name then
		return 0;
	end
	AddNumText( sceneId, x600045_g_ScriptId, "#GTìm hi¬u nhi®m vø tin tÑc", 1, 1 );
	AddNumText( sceneId, x600045_g_ScriptId, "V« hi®m vø tìm hi¬u", 11, 2 );
end

--**********************************
--¼ì²âTiªp thøÌõ¼þ,Ò²¹©×ÓÈÎÎñµ÷ÓÃ
--**********************************
function x600045_CheckAccept( sceneId, selfId, targetId )
end
--**********************************
--¼ì²âÐúng·ñ¿ÉÒÔÌá½»
--**********************************
function x600045_CheckSubmit( sceneId, selfId, targetId )
end

--**********************************
--¼ÌÐø
--**********************************
function x600045_OnContinue( sceneId, selfId, targetId )
end

--**********************************
--Tiªp thø,½ö¹©×ÓÈÎÎñµ÷ÓÃÉèÖÃ¹«¹²²ÎÊý
--**********************************
function x600045_OnAccept( sceneId, selfId, targetId, scriptId )
end

--**********************************
--·ÅÆú,½ö¹©×ÓÈÎÎñµ÷ÓÃ
--**********************************
function x600045_OnAbandon( sceneId, selfId )
	local itemNum = LuaFnGetAvailableItemCount(sceneId, selfId, x600045_g_SpyBook_id);
	if itemNum >= 1 then
		LuaFnDelAvailableItem( sceneId, selfId, x600045_g_SpyBook_id, itemNum );
	end
  if IsHaveMission( sceneId, selfId, x600045_g_MissionId ) > 0 then
	 	DelMission( sceneId, selfId, x600045_g_MissionId )
	end	
	return 0
end

--**********************************
--Ìá½»,½ö¹©×ÓÈÎÎñµ÷ÓÃ
--**********************************
function x600045_OnSubmit( sceneId, selfId, targetId, selectRadioId )
end

--**********************************
--¿òÏÔÊ¾
--**********************************
function x600045_MessageBox( sceneId, selfId, targetId, msg )
	BeginEvent(sceneId)
		AddText(sceneId, msg);
	EndEvent()
	DispatchEventList(sceneId, selfId, targetId);
end

--**********************************
--TipÏÔÊ¾
--**********************************
function x600045_Tips(sceneId, selfId, msg)
	BeginEvent(sceneId)
		AddText(sceneId, msg);
	EndEvent()
	DispatchMissionTips(sceneId, selfId);
end
