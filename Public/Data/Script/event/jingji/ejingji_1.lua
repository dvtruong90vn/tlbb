-- 125020
-- ½øÈë¾º¼¼³¡µÄ¿ØÖÆ
-- ±¾½Å±¾ÐèÒªserverÌí¼ÓÆô¶¯²ÎÊý "-loadscriptonce" ²ÅÄÜÕý³£ÔËÐÐ

--
x125020_g_ScriptId = 125020

x125020_g_Position = {
				{id=1,scene=0,x=143,z=151},
				{id=2,scene=1,x=28, z=152},
				{id=3,scene=2,x=149,z=80},
				{id=4,scene=3,x=36, z=49},
				{id=5,scene=420,x=33, z=49},
}

-- 4¸öbuff±¦ÏäÎ»ÖÃ
x125020_g_BuffPosition = {
				{id=1,x=81, z=53, preTime=0},
				{id=2,x=81, z=146,preTime=0},
				{id=3,x=33, z=99, preTime=0},
				{id=4,x=130,z=99, preTime=0},
				{id=5,x=107,z=74, preTime=0},
				{id=6,x=106,z=124, preTime=0},
				{id=7,x=56 ,z=124, preTime=0},
				{id=8,x=56 ,z=73, preTime=0},
				
}

-- Ð¡±¦ÏäµÄÃû×ÖÁÐ±í
x125020_g_SmallBoxName = {
				"TØ S¡c Bí C¤p",
				"Hoàng S¡c Bí C¤p",
				"Løc S¡c Bí C¤p",
				"BÕch S¡c Bí C¤p",
				"H¡c S¡c Bí C¤p",
				"Lam S¡c Bí C¤p",
				"H°ng S¡c Bí C¤p",
}

-- Ð¡±¦Ïä¿ª³öÀ´µÄbuffÁÐ±í
x125020_g_SmallBoxList = {
				{id=1,monId=5004,script=125023,},
				{id=2,monId=5005,script=125023,},
				{id=3,monId=5006,script=125023,},
				{id=4,monId=5007,script=125023,},
				{id=5,monId=5008,script=125023,},
				{id=6,monId=5009,script=125023,},
				{id=7,monId=5010,script=125023,},
}

-- ËéÆ¬±¦ÏäÎ»ÖÃ
x125020_g_StonePosition_1 = {
				{tp=1,x=45,z=65},{tp=1,x=42,z=67},{tp=1,x=47,z=63},
				{tp=1,x=52,z=87},{tp=1,x=63,z=84},{tp=1,x=71,z=78},
				{tp=1,x=68,z=69},{tp=1,x=62,z=64},{tp=1,x=51,z=66},
				{tp=1,x=71,z=74},}

x125020_g_StonePosition_2 = {
				{tp=2,x=92 ,z=65},{tp=2,x=96 ,z=70},{tp=2,x=94 ,z=76},
				{tp=2,x=95 ,z=80},{tp=2,x=104,z=64},{tp=2,x=102,z=84},
				{tp=2,x=108,z=85},{tp=2,x=114,z=81},{tp=2,x=102,z=74},
				{tp=2,x=119,z=67},}
				
x125020_g_StonePosition_3 = {
				{tp=3,x=44,z=106},{tp=3,x=45,z=111},{tp=3,x=43,z=123},
				{tp=3,x=46,z=131},{tp=3,x=44,z=136},{tp=3,x=56,z=133},
				{tp=3,x=61,z=136},{tp=3,x=70,z=136},{tp=3,x=67,z=127},
				{tp=3,x=61,z=115},}

x125020_g_StonePosition_4 = {
				{tp=4,x=87, z=114},{tp=4,x=92, z=115},{tp=4,x=93, z=131},
				{tp=4,x=98, z=136},{tp=4,x=105,z=134},{tp=4,x=114,z=136},
				{tp=4,x=116,z=128},{tp=4,x=120,z=116},{tp=4,x=111,z=113},
				{tp=4,x=120,z=136},}
				
x125020_g_StonePosition_5 = {
				{tp=5,x=147,z=135},{tp=5,x=152,z=124},{tp=5,x=151,z=110},
				{tp=5,x=146,z=100},{tp=5,x=151,z=88},{tp=5,x=133,z=67},
				{tp=5,x=128,z=54},{tp=5,x=110,z=47},{tp=5,x=78,z=39},
				{tp=5,x=59,z=45},}


-- ÉÏÒ»´Î±¦ÏäË¢ÐÂµÄÊ±¼ä
x125020_g_PreCreateBoxTime = -10

-- ´´½¨Ç°Ò»·ÖÖÓµÄ¹«¸æÊÇ·ñÒÑ¾­·¢ËÍ
x125020_g_IsPreBroad = 0

-- 
x125020_g_Step = 0

-- ·¢ËÍ´´½¨Ç°Ò»·ÖÖÓµÄ¹«¸æµÄÊ±¼ä
x125020_g_PreBroadTime = 0

-- ´ó±¦ÏäÎ»ÖÃ
x125020_g_BigBoxPosition = {x=81,z=99}

x125020_g_OutPosition = {scene=0,x=160,z=106}

x125020_g_CampList = {}

-- Í¬Ò»ÕóÓªµÄ×î´óÈËÊý
x125020_g_SameCampMax = 10

-- ´«ËÍ±£»¤buffµÄId
x125020_g_GotoProtect  = 54

-- ÉÏÒ»´ÎË¢Ð¡±¦ÏäµÄÊ±¼ä
x125020_g_PreCreateSmallBoxTime = 0

-- ´ó±¦ÏäÐÅÏ¢
x125020_g_BigBoxInfo = {id=5003,x=82,z=100,ai=3,aif=0,script=125022}

-- Ê¯Í·Ïä×ÓÐÅÏ¢
x125020_g_StoneBoxInfo = {id=5002,ai=3,aif=0,script=125024}

-- ÒøÆ±±àºÅºÍäîÔËbuff
x125020_g_Yinpiao = 40002000
x125020_g_CaoyunMisId = 4021

x125020_g_PreCreateStoneBox = 0

function x125020_OnInitScene(sceneId, selfId)
	for i=1, 500  do
		x125020_g_CampList[i] = 0
	end
end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x125020_OnEnumerate( sceneId, selfId, targetId )	
   AddNumText( sceneId, x125020_g_ScriptId, "Tiªn vào CÕnh KÛ Trß¶ng", 9, 1 )        
   AddNumText( sceneId, x125020_g_ScriptId, "CÕnh KÛ Phong Thi«n Ðài là gì", 11, 2 )        
end

--**********************************
--ÈÎÎñÈë¿Úº¯Êý
--**********************************
function x125020_OnDefaultEvent( sceneId, selfId, targetId )
	-- ¿É½øÈëµØÍ¼µÈ¼¶£º35¼¶
	-- ¿ª·ÅÊ±¼ä£º24Ð¡Ê±¿ª·Å£¬¶ÓÎé¿ÉÒÔËæÊ±½øÈë²Î¼ÓÕ½¶·£¬Ö»ÊÇ²»Ò»¶¨ÓÐ±¦Ïä¿ÉÒÔ¿ª¡£
	-- ÒÔÏÂÉí·ÝÕß²»¿É½øÈë£º½ÓÆ±µÄäîÔËÉÌ¡¢½ÓÆ±µÄ°ï»áÉÌÈË¡¢ÆäËû´«ËÍÊÜÏÞÖÆÕß¡¢ÎäÁÖÃËÖ÷µÈ¡£
	-- ±ØÐëÔÚÒ»Ö§¶ÓÎéÖÐ²ÅÄÜ½øÈë¡£
	
	if GetNumText() == 2  then
    BeginEvent(sceneId)
      AddText(sceneId,"#BCÕnh KÛ Phong Thi«n Ðài");
      AddText(sceneId,"#{JINGJI_INFO}");
    EndEvent(sceneId)
    DispatchEventList(sceneId,selfId,targetId)
    return 0
	end

  -- 0£¬´¦ÓÚË«ÈËÆï³Ë×´Ì¬µÄÈË£¬²»ÄÜ±¨Ãû
  if LuaFnGetDRideFlag(sceneId, selfId) ~= 0  then
    BeginEvent(sceneId)
      AddText(sceneId,"#BCÕnh KÛ Trß¶ng");
      AddText(sceneId,"  Tiªn vào CÕnh KÛ Trß¶ng c¥n phäi n¢m trong 1 t± ðµi");
    EndEvent(sceneId)
    DispatchEventList(sceneId,selfId,targetId)
    return 0
  end

  -- 1,ÈËÎïµÈ¼¶¸ßÓÚ35
  if GetLevel(sceneId, selfId) < 35  then
    BeginEvent(sceneId)
      AddText(sceneId,"#BCÕnh KÛ Trß¶ng");
      AddText(sceneId,"   Vào CÕnh KÛ Trß¶ng c¥n ðÆng c¤p 35 tr· lên m¾i có th¬ tam gia, ðÆng c¤p cüa các hÕ vçn chßa ðü, sau khi ðÕt c¤p 35 hãy ðªn tìm ta");
    EndEvent(sceneId)
    DispatchEventList(sceneId,selfId,targetId)
    return 0
  end
  
  -- 2£¬×é¶Ó²ÅÄÜ½øÈë
  if LuaFnHasTeam( sceneId, selfId ) == 0  then
    BeginEvent(sceneId)
      AddText(sceneId,"#BCÕnh KÛ Trß¶ng");
      AddText(sceneId,"  Tiªn vào CÕnh KÛ Trß¶ng c¥n phäi n¢m trong 1 t± ðµi");
    EndEvent(sceneId)
    DispatchEventList(sceneId,selfId,targetId)
    return 0
	end

	-- ÅÜÉÌ×´Ì¬²»ÄÜ½ø¾º¼¼³¡
	if GetItemCount(sceneId, selfId, x125020_g_Yinpiao)>=1  then
		BeginEvent( sceneId )
			AddText( sceneId, "  Ngß½i hi®n tÕi ðang · trÕng thái d¸ch chuy¬n b¸ hÕn chª, không th¬ vào nh§p Tung S½n Phong Thi«n Ðài." )
		EndEvent( sceneId )
		DispatchEventList(sceneId,selfId,targetId)
		return
	end

	-- Íæ¼Ò´¦ÓÚäîÔË×´Ì¬²»ÄÜ½øÈë³¡¾°
	if IsHaveMission(sceneId,selfId, x125020_g_CaoyunMisId) > 0 then
		BeginEvent( sceneId )
			AddText( sceneId, "  Ngß½i hi®n tÕi ðang · trÕng thái d¸ch chuy¬n b¸ hÕn chª, không th¬ vào nh§p Tung S½n Phong Thi«n Ðài." )
		EndEvent( sceneId )
		DispatchEventList(sceneId,selfId,targetId)
		return
	end
	
	-- ¼ì²âÍê±Ï£¬´«ËÍ
	local nPos_X = 0
	local nPos_Z = 0
	for i, pos in x125020_g_Position  do
		if pos.scene == sceneId   then
			nPos_X = pos.x
			nPos_Z = pos.z
		end
	end
	local nJingjiScnenId = 414
	CallScriptFunction((400900), "TransferFunc",sceneId, selfId, nJingjiScnenId, nPos_X, nPos_Z)
	
end

--**********************************
-- Íæ¼Ò½øÈë
--**********************************
function x125020_OnScenePlayerEnter(sceneId, selfId)
	
--	-- 0£¬Èç¹ûÍæ¼ÒÃ»ÓÐ¶ÓÎé£¬ÈÃÍæ¼ÒÀë¿ª
--	if LuaFnHasTeam(sceneId, selfId) == 0  then
--		-- È¡ÏûÍæ¼ÒÉíÉÏÏÞÖÆ´«ËÍµÄÎÞµÐbuffºó²ÅÄÜ´«ËÍ
--		if LuaFnHaveImpactOfSpecificDataIndex(sceneId, selfId, x125020_g_GotoProtect) == 1   then
--			LuaFnCancelSpecificImpact(sceneId, selfId, x125020_g_GotoProtect)
--		end
--		
--		CallScriptFunction((400900), "TransferFunc",sceneId, selfId, 
--					x125020_g_OutPosition.scene, x125020_g_OutPosition.x, x125020_g_OutPosition.z)
--		return
--	end

	-- 1£¬¼ì²é³¡¾°ÄÚºÍ×Ô¼ºÕóÓªÏàÍ¬µÄÍæ¼ÒµÄÊýÁ¿
	local nTeamId = GetTeamId(sceneId, selfId)
	local nCampID = nTeamId + 500
	if x125020_GetSameCampCount(sceneId, nCampID) >= x125020_g_SameCampMax  then
		if LuaFnHaveImpactOfSpecificDataIndex(sceneId, selfId, x125020_g_GotoProtect) == 1   then
			LuaFnCancelSpecificImpact(sceneId, selfId, x125020_g_GotoProtect)
		end

		CallScriptFunction((400900), "TransferFunc",sceneId, selfId, 
					x125020_g_OutPosition.scene, x125020_g_OutPosition.x, x125020_g_OutPosition.z)
		return
	end
	
	-- ¶ÔÃ»ÓÐ¶ÓÎéµÄÍæ¼Ò£¬¸øÍæ¼ÒÁÙÊ±ÕóÓª	
	
	
	-- ¼ì²âÍæ¼Ò¿ÉÒÔÁô×ÅÕâÀï
	if LuaFnHasTeam(sceneId, selfId) == 1  then	
		SetUnitCampID(sceneId, selfId, selfId, nCampID)
		
	-- Ã»ÓÐ¶ÓÎéµÄÍæ¼Ò£¬¾Í¸øÒ»¸öËæ»ú¶ÓÎéºÅ
	else
		local tempCamp = random(449) + 50
		SetUnitCampID(sceneId, selfId, selfId, tempCamp)
	end
	
	-- end£¬ÉèÖÃËÀÍöÊÂ¼þ
	local x,z = LuaFnGetWorldPos(sceneId, selfId)
	local v = x125020_g_Position
	if x~=v[1].x or z~=v[1].z  and
		 x~=v[2].x or z~=v[2].z  and
		 x~=v[3].x or z~=v[3].z  and
		 x~=v[4].x or z~=v[4].z  and
		 x~=v[5].x or z~=v[5].z  then
			
			x = v[1].x
			z = v[1].z
	end
	
	SetPlayerDefaultReliveInfoEx( sceneId, selfId, "%100", "%100", "0", sceneId, x, z, 125020 )
end

--**********************************
-- x125020_OnRelive
--**********************************
function x125020_OnRelive(sceneId, selfId)
	-- ¸øÕâ¸öÍæ¼ÒÒ»¸öbuff BUFFÃèÊö£ºÓÚ¾ÅÁ«±£»¤Äã²»»áÊÜµ½ÒâÍâÉËº¦¡£
	LuaFnSendSpecificImpactToUnit(sceneId, selfId, selfId, 
										selfId, 8054, 100 )
end

--**********************************
-- OnTime
--**********************************
function x125020_OnSceneTimer(sceneId)
	
	-- 1,´¦Àí³¡¾°ÖÐÕóÓªÐ¡ÓÚ10µÄÈË£¬
	x125020_DealNoCampHuman(sceneId)
	
	-- 2,Ëæ»úµÄ·Ï»°
	x125020_RandomBroad(sceneId)
	
	-- 2£¬±¦ÏäË¢ÐÂ
	local nCurTime = GetHour()
	-- ±¦ÏäË¢ÐÂÌõ¼þ£¬
	-- a£¬ÐèÒªÊÇË«ÊýÕûµã£¬
	local nMinute = GetMinute()
	
	if (nCurTime==0 or nCurTime==10 or
		 nCurTime==12 or nCurTime==14 or nCurTime==16 or
		 nCurTime==18 or nCurTime==20 or nCurTime==22)   then
		 
		if (nCurTime-x125020_g_PreCreateBoxTime >= 2 or x125020_g_PreCreateBoxTime-nCurTime>=2) and
			 x125020_g_Step == 0  and 
			 nMinute >= 45 and nMinute < 50    then	
			-- ÏÈ·¢Ò»¸öÌáÊ¾¹«¸æ£¬Ò»·ÖÖÓºóÔÙË¢³ö±¦Ïä
			x125020_PreBroad(sceneId)
			x125020_g_PreBroadTime = LuaFnGetCurrentTime()
			x125020_g_IsPreBroad = 0
			x125020_g_Step = 1
		end

		if x125020_g_Step == 1 and LuaFnGetCurrentTime()-x125020_g_PreBroadTime >= 60  then
			x125020_g_PreCreateBoxTime = nCurTime
			x125020_CreateBigBox(sceneId)
			x125020_g_Step = 0
		end
	end
	
	if (nMinute==5 or nMinute==25) and x125020_g_PreCreateStoneBox ~= nMinute  then
		x125020_CreateStoneBox(sceneId)
		x125020_g_PreCreateStoneBox = nMinute
	end
	
	local nNowTime = LuaFnGetCurrentTime()
	if nNowTime-x125020_g_PreCreateSmallBoxTime >= 30  then
		x125020_CreateSmallBox(sceneId)
		x125020_g_PreCreateSmallBoxTime = nNowTime
	end

end

--**********************************
-- ´´½¨±¦ÏäÇ°Ò»·ÖÖÓµÄ¹«¸æ
--**********************************
function x125020_PreBroad(sceneId)
	local str = "#YVu CØu Liên #Phô to: Các thiên hÕ anh hùng! mµt phút ð°ng h° sau, trang mãn bäo v§t cùng kinh nghi®m bäo sß½ng ðã ðßþc ðem ð£t · Phong Thi«n Ðài! Mu¯n làm võ lâm minh chü các anh hùng, cÑ vi®c t¾i ði! Xin m¶i tìm ðªn #GLÕc Dß½ng [155,107] HÕ H¥u Nhân, Tô Châu [186,129] HÕ ToÕi Lß½ng, ÐÕi Lý [177,133] BÕch Sùng Nghîa#P, tiªn vào Phong Thi®n Ðài CÕnh KÛ Trß¶ng, tranh ðoÕt võ lâm minh chü!"
	BroadMsgByChatPipe(sceneId, 0, str, 4)
end

--**********************************
-- ÔÚ³¡¾°ÖÐ´´½¨³öÒ»¸öÐ¡±¦Ïä
--**********************************
function x125020_CreateSmallBox(sceneId)
	-- ÏÈÉ¾³ýËùÓÐµÄÐ¡Ïä×Ó
	local nCount = GetMonsterCount(sceneId)
	for i=0, nCount-1 do
		local nMonsterId = GetMonsterObjID(sceneId, i)
		local szName = GetName(sceneId, nMonsterId)
		for j=1, getn(x125020_g_SmallBoxName)  do
			if szName == x125020_g_SmallBoxName[j]  then
				LuaFnDeleteMonster(sceneId, nMonsterId)
			end
		end
	end
	
	-- ÔÙËæ»ú´´½¨8¸öÏä×Ó
	for i=1, getn(x125020_g_BuffPosition)  do
		local nRand = random(getn(x125020_g_SmallBoxList))
		local nBoxId = LuaFnCreateMonster(sceneId, x125020_g_SmallBoxList[nRand].monId,
																x125020_g_BuffPosition[i].x,
																x125020_g_BuffPosition[i].z,
																3,
																0,
																x125020_g_SmallBoxList[nRand].script)
		
		SetUnitCampID(sceneId, nBoxId, nBoxId, 0)
	end
	
end

--**********************************
-- ÔÚ³¡¾°ÖÐ´´½¨³öÒ»¸ö´ó±¦Ïä
--**********************************
function x125020_CreateBigBox(sceneId)

	-- ·¢ËÍÏµÍ³¹«¸æ(ÎÞÂÛÊÇ·ñÕâ¸öÊ±ºòÐèÒª´´½¨±¦Ïä£¬Õâ¸ö¹«¸æ¶¼ÊÇÒ»¶¨Òª·¢µÄ)
	local str = "#YVu CØu Liên #Phô to: Các thiên hÕ anh hùng! mµt phút ð°ng h° sau, trang mãn bäo v§t cùng kinh nghi®m bäo sß½ng ðã ðßþc ðem ð£t · Phong Thi«n Ðài! Mu¯n làm võ lâm minh chü các anh hùng, cÑ vi®c t¾i ði! Xin m¶i tìm ðªn #GLÕc Dß½ng [155,107] HÕ H¥u Nhân, Tô Châu [186,129] HÕ ToÕi Lß½ng, ÐÕi Lý [177,133] BÕch Sùng Nghîa#P, tiªn vào Phong Thi®n Ðài CÕnh KÛ Trß¶ng, tranh ðoÕt võ lâm minh chü!"
	BroadMsgByChatPipe(sceneId, 0, str, 4)
	
	-- ÏÈÒª¼ì²â³¡¾°ÖÐÊÇ²»ÊÇ»¹ÓÐÕâ¸ömonster Èç¹ûÓÐ£¬¾Í²»ÔÙ´´½¨
	local nCount = GetMonsterCount(sceneId)
	local bHaveBox = 0
	for i=0, nCount-1  do
		local nObjId = GetMonsterObjID(sceneId, i)
		if GetName(sceneId, nObjId) == "Bäo Sß½ng"  then
			bHaveBox = 1
		end
	end
	
	if bHaveBox == 1  then
		return
	end
	
	-- ´´½¨Ò»¸öÌØ±ðµÄ monster 
	local v = x125020_g_BigBoxInfo
	local nBoxId = LuaFnCreateMonster(sceneId, v.id, v.x, v.z, v.ai, v.aif, v.script)
	SetUnitCampID(sceneId, nBoxId, nBoxId, 0)
end

--**********************************
-- ÔÚ³¡¾°ÖÐ´´½¨³öÊ¯Í·Ïä×Ó
--**********************************
function x125020_CreateStoneBox(sceneId)

	-- ÏÈÉ¾³ýÒÔÇ°ÓÐµÄÏä×Ó
	local nCount = GetMonsterCount(sceneId)
	for i=0, nCount-1 do
		local nMonsterId = GetMonsterObjID(sceneId, i)
		local szName = GetName(sceneId, nMonsterId)
		if szName == "BÕch S¡c Bäo Sß½ng"  then
			LuaFnDeleteMonster(sceneId, nMonsterId)
		end
	end

	-- ÔÚ  x125020_g_StonePosition_1 
	local v = x125020_g_StoneBoxInfo 
	
	local nRand = random(getn(x125020_g_StonePosition_1))
	local x = x125020_g_StonePosition_1[nRand].x
	local z = x125020_g_StonePosition_1[nRand].z
	local nBoxId = LuaFnCreateMonster(sceneId, v.id, x, z, v.ai, v.aif, v.script)
	SetUnitCampID(sceneId, nBoxId, nBoxId, 0)
	
	nRand = random(getn(x125020_g_StonePosition_2))
	x = x125020_g_StonePosition_2[nRand].x
	z = x125020_g_StonePosition_2[nRand].z
	nBoxId = LuaFnCreateMonster(sceneId, v.id, x, z, v.ai, v.aif, v.script)
	SetUnitCampID(sceneId, nBoxId, nBoxId, 0)
	
	nRand = random(getn(x125020_g_StonePosition_3))
	x = x125020_g_StonePosition_3[nRand].x
	z = x125020_g_StonePosition_3[nRand].z
	nBoxId = LuaFnCreateMonster(sceneId, v.id, x, z, v.ai, v.aif, v.script)
	SetUnitCampID(sceneId, nBoxId, nBoxId, 0)
	
	nRand = random(getn(x125020_g_StonePosition_4))
	x = x125020_g_StonePosition_4[nRand].x
	z = x125020_g_StonePosition_4[nRand].z
	nBoxId = LuaFnCreateMonster(sceneId, v.id, x, z, v.ai, v.aif, v.script)
	SetUnitCampID(sceneId, nBoxId, nBoxId, 0)
	
	nRand = random(getn(x125020_g_StonePosition_5))
	x = x125020_g_StonePosition_5[nRand].x
	z = x125020_g_StonePosition_5[nRand].z
	nBoxId = LuaFnCreateMonster(sceneId, v.id, x, z, v.ai, v.aif, v.script)
	SetUnitCampID(sceneId, nBoxId, nBoxId, 0)
	--PrintNum(1)
	
end

--**********************************
-- »ñµÃ³¡¾°ÖÐÒ»¸öÕóÓªÄ¿Ç°µÄÈËÊý
--**********************************
function x125020_GetSameCampCount(sceneId, CampId)
	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
	local nCount = 0
	for i=0, nHumanCount-1  do
		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId, i)
		if CampId == GetUnitCampID(sceneId, nHumanId, nHumanId)   then
			nCount = nCount+1
		end
	end

	return nCount
end

--**********************************
-- ´¦Àí³¡¾°ÖÐÃ»ÓÐÕóÓªµÄÈË
--**********************************
function x125020_DealNoCampHuman(sceneId)
	
	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
	for i=0, nHumanCount-1  do
		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId, i)
		if GetUnitCampID(sceneId, nHumanId, nHumanId) < 500   then
			-- »ñµÃ¶ÓÎéÐÅÏ¢
			if LuaFnIsObjValid(sceneId, nHumanId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, nHumanId) == 1 then
				if LuaFnHasTeam(sceneId, nHumanId) == 1  then
					local nTeamId = GetTeamId(sceneId, nHumanId)
					local nCampId = nTeamId + 500 
					if x125020_GetSameCampCount(sceneId, nCampId) >= 10  then
						if LuaFnHaveImpactOfSpecificDataIndex(sceneId, nHumanId, x125020_g_GotoProtect) == 1   then
							LuaFnCancelSpecificImpact(sceneId, nHumanId, x125020_g_GotoProtect)
						end
			
						CallScriptFunction((400900), "TransferFunc",sceneId, nHumanId, 
									x125020_g_OutPosition.scene, x125020_g_OutPosition.x, x125020_g_OutPosition.z)
						return
					else
						SetUnitCampID(sceneId, nHumanId, nHumanId, nCampId)
					end
				end
			end
		end
	end	
	
end	

--**********************************
-- Ëæ»úº°»°
--**********************************
function x125020_RandomBroad(sceneId)
	if random(100) == 1  then
		local rand = random(3)
		local str
		if rand == 1  then
			str = "#G[Phong Thi«n Ðài] #YVu CØu Liên #Phô to: Các nhóm anh hùng! Xu¤t ra bän lînh chân th§t các ngß½i ði!"
		elseif rand == 2  then
			str = "#G[Phong Thi«n Ðài] #YVu CØu Liên #Phô to: C¯ lên! B¢ng không tín v§t s¨ b¸ ngß¶i khác ðoÕt ði m¤t!"
		elseif rand == 3  then
			str = "#G[Phong Thi«n Ðài] #YVu CØu Liên #Phô to: Chiªn ð¤u ði! Vì danh v¸! Cûng vì ph¥n thß·ng!"
		end

		CallScriptFunction((200060), "Duibai",sceneId, "", "", str)
	end
end

--**********************************
-- ÓÐÍæ¼ÒÔÚ³¡¾°ÄÚËÀÍö
--**********************************
function x125020_OnSceneHumanDie( sceneId, selfId, killerId )
	-- »ñµÃÍæ¼ÒÉíÉÏµÄ "ËéÆ¬ÊýÁ¿"£¬Í³Í³É¾³ý
	local nStoneId = 40004434
	local nStoneCount = GetItemCount(sceneId, selfId, nStoneId)
	
	if nStoneCount >= 1  then
		local ret = DelItem(sceneId, selfId, nStoneId, 1)
		
		-- ÔÚµØÉÏÉú³ÉµôÂä°ü£¬°ÑËéÆ¬·Å½øÈ¥£¬·ÀÖ¹³öÏÖË¢£¬Ö»ÓÐ³É¹¦É¾³ý£¬²Å´´½¨µôÂä
		if ret > 0   then
			local x
			local z
			x,z = GetWorldPos(sceneId, selfId)
			
			-- ¸ø¿ªÆô³É¹¦µÄÍæ¼ÒÒ»¸öµôÂä°ü
			local nBoxId = DropBoxEnterScene(	x,z,sceneId )
			AddItemToBox(sceneId,nBoxId,QUALITY_CREATE_BY_BOSS, 1, nStoneId)
		end
		
	end
	
end
