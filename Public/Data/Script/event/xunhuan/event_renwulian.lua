--Á¬»·ÈÎÎñ

--MisDescBegin
--½Å±¾ºÅ
x229022_g_scriptId = 229022

--Ç°ÌáÈÎÎñ
--g_MissionIdPre =

--Møc tiêu nhi®m vønpc[94,177]
x229022_g_Name	= "Vß½ng Phu Nhân"

--ÈÎÎñºÅ
x229022_g_MissionId = 1202

--ÈÎÎñ¹éÀà
x229022_g_MissionKind = 1

--ĞÆng c¤p nhi®m vø 
x229022_g_MissionLevel = 10000

--Ğúng·ñĞúngTinhÓ¢ÈÎÎñ
x229022_g_IfMissionElite = 0

--ÏÂÃæ¼¸ÏîĞúng¶¯Ì¬ÏÔÊ¾toÕ ğµ ÄÚÈİ,ÓÃÓÚTÕi ÈÎÎñÁĞ±íÖĞ¶¯Ì¬ÏÔÊ¾ÈÎÎñÇé¿ö**********************
--ÈÎÎñĞúng·ñÒÑ¾­Íê³É
x229022_g_IsMissionOkFail = 0		--±äÁ¿toÕ ğµ µÚ0Î»

--ÒÔÉÏĞúng¶¯Ì¬**************************************************************

--ÈÎÎñ±äÁ¿µÚmµt Î»ÓÃÀ´´æ´¢Ëæ»ú ği¬mµ½toÕ ğµ ½Å±¾ºÅ

--ÈÎÎñÎÄ±¾ÃèÊö
x229022_g_MissionName="Nhi®m vø liên hoàn"
x229022_g_MissionInfo="" --ÈÎÎñÃèÊö
x229022_g_MissionTarget = " %f"
x229022_g_ContinueInfo="Làm t¯t l¡m"		--Î´Hoàn t¤t nhi®m vøtoÕ ğµ npc¶Ô»°
x229022_g_MissionComplete=", ta biªt r°i, ngß½i làm t¯t l¡m"					--Hoàn t¤t nhi®m vønpcËµ»°toÕ ğµ »°

--ÓÃÀ´±£´æ×Ö·û´®¸ñÊ½»¯toÕ ğµ Êı¾İ
x229022_g_FormatList = {
								"Tìm ğßşc %n",
								"Ğem %i t£ng cho %n",
								"Ğem #Y %p #Wt£ng cho %n",
								"DÕy bäo %n",
								}

--Ö»ĞúngÎª¿Í»§¶ËÏÔÊ¾MissionTarget¶ø×ö, ËùÓĞtoÕ ğµ ¶¯Ì¬toÕ ğµ ×Ö·û´®¶¼Ğè×¢²áµ½¸ÃList±íÖĞ
x229022_g_StrList = {
						 "huynh ¤y ",
						 "muµi ¤y ",
						 }

--¸ñÊ½×Ö·û´®ÖĞ¶ÔÓ¦ÓÚg_StringListÖĞ×Ö·û´®toÕ ğµ Ë÷Òı, ±íÊ¾´Ó4¿ªÊ¼,ºó¶àÉÙÎ»ÊÓSetMissionByIndexEx(...)toÕ ğµ ¶àÉÙ¶ø¶¨
x229022_g_StrForePart=4

--¶¯Ì¬item±àºÅTÕi missionparam´æ´¢toÕ ğµ ÆğÊ¼Î»ÖÃ
x229022_g_ItemForePart=6

x229022_g_MissionRound	= 35		--¼ÇÂ¼Ñ­»·ÈÎÎñ±äÁ¿

x229022_g_MissionLimitTime = 1800000

x229022_g_StopWatch_Pause_Flag = 57

x229022_g_NpcIdIndicator={{key=1,npcIdIndex=5},{key=2,npcIdIndex=6},{key=3,npcIdIndex=5},{key=5,npcIdIndex=6}}


--MisDescEnd

x229022_g_SubMissionType = {wenhou=1, suoqu=2, fubenjiaoxun=3, fubenduowu=4, chongwu=5}

x229022_g_GoodBadDescTable = {
									{key=1, str="Dùng tr¸ giá thi®n ác ğ±i v§t ph¦m cüa nhi®m vø liên hoàn"},
									{key=2, str="Lßu lÕi s¯ vòng hi®n có"},
									{key=3, str="Tiªp tøcnhi®m vø liên hoàn l¥n trß¾c"},
								}


x229022_g_RenwulianPet_Index = 0
x229022_g_RenwulianItem_Index = 21
x229022_g_RenwulianItem50_Index = 21
x229022_g_RenwulianItem100_Index = 42
x229022_g_RenwulianNpc_Index = 6
x229022_g_RenwulianFunbenNpc_Index = 11

--µÈc¤p	Kinh nghi®m»ùÊıĞŞÕı
x229022_g_ExpBonusBaseTable = {
												{ playerLevel=40, baseExp=3872 },
												{ playerLevel=41, baseExp=3960 },
												{ playerLevel=42, baseExp=4048 },
												{ playerLevel=43, baseExp=4136 },
												{ playerLevel=44, baseExp=4224 },
												{ playerLevel=45, baseExp=4312 },
												{ playerLevel=46, baseExp=4400 },
												{ playerLevel=47, baseExp=4488 },
												{ playerLevel=48, baseExp=4576 },
												{ playerLevel=49, baseExp=4664 },
												{ playerLevel=50, baseExp=4752 },
												{ playerLevel=51, baseExp=4840 },
												{ playerLevel=52, baseExp=4928 },
												{ playerLevel=53, baseExp=5016 },
												{ playerLevel=54, baseExp=5104 },
												{ playerLevel=55, baseExp=5192 },
												{ playerLevel=56, baseExp=5280 },
												{ playerLevel=57, baseExp=5368 },
												{ playerLevel=58, baseExp=5456 },
												{ playerLevel=59, baseExp=5544 },
												{ playerLevel=60, baseExp=5632 },
												{ playerLevel=61, baseExp=5720 },
												{ playerLevel=62, baseExp=5808 },
												{ playerLevel=63, baseExp=5896 },
												{ playerLevel=64, baseExp=5984 },
												{ playerLevel=65, baseExp=6072 },
												{ playerLevel=66, baseExp=6160 },
												{ playerLevel=67, baseExp=6248 },
												{ playerLevel=68, baseExp=6336 },
												{ playerLevel=69, baseExp=6424 },
												{ playerLevel=70, baseExp=6512 },
												{ playerLevel=71, baseExp=6600 },
												{ playerLevel=72, baseExp=6688 },
												{ playerLevel=73, baseExp=6776 },
												{ playerLevel=74, baseExp=6864 },
												{ playerLevel=75, baseExp=6952 },
												{ playerLevel=76, baseExp=7040 },
												{ playerLevel=77, baseExp=7128 },
												{ playerLevel=78, baseExp=7216 },
												{ playerLevel=79, baseExp=7304 },
												{ playerLevel=80, baseExp=7392 },
												{ playerLevel=81, baseExp=7480 },
												{ playerLevel=82, baseExp=7568 },
												{ playerLevel=83, baseExp=7656 },
												{ playerLevel=84, baseExp=7744 },
												{ playerLevel=85, baseExp=7832 },
												{ playerLevel=86, baseExp=7920 },
												{ playerLevel=87, baseExp=8008 },
												{ playerLevel=88, baseExp=8096 },
												{ playerLevel=89, baseExp=8184 },
												{ playerLevel=90, baseExp=8272 },
												{ playerLevel=91, baseExp=8360 },
												{ playerLevel=92, baseExp=8448 },
												{ playerLevel=93, baseExp=8536 },
												{ playerLevel=94, baseExp=8624 },
												{ playerLevel=95, baseExp=8712 },
												{ playerLevel=96, baseExp=8800 },
												{ playerLevel=97, baseExp=8888 },
												{ playerLevel=98, baseExp=8976 },
												{ playerLevel=99, baseExp=9064 },
												{ playerLevel=100, baseExp=9152 },
												{ playerLevel=101, baseExp=9328 },
												{ playerLevel=102, baseExp=9152 },
												{ playerLevel=103, baseExp=9416 },
												{ playerLevel=104, baseExp=9504 },
												{ playerLevel=105, baseExp=9592 },
												{ playerLevel=106, baseExp=9680 },
												{ playerLevel=107, baseExp=9768 },
												{ playerLevel=108, baseExp=9856 },
												{ playerLevel=109, baseExp=9944 },
												{ playerLevel=110, baseExp=10032 },
												{ playerLevel=111, baseExp=10120 },
												{ playerLevel=112, baseExp=10208 },
												{ playerLevel=113, baseExp=10296 },
												{ playerLevel=114, baseExp=10384 },
												{ playerLevel=115, baseExp=10472 },
												{ playerLevel=116, baseExp=10560 },
												{ playerLevel=117, baseExp=10648 },
												{ playerLevel=118, baseExp=10736 },
												{ playerLevel=119, baseExp=10824 },
												{ playerLevel=120, baseExp=10912 },
									}


--»·Êı¼Ó³É: 
x229022_g_RoundRefixTable = {
												{ round=1,	refix=1.000 },
												{ round=2,	refix=1.051 },
												{ round=3,	refix=1.101 },
												{ round=4,	refix=1.152 },
												{ round=5,	refix=1.202 },
												{ round=6,	refix=1.253 },
												{ round=7,	refix=1.303 },
												{ round=8,	refix=1.354 },
												{ round=9,	refix=1.404 },
												{ round=10,	refix=1.455 },
												{ round=11,	refix=1.055 },
												{ round=12,	refix=1.156 },
												{ round=13,	refix=1.256 },
												{ round=14,	refix=1.357 },
												{ round=15,	refix=1.457 },
												{ round=16,	refix=1.558 },
												{ round=17,	refix=1.658 },
												{ round=18,	refix=1.759 },
												{ round=19,	refix=1.859 },
												{ round=20,	refix=1.960 },
												{ round=21,	refix=1.110 },
												{ round=22,	refix=1.261 },
												{ round=23,	refix=1.411 },
												{ round=24,	refix=1.562 },
												{ round=25,	refix=1.712 },
												{ round=26,	refix=1.863 },
												{ round=27,	refix=2.013 },
												{ round=28,	refix=2.164 },
												{ round=29,	refix=2.314 },
												{ round=30,	refix=2.465 },
												{ round=31,	refix=1.165 },
												{ round=32,	refix=1.366 },
												{ round=33,	refix=1.566 },
												{ round=34,	refix=1.767 },
												{ round=35,	refix=1.967 },
												{ round=36,	refix=2.168 },
												{ round=37,	refix=2.368 },
												{ round=38,	refix=2.569 },
												{ round=39,	refix=2.769 },
												{ round=40,	refix=2.970 },
												{ round=41,	refix=1.220 },
												{ round=42,	refix=1.471 },
												{ round=43,	refix=1.721 },
												{ round=44,	refix=1.972 },
												{ round=45,	refix=2.222 },
												{ round=46,	refix=2.473 },
												{ round=47,	refix=2.723 },
												{ round=48,	refix=2.974 },
												{ round=49,	refix=3.224 },
												{ round=50,	refix=3.475 },
												{ round=51,	refix=1.275 },
												{ round=52,	refix=1.576 },
												{ round=53,	refix=1.876 },
												{ round=54,	refix=2.177 },
												{ round=55,	refix=2.477 },
												{ round=56,	refix=2.778 },
												{ round=57,	refix=3.078 },
												{ round=58,	refix=3.379 },
												{ round=59,	refix=3.679 },
												{ round=60,	refix=3.980 },
												{ round=61,	refix=1.330 },
												{ round=62,	refix=1.681 },
												{ round=63,	refix=2.031 },
												{ round=64,	refix=2.382 },
												{ round=65,	refix=2.732 },
												{ round=66,	refix=3.083 },
												{ round=67,	refix=3.433 },
												{ round=68,	refix=3.784 },
												{ round=69,	refix=4.134 },
												{ round=70,	refix=4.485 },
												{ round=71,	refix=1.385 },
												{ round=72,	refix=1.786 },
												{ round=73,	refix=2.186 },
												{ round=74,	refix=2.587 },
												{ round=75,	refix=2.987 },
												{ round=76,	refix=3.388 },
												{ round=77,	refix=3.788 },
												{ round=78,	refix=4.189 },
												{ round=79,	refix=4.589 },
												{ round=80,	refix=4.990 },
												{ round=81,	refix=1.440 },
												{ round=82,	refix=1.891 },
												{ round=83,	refix=2.341 },
												{ round=84,	refix=2.792 },
												{ round=85,	refix=3.242 },
												{ round=86,	refix=3.693 },
												{ round=87,	refix=4.143 },
												{ round=88,	refix=4.594 },
												{ round=89,	refix=5.044 },
												{ round=90,	refix=5.495 },
												{ round=91,	refix=1.495 },
												{ round=92,	refix=1.996 },
												{ round=93,	refix=2.496 },
												{ round=94,	refix=2.997 },
												{ round=95,	refix=3.497 },
												{ round=96,	refix=3.998 },
												{ round=97,	refix=4.498 },
												{ round=98,	refix=4.999 },
												{ round=99,	refix=5.499 },
												{ round=100, refix=6.000 },
										}

x229022_g_HongyunRateTable = {
		{level=10,	value=400},
		{level=20,	value=332},
		{level=30,	value=332},
		{level=40,	value=284},
		{level=50,	value=249},
		{level=60,	value=220},
		{level=70,	value=200},
		{level=80,	value=180},
		{level=90,	value=166},
		{level=100, value=153},
		{level=110,	value=142},
		{level=120,	value=142},
		{level=130,	value=142},
		{level=140,	value=142},
		{level=150,	value=142},		
		}

function x229022_GetMapIndexByStringValue(stringV)
	for i, v in x229022_g_StrList do
		if v == stringV then
			return i-1
		end
	end
	local strText = format("C¥n phäi %s ğång kí StrList trong", stringV)
	PrintStr(strText)
	return 0;
end

--¸ù¾İĞÔ±ğÈ¡ ği¬mÏà¹ØĞÅÏ¢
function x229022_GetSexInfo(sex)
	local strSex = "huynh ¤y "
	if sex <= 0 then
		strSex = "muµi ¤y "
	end
	local sexIndex = x229022_GetMapIndexByStringValue(strSex)
	return strSex, sexIndex
end


function x229022_GetOneMissionNpcEx(sceneId, currentNpcId)
	local nNpcId, strNpcName, strNpcScene, nSceneId, nPosX, nPosZ, strNPCDesc
	for i=1, 100 do
		nNpcId, strNpcName, strNpcScene, nSceneId, nPosX, nPosZ, strNPCDesc = GetOneMissionNpc(x229022_g_RenwulianNpc_Index)
		if GetName(sceneId, currentNpcId ) ~= strNpcName then
			--PrintStr("nNpcId=" .. nNpcId .. " currentNpcId=" .. currentNpcId )
			break
		end
	end
	return nNpcId, strNpcName, strNpcScene, nSceneId, nPosX, nPosZ, strNPCDesc
end

--/////////////////////////////////////////////////////////////////////
function x229022_WenHou_Accept(sceneId, selfId, targetId)

	local nNpcId, strNpcName, strNpcScene, nSceneId, nPosX, nPosZ, strNPCDesc = x229022_GetOneMissionNpcEx(sceneId, targetId)

	--¼ÓÈëÈÎÎñµ½Íæ¼ÒÁĞ±í
	local bCanAdd = AddMission( sceneId,selfId, x229022_g_MissionId, x229022_g_scriptId, 0, 0, 0 )
	if bCanAdd < 1 then
		AddText( sceneId, "#{WFRN_090213_01}" ) --hzp 2009-2-13
		return
	end
	
	--hzp 2009-2-13 begin<<
	local PlayerName=GetName(sceneId,selfId)
	local PlayerSex=GetSex(sceneId,selfId)
	if PlayerSex == 0 then
		PlayerSex = " cô nß½ng "
	else
		PlayerSex = " các hÕ "
	end
	AddText(sceneId," " .. PlayerName .. PlayerSex .. ", nhi®m vø liên hoàn..")
	-->>end
	
	SetMissionEvent(sceneId, selfId, x229022_g_MissionId, 4)
	Msg2Player( sceneId, selfId,"#YNh§n nhi®m vø#W: Nhi®m vø liên hoàn", MSG2PLAYER_PARA )
	CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, nSceneId, nPosX, nPosZ, strNpcName)

	-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)

	SetMissionByIndex(sceneId, selfId, misIndex, 0, 0) --ÉèÖÃÈÎÎñĞúng·ñÍê³É(Î´Íê³É)
	SetMissionByIndex(sceneId, selfId, misIndex, 1, x229022_g_SubMissionType.wenhou)
	SetMissionByIndex(sceneId, selfId, misIndex, 2, -1) --±£´æÊ±ÖÓË÷Òı,³õÊ¼»¯Îª-1
	SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart, 0)--formet×Ö·û´®Ë÷Òı
	SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart+1, nNpcId)

	--ÕÒÈË: 
	local missionInfo = {
			"Lâu l¡m không g£p %s %s ( %d, %d) nh¾ quá, có th¬ giúp ta chuy¬n l¶i v¤n an t¾i ngß¶i ğó",
			" %s %s ( %d, %d) Di®c Tång có ân v¾i ta, nªu có th¬ thay ta thåm höi, ta xin nh§n t¤m th¸nh tình này,",
			"Ta và %s %s ( %d, %d) giao hæu thâm sâu, nhi«u nåm không g£p r¤t nhung nh¾, phi«n ngß½i chuy¬n l¶i thåm cüa ta",
	}

	local strMissionTarget = format(missionInfo[random(getn(missionInfo))], strNpcScene, strNpcName, nPosX, nPosZ)
	AddText(sceneId, strMissionTarget)

	x229022_OnAccept_Necessary( sceneId, selfId, targetId )
end
--/////////////////////////////////////////////////////////////////////
function x229022_SuoQu_Accept(sceneId, selfId, targetId)

	local nNpcId, strNpcName, strNpcScene, nSceneId, nPosX, nPosZ, strNPCDesc = x229022_GetOneMissionNpcEx(sceneId, targetId)

	local nItemId, strItemName, strItemDesc
	for i=1, 100 do
		nItemId, strItemName, strItemDesc = GetOneMissionItem(x229022_g_RenwulianItem_Index)
		if IsEquipItem(nItemId) > 0 then
			local reqLevel = GeEquipReqLevel(nItemId)
			local playerLevel = GetLevel(sceneId, selfId)
			--²»»áË÷È¡×°±¸ÁĞÖĞÍæ¼ÒµÈc¤p+10toÕ ğµ ×°±¸.(ÓÉÓÚÓĞÀàËÆÓÚÃÎ»ÃtoÕ ğµ ¡°´«Ëµ¡±,·ÀÖ¹Íæ¼Ò´«Ëµ³ö¸ßc¤p×°±¸¾ÍÖ÷¹Û¶ÏÈÎÎñ.)
			if playerLevel >= reqLevel and playerLevel < reqLevel+10 then
				break
			end
			if i == 100 then
				--"Í³Í³¸øÎÒÎÊºòÈ¥ ¹ş¹ş")
				x229022_WenHou_Accept(sceneId, selfId, targetId)
				return
			end	--end if
			nItemId, strItemName, strItemDesc = GetOneMissionItem(x229022_g_RenwulianItem_Index)
		else
			break
		end --end if
	end --end for

	--¼ÓÈëÈÎÎñµ½Íæ¼ÒÁĞ±í
	local bCanAdd = AddMission( sceneId,selfId, x229022_g_MissionId, x229022_g_scriptId, 1, 0, 1 )
	if bCanAdd < 1 then
		AddText( sceneId, "#{WFRN_090213_01}" ) --hzp 2009-2-13
		return
	end
	
	--hzp 2009-2-13 begin<<
	local PlayerName=GetName(sceneId,selfId)
	local PlayerSex=GetSex(sceneId,selfId)
	if PlayerSex == 0 then
		PlayerSex = " cô nß½ng "
	else
		PlayerSex = " các hÕ "
	end
	AddText(sceneId," " .. PlayerName .. PlayerSex .. ", nhi®m vø liên hoàn..")
	-->> end
	
	SetMissionEvent(sceneId, selfId, x229022_g_MissionId, 4)

	Msg2Player( sceneId, selfId,"#YNh§n nhi®m vø#W: nhi®m vø liên hoàn", MSG2PLAYER_PARA )
	CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, nSceneId, nPosX, nPosZ, strNpcName)

	-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)

	SetMissionByIndex(sceneId, selfId, misIndex, 0, 0) --ÉèÖÃÈÎÎñĞúng·ñÍê³É(Î´Íê³É)
	SetMissionByIndex(sceneId, selfId, misIndex, 1, x229022_g_SubMissionType.suoqu)
	SetMissionByIndex(sceneId, selfId, misIndex, 2, -1) --±£´æÊ±ÖÓË÷Òı,³õÊ¼»¯Îª-1
	SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart+2, nNpcId)
	SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart+1, nItemId)
	SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart, 1)--formet×Ö·û´®Ë÷Òı

	local missionInfo = {
				"Nghe nói %s %s ( %d, %d) c¥n phäi %s, phi«n ngß½i giao hµ",
				"M¤y ngày qua %s %s ( %d, %d) mu¯n ğÕt t¾i %s nên ğÑng ng°i không yên, nªu ngß½i có th¬ giúp, ¡t có lşi",
				"T¾i ği, hãy mang %s %s ( %d, %d) giao t¾i %s, ngß½i ğßşc h§u thß·ng",
				" %s %s ( %d, %d) nghiên cÑu bí kíp th¥n công, do thiªu %s nên khó tri¬n khai, ngß½i t¾i giúp ği",
				"B¢ng hæu ta %s %s ( %d, %d) ğang · thu th§p %s, Nªu ngß½i có th¬ tìm ğßşc 1 chiªc, bÕn ta s¨ r¤t vui m×ng",
				}

	local strMissionTarget = format(missionInfo[random(getn(missionInfo))],
																									strNpcScene, strNpcName, nPosX, nPosZ, strItemName)
	AddText(sceneId, strMissionTarget)

	local demandItemId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
	if HaveItem(sceneId, selfId, demandItemId) > 0 then
		SetMissionByIndex(sceneId, selfId, misIndex, 0, 1)
	end

	x229022_OnAccept_Necessary( sceneId, selfId, targetId )
end

--/////////////////////////////////////////////////////////////////////
function x229022_Chongwu_Accept(sceneId, selfId, targetId)
	local petId, petName, petDesc, takeLevel
	for i = 1, 100 do
		petId, petName, petDesc = GetOneMissionPet(x229022_g_RenwulianPet_Index)
		
		--if 1==1 then
		--petId, petName, petDesc = 3000, "Sài Miêu Dã Sinh", "hahaha"
		--break
		--end
		takeLevel = GetPetTakeLevel(petId)
		if takeLevel >= 10 and takeLevel <= GetLevel(sceneId, selfId) then
			break
		elseif i == 10 then
			--Í³Í³¸øÎÒÎÊºòÈ¥ ¹ş¹ş
			x229022_WenHou_Accept(sceneId, selfId, targetId)
			return
		end
	end

	local nNpcId, strNpcName, strNpcScene, nSceneId, nPosX, nPosZ, strNPCDesc = x229022_GetOneMissionNpcEx(sceneId, targetId)

	--¼ÓÈëÈÎÎñµ½Íæ¼ÒÁĞ±í
	local bCanAdd = AddMission( sceneId,selfId, x229022_g_MissionId, x229022_g_scriptId, 0, 0, 0 )
	if bCanAdd < 1 then
		AddText( sceneId, "#{WFRN_090213_01}" ) --hzp 2009-2-13
		return
	end
	
	--hzp 2009-2-13 begin<<
	local PlayerName=GetName(sceneId,selfId)
	local PlayerSex=GetSex(sceneId,selfId)
	if PlayerSex == 0 then
		PlayerSex = " cô nß½ng "
	else
		PlayerSex = " các hÕ "
	end
	AddText(sceneId," " .. PlayerName .. PlayerSex .. ", nhi®m vø liên hoàn..")
	-->> end
	
	SetMissionEvent(sceneId, selfId, x229022_g_MissionId, 3)
	SetMissionEvent(sceneId, selfId, x229022_g_MissionId, 4)
	Msg2Player( sceneId, selfId,"#YNh§n nhi®m vø#W: nhi®m vø liên hoàn", MSG2PLAYER_PARA )
	CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, nSceneId, nPosX, nPosZ, strNpcName)

	-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)

	SetMissionByIndex(sceneId, selfId, misIndex, 0, 0) --ÉèÖÃÈÎÎñĞúng·ñÍê³É(Î´Íê³É)
	SetMissionByIndex(sceneId, selfId, misIndex, 1, x229022_g_SubMissionType.chongwu)
	SetMissionByIndex(sceneId, selfId, misIndex, 2, -1) --±£´æÊ±ÖÓË÷Òı,³õÊ¼»¯Îª-1
	SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart+2, nNpcId)
	SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart+1, petId)

	SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart, 2)--formet×Ö·û´®Ë÷Òı

	local missionInfo = {
			"Nghe nói %s %s ( %d, %d) c¥n phäi %s, phi«n ngß½i giao hµ",
			"M¤y ngày qua %s %s ( %d, %d) mu¯n ğÕt t¾i %s nên ğÑng ng°i không yên, nªu ngß½i có th¬ giúp, ¡t có lşi",
			"T¾i ği, hãy mang %s %s ( %d, %d) giao t¾i %s, ngß½i ğßşc h§u thß·ng",
			" %s %s ( %d, %d) nghiên cÑu bí kíp th¥n công, do thiªu %s nên khó tri¬n khai, ngß½i t¾i giúp ği",
			"B¢ng hæu ta %s %s ( %d, %d) ğang · thu th§p %s, Nªu ngß½i có th¬ tìm ğßşc 1 chiªc, bÕn ta s¨ r¤t vui m×ng",
			}

	local strMissionTarget = format(missionInfo[random(getn(missionInfo))],
																									strNpcScene, strNpcName, nPosX, nPosZ, petName)
	AddText(sceneId, strMissionTarget)

	--¼ì²âÍæ¼ÒÉíÉÏtoÕ ğµ µÀ¾ßĞúng·ñÒÑ¾­Thöa mãnÍê³ÉÌõ¼ş
	for i=0, 6 do
		local petDataId = LuaFnGetPet_DataID(sceneId,selfId,i)
		if petDataId ~= nil and petDataId >= 0 then
		if GetPetName(petId) == GetPetName(petDataId) then
			SetMissionByIndex(sceneId,selfId,misIndex,0,1)					--°ÑÈÎÎñÍê³É±êÖ¾ÖÃÎª1
			break
		end
	end
	end

	x229022_OnAccept_Necessary( sceneId, selfId, targetId )
end
--/////////////////////////////////////////////////////////////////////

function x229022_FubenZhanDou_Accept(sceneId, selfId, targetId)

	local round = GetMissionData(sceneId,selfId,MD_RENWULIAN_HUAN)
	-->80»·,²»»áÔÙÓĞCuµc chiªn ÀàĞÍ.(ÓÉÓÚ¹ÖtoÕ ğµ µÈc¤pTÕi Íæ¼ÒµÈc¤p»ù´¡ÉÏ,»áËæ»·toÕ ğµ Ôö¶à¶øÔö¼ÓÄÑ¶È,ºó20»·²ÉÈ¡±£»¤)
	if round > 80 then
		--Í³Í³¸øÎÒÎÊºòÈ¥ ¹ş¹ş
		x229022_WenHou_Accept(sceneId, selfId, targetId)
		return
	end

	local nNpcId,strNpcName,strNpcScene,nSceneId,nPosX,nPosZ,strNPCDesc,sex=x229022_GetOneMissionNpcEx(sceneId, targetId)
	--¼ÓÈëÈÎÎñµ½Íæ¼ÒÁĞ±í
	local bCanAdd = AddMission( sceneId,selfId, x229022_g_MissionId, x229022_g_scriptId, 1, 0, 0 )
	if bCanAdd < 1 then
		AddText( sceneId, "#{WFRN_090213_01}" ) --hzp 2009-2-13
		return
	end
	
	--hzp 2009-2-13 begin<<
	local PlayerName=GetName(sceneId,selfId)
	local PlayerSex=GetSex(sceneId,selfId)
	if PlayerSex == 0 then
		PlayerSex = " cô nß½ng "
	else
		PlayerSex = " các hÕ "
	end
	AddText(sceneId," " .. PlayerName .. PlayerSex .. ", nhi®m vø liên hoàn..")
	-->> end
	
	Msg2Player( sceneId, selfId,"#YNh§n nhi®m vø#W: nhi®m vø liên hoàn", MSG2PLAYER_PARA )
	CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, nSceneId, nPosX, nPosZ, strNpcName)

	-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)
	SetMissionEvent(sceneId, selfId, x229022_g_MissionId, 4)

	SetMissionByIndex(sceneId, selfId, misIndex, 0, 0) --ÉèÖÃÈÎÎñĞúng·ñÍê³É(Î´Íê³É)
	SetMissionByIndex(sceneId, selfId, misIndex, 1, x229022_g_SubMissionType.fubenjiaoxun)
	SetMissionByIndex(sceneId, selfId, misIndex, 2, -1) --±£´æÊ±ÖÓË÷Òı,³õÊ¼»¯Îª-1
	SetMissionParamByIndexEx(sceneId, selfId, misIndex, 3, 0, 0) --ÒªÇóÉ±ËÀtoÕ ğµ monster×ÜÊı, ÏÖTÕi »¹Ã»ÓĞ¸³Öµ
	SetMissionParamByIndexEx(sceneId, selfId, misIndex, 3, 1, 0) --Ğã giªt chªt toÕ ğµ monsterÊıÁ¿

	SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart+1, nNpcId)
	--local strSex, sexIndex = x229022_GetSexInfo(sex)
	--SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart+2, sexIndex)

	SetMissionByIndex(sceneId, selfId, misIndex, x229022_g_StrForePart, 3)--formet×Ö·û´®Ë÷Òı

	local missionInfo = {
				"Nghe nói %s %s ( %d, %d) ğang làm ği«u ác, ngß½i hãy thay ta ği dÕy bäo h¡n",
				" %s %s ( %d, %d) t× trß¾c t¾i nay không có tiªng tåm lß½ng thi®n, di®t tr× cái ác ğ« cao cái thi®n là vi®c mà ğ¶i ta c¥n làm, t¾i cho ngß½i 1 bài h÷c ğây",
				"Ta nghe nói %s %s ( %d, %d) g¥n ğây lÕi phÕm m¤y án, nªu không dÕy d², h¡n s¨ không thu kiªm, nhi®m vø này giao cho ngß½i",
		}
	local strMissionTarget = format(missionInfo[random(getn(missionInfo))],
					strNpcScene,strNpcName, nPosX, nPosZ)

	AddText(sceneId, strMissionTarget)

	x229022_OnAccept_Necessary( sceneId, selfId, targetId )
end

function x229022_ExchangeMissionItemForGoodBadFn( sceneId, selfId,targetId, needPoint )
	--¸øÓèÈÎÎñÎïÆ·
	if( needPoint < 0 ) then
		return
	end
	local iDayTime = GetMissionData(sceneId,selfId,MD_RENWULIAN_EXCHANGEITEM)
	--begin modified by zhangguoxin 090208
	--local CurTime = GetHourTime()		--µ±Ç°Ê±¼ä
	--local CurDaytime = floor(CurTime/100)	--µ±Ç°Ê±¼ä(Ìì)
	local CurDaytime = GetDayTime()	--µ±Ç°Ê±¼ä(Ìì)
	--begin modified by zhangguoxin 090208
	if iDayTime == CurDaytime then
		BeginEvent(sceneId)
			AddText(sceneId, "1 ngày chï có th¬ dùng tr¸ giá thi®n ác ğ±i 1 l¥n!")
		EndEvent()
		DispatchMissionTips(sceneId, selfId)
		return
	end


	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)
	local itemId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)

	local _, strItemName, strItemDesc = GetItemInfoByItemId(itemId)
	local goodbadValue = LuaFnGetHumanGoodBadValue(sceneId, selfId)
	if goodbadValue < needPoint then
		BeginEvent(sceneId)
			AddText(sceneId, "Ği¬m thi®n ác cüa ngß½i không ğü, c¥n dçn thêm nhi«u ngß¶i m¾i t¾i")
		EndEvent()
		DispatchMissionTips(sceneId, selfId)
	else
		BeginAddItem(sceneId)
		AddItem(sceneId,itemId, 1)
		local ret = EndAddItem(sceneId,selfId)
		if ret > 0 then
			AddItemListToHuman(sceneId,selfId)
			--ÉèÖÃÈÎÎñÒÑ¾­Íê³É
			SetMissionByIndex(sceneId,selfId,misIndex,0,1)
		end

		LuaFnSetHumanGoodBadValue(sceneId, selfId, goodbadValue-needPoint)
		local str = format("Ngß½i t¯n #Y %d #Wği¬m thi®n ác, ğã ğÕt ğßşc thÑ mình mu¯n #B %s", needPoint, strItemName)
		SetMissionData(sceneId, selfId, MD_RENWULIAN_EXCHANGEITEM, CurDaytime)

		Msg2Player( sceneId, selfId,str, MSG2PLAYER_PARA )
	end


end

function x229022_ExchangeMissionItemForGoodBad( sceneId, selfId,targetId )

	--¸øÓèÈÎÎñÎïÆ·
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)
	local itemId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
	local _, strItemName, strItemDesc = GetItemInfoByItemId(itemId)

	local nNeedPoint
	if IsEquipItem(itemId) == 1 then --600+4*Lv
		nNeedPoint = 600 + 4 * GeEquipReqLevel(itemId)
	else	--600+4*ÎïÆ·µµ´ÎµÈc¤p
		nNeedPoint = 600 + 4 * 1 --ÎïÆ·µµ´ÎµÈc¤pÄ¿Ç°Ã»ÓĞ£.¡
	end

	BeginUICommand(sceneId)
		UICommand_AddInt(sceneId,x229022_g_scriptId);
		UICommand_AddInt(sceneId,targetId);
		UICommand_AddInt(sceneId,nNeedPoint)
		UICommand_AddString(sceneId,"ExchangeMissionItemForGoodBadFn");
		local str = format("Ngß½i phäi ğ±i #B %s #W, c¥n phäi tiêu hao tr¸ giá thi®n ác #Y %d #Wği¬m", strItemName, nNeedPoint)
		UICommand_AddString(sceneId,str);
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 24)

end

function x229022_CurrentRoundStorageFn( sceneId, selfId,targetId, needPoint )
	if needPoint < 0 then
		return
	end
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)
	local leaveSecond = GetMissionParam(sceneId, selfId, misIndex, 7)
	local goodbadValue = LuaFnGetHumanGoodBadValue(sceneId, selfId)

	--PrintNum(leaveSecond)
	if leaveSecond < 10*60000 then
		BeginEvent(sceneId)
			AddText(sceneId, "Ngß½i ğã vßşt 20 phút, không th¬ lßu lÕi nhi®m vø")
		EndEvent()
		DispatchMissionTips(sceneId, selfId)
	elseif goodbadValue < needPoint then
		BeginEvent(sceneId)
			AddText(sceneId, "Ği¬m thi®n ác cüa ngß½i không ğü, c¥n dçn thêm nhi«u ngß¶i m¾i t¾i")
		EndEvent()
		DispatchMissionTips(sceneId, selfId)
	else
		LuaFnSetHumanGoodBadValue(sceneId, selfId, goodbadValue-needPoint)
		local str = format("Ngß½i t¯n #Y %d #Wği¬mtr¸ giá thi®n ác, nhi®m vø liên hoàn s¯ vòng ğã lßu lÕi", needPoint)
		Msg2Player( sceneId, selfId,str, MSG2PLAYER_PARA )
		--ÉèÖÃÈÎÎñÒÑ¾­´æ´¢toÕ ğµ ±êÖ¾
		SetMissionByIndex(sceneId,selfId,misIndex,2,1)
		--Í£Ö¹ÈÎÎñÊ±ÖÓ
		StopMissionTimer(sceneId, selfId, x229022_g_MissionId)
		SetMissionData(sceneId,selfId,x229022_g_StopWatch_Pause_Flag,1)
	end

	BeginUICommand(sceneId)
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 1000)

end

function x229022_CurrentRoundStorage( sceneId, selfId,targetId )
	local nNeedPoint = 1000
	BeginUICommand(sceneId)
		UICommand_AddInt(sceneId,x229022_g_scriptId);
		UICommand_AddInt(sceneId,targetId);
		UICommand_AddInt(sceneId,nNeedPoint)
		UICommand_AddString(sceneId,"CurrentRoundStorageFn");
		local str = format("Lßu lÕi s¯ vòng c¥n phäi tiêu hao tr¸ giá thi®n ác #Y %d #Wği¬m, ngß½i xác ğ¸nh không?", nNeedPoint)
		UICommand_AddString(sceneId,str);
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 24)

end

function x229022_ContinueStoredMissionFn(sceneId, selfId, targetId,flag)
	if flag < 0 then
		return
	end
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)		-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ
	-- ği¬mµ½»·Êı
	local round = GetMissionData(sceneId,selfId,MD_RENWULIAN_HUAN)
	local str = format("Ngß½i ğã tiªp tøc nhi®m vø liên hoàn, s¯ vòng hi®n th¶i là #Y %d #Wvòng", round)
	Msg2Player( sceneId, selfId,str, MSG2PLAYER_PARA )
	--Æô¶¯ÈÎÎñÊ±ÖÓ
	StartMissionTimer(sceneId, selfId, x229022_g_MissionId)
	--ÉèÖÃÈÎÎñÒÑ¾­´æ´¢toÕ ğµ ±êÖ¾
	SetMissionByIndex(sceneId,selfId,misIndex,2,0)
	SetMissionData(sceneId,selfId,x229022_g_StopWatch_Pause_Flag,0)
	--¶ÔÊ±¼ä½øĞĞĞŞÕı
	local leaveSecond = GetMissionParam(sceneId, selfId, misIndex, 7)
	local elapseSecond = 30*60 - leaveSecond/1000
	SetMissionData(sceneId,selfId,MD_RENWULIAN_ACCPETTIME,LuaFnGetCurrentTime()-elapseSecond)

	BeginUICommand(sceneId)
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 1000)

end

function x229022_ContinueStoredMission(sceneId, selfId, targetId)

	-- ği¬mµ½»·Êı
	local round = GetMissionData(sceneId,selfId,MD_RENWULIAN_HUAN)

	BeginUICommand(sceneId)
		UICommand_AddInt(sceneId,x229022_g_scriptId);
		UICommand_AddInt(sceneId,targetId);
		UICommand_AddInt(sceneId,round)
		UICommand_AddString(sceneId,"ContinueStoredMissionFn");
		UICommand_AddString(sceneId,"Nhi®m vø liên hoàn l¥n trß¾c cüa ngß½i ğã tiªn hành t¾i thÑ #Y" .. tostring(round) .. "#Wvòng, ngß½i xác ğ¸nh tiªp tøc?");
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 24)

end

function x229022_AddMissionDirectly(sceneId, selfId,targetId)
 	BeginEvent(sceneId)
 	
 	--hzp 2009-2-13 begin<<
		--local PlayerName=GetName(sceneId,selfId)
		--local PlayerSex=GetSex(sceneId,selfId)
		--if PlayerSex == 0 then
		--	PlayerSex = " cô nß½ng "
		--else
		--	PlayerSex = " các hÕ"
		--end
		--AddText(sceneId," " .. PlayerName .. PlayerSex .. ",Á¬»·ÈÎÎñ...")
		-->> end
		
  	--testing begin
  	--if 1==1 then
	  	--	x229022_FubenZhanDou_Accept(sceneId, selfId, targetId)
  		--	EndEvent()
			--DispatchEventList(sceneId,selfId,targetId)
			--return
  	--end
  	--testing end
  	
	 	local ret = random(100)

		if ret < 5 then			--1¡¢	ÕÒNPCÎÊºò(5 %)
			x229022_WenHou_Accept(sceneId, selfId, targetId)
		elseif ret < 85 then	--2¡¢	Ë÷È.¨80 %)
			ret = random(100)
			if ret < 62 then -- 70 	Ë÷È¡ÎïÆ·(62 %)³èÎï=1-ÎïÆ·toÕ ğµ 
				x229022_SuoQu_Accept(sceneId, selfId, targetId)
			else
				x229022_Chongwu_Accept(sceneId, selfId, targetId)
			end
		else									--4¡¢	Cuµc chiªn (´«Èë¸±±¾)(35 %)
			x229022_FubenZhanDou_Accept(sceneId, selfId, targetId)
		end

	EndEvent( )
	DispatchEventList(sceneId,selfId,targetId)
end

function x229022_CostMoneyFn(sceneId, selfId, targetId,flag)
	if flag < 0 then
		return
	end
	if x229022_CheckAccept(sceneId,selfId) > 0 then
		--²ì¿´½ğÇ®Ğúng·ñ×ã¹»
		if GetMoney(sceneId, selfId)+ GetMoneyJZ( sceneId, selfId ) < GetLevel(sceneId, selfId)*1000 then ---dengxx
			BeginEvent(sceneId)
				AddText(sceneId, "Ngân lßşng cüa ngß½i hình nhß không ğü")
			EndEvent()
			DispatchEventList(sceneId,selfId,-1)
		else
			x229022_AddMissionDirectly(sceneId, selfId,targetId)
		end
	end
end
--/////////////////////////////////////////////////////////////////////
--**********************************
--ÊÂ¼şÁĞ±í
--**********************************
function x229022_UpdateEventList( sceneId, selfId,targetId )
	if IsHaveMission(sceneId,selfId,x229022_g_MissionId) > 0 then
		local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)		-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ
		local missionType = GetMissionParam(sceneId, selfId, misIndex, 1)
		if 1 == GetNumText() then
			--ÓÃÉÆ¶ñÖµ»»È¡Á¬»·ÈÎÎñÎïÆ· --ÕÅÕæê»
			x229022_ExchangeMissionItemForGoodBad( sceneId, selfId,targetId )
			return
		elseif 2 == GetNumText() then
			--´æ´¢µ±Ç°»·Êı --ÕÅÕæê»
			x229022_CurrentRoundStorage( sceneId, selfId,targetId )
			return
		elseif 3 == GetNumText() then
			x229022_ContinueStoredMission(sceneId, selfId, targetId)
			return
		end

		if missionType == x229022_g_SubMissionType.wenhou then
			if x229022_IsDemandNpc(sceneId, selfId, targetId) == 1 then
				SetMissionByIndex(sceneId, selfId, misIndex, 0, 1)
				if x229022_CheckSubmit( sceneId, selfId ) > 0 then
					--·¢ËÍÈÎÎñĞèÇótoÕ ğµ ĞÅÏ¢
					BeginEvent(sceneId)
						AddText(sceneId, x229022_g_MissionName)
						AddText(sceneId, "A! ngß½i r¯t cuµc cûng t¾i, ğúng lúc có vi®c c¥n phäi ngß½i giúp ğŞ")
					EndEvent( )
				end
				DispatchMissionContinueInfo(sceneId, selfId, targetId, x229022_g_scriptId, x229022_g_MissionId, x229022_g_scriptId)
			end
		elseif	missionType == x229022_g_SubMissionType.suoqu then
			--·¢ËÍÈÎÎñĞèÇótoÕ ğµ ĞÅÏ¢
			local itemId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
			local _, strItemName, _ = GetItemInfoByItemId(itemId)

			BeginEvent(sceneId)
				AddText(sceneId, x229022_g_MissionName)
				AddText(sceneId, "Ta phäi #B" .. strItemName .. "#W ngß½i mang t¾i cho ta chßa?")
			EndEvent( )
			local bDone = x229022_CheckSubmit( sceneId, selfId )
			DispatchMissionDemandInfo(sceneId, selfId, targetId, x229022_g_scriptId, x229022_g_MissionId, bDone,x229022_g_scriptId)
		elseif 	missionType == x229022_g_SubMissionType.chongwu then
			--·¢ËÍÈÎÎñĞèÇótoÕ ğµ ĞÅÏ¢
			local petDataId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
			local strItemName = GetPetName(petDataId)

			BeginEvent(sceneId)
				AddText(sceneId, x229022_g_MissionName)
				AddText(sceneId, "Trân thú ta c¥n #B" .. strItemName .. "#W ngß½i hi®n có không?")
			EndEvent( )
			local bDone = x229022_CheckSubmit( sceneId, selfId )
			DispatchMissionDemandInfo(sceneId, selfId, targetId, x229022_g_scriptId, x229022_g_MissionId, bDone,x229022_g_scriptId)
		elseif missionType == x229022_g_SubMissionType.fubenjiaoxun then
			--Èç¹ûÒÑ¾­Íê³ÉÁË½ÌÑµtoÕ ğµ ÈÎÎñ
			if x229022_CheckSubmit( sceneId, selfId ) > 0 then
				BeginEvent(sceneId)
					AddText(sceneId, x229022_g_MissionName)
					AddText(sceneId, "Quä nhiên võ công cao cß¶ng, ta không dám làm ği«u ác næa, nhßng ta còn có chút chuy®n c¥n phäi ngß½i giúp ğŞ")
				EndEvent( )
				DispatchMissionContinueInfo(sceneId, selfId, targetId, x229022_g_scriptId, x229022_g_MissionId, x229022_g_scriptId)
			else
				--Íæ¼ÒÈç¹û²»Ğúng¶Ó³¤,²»»á´´½¨¸±±¾
				--local teamLeaderID = GetTeamLeader(sceneId, selfId)
				--local nearmembercount = GetNearTeamCount(sceneId, selfId)
				--if teamLeaderID ~= selfId or nearmembercount < 2 then --°üÀ¨Íæ¼Ò×Ô¼ºTÕi ÄÚ
				--	BeginEvent(sceneId)
				--		AddText(sceneId, "Æ¾Äãµ¥Ç¹Æ¥Âí,Ò²ÏëÀ´ÕÒÎÒ,»¹ĞúngÕĞĞ©°ïÊÖÔÙÀ´°É.\n")
				--	EndEvent()
				--	DispatchEventList(sceneId, selfId, targetId)
				--else
					local str
					local ret = random(3)
					if ret == 1 then
						str = "Do ngß½i mu¯n dÕy bäo ta, mu¯n ğµng thü v¾i ta, hãy ğ¤u v¾i thuµc hÕ ta trß¾c, xem ngß½i lşi hÕi ra sao. \n"
					elseif ret == 2 then
						str = "Do ngß½i mu¯n dÕy bäo ta, t¾i ğây, ta cho ngß½i biªt tay. \n"
				    else
						str = "Rãnh nhï, cho ngß½i nªm mùi lşi hÕi cüa ta! cho ngß½i chªt. \n"
					end

					BeginEvent(sceneId)
						AddText(sceneId, str)
					EndEvent()
					DispatchEventList(sceneId, selfId, targetId)
					local nearmembercount = GetNearTeamCount(sceneId, selfId)
					if nearmembercount <= 0 then
						nearmembercount = 1
					end
					SetMissionParamByIndexEx(sceneId, selfId, misIndex, 3, 0, nearmembercount) --ÌáÇ°ÉèÖÃ¸ÃÈÎÎñÒªÇóÉ±ËÀtoÕ ğµ monsterÊıÁ¿
					--µ÷ÓÃ´´½¨¸±±¾Èë¿Úº¯Êı
					CallScriptFunction(229023 , "MakeCopyScene", sceneId, selfId, nearmembercount)
				--end
			end
		end

	--Ö»ÓĞTÕi Íõ·òÈËÕâ¶şµÚmµt ´Î½ÓÈÎÎñĞúng²Å½øĞĞÌõ¼şÅĞ¶Ï
 elseif GetName(sceneId, targetId) == x229022_g_Name then
 		--PrintStr(GetName(sceneId, targetId))
		--PrintStr(x229022_g_Name)
		if GetName(sceneId, targetId) == x229022_g_Name then
			local costMoney = GetLevel(sceneId, selfId)*1000
			BeginUICommand(sceneId)
				UICommand_AddInt(sceneId,x229022_g_scriptId);
				UICommand_AddInt(sceneId,targetId);
				UICommand_AddInt(sceneId,costMoney)
				UICommand_AddString(sceneId,"CostMoneyFn");
				UICommand_AddString(sceneId,"Phäi nh§n nhi®m vø này, c¥n phäi nµp 1 l¥n là #{_MONEY" .. tostring(costMoney) .. "}, Ngß½i xác nh§n chßa?"); --dengxx
			EndUICommand(sceneId)
			DispatchUICommand(sceneId,selfId, 24)
			return
		end
	else
		if x229022_CheckAccept(sceneId,selfId) > 0 then
			x229022_AddMissionDirectly(sceneId, selfId,targetId)
		end
 end
end

--**********************************
--ÊÂ¼ş½»»¥Èë¿Ú
--**********************************
function x229022_OnDefaultEvent( sceneId, selfId,targetId )
	--PrintStr("OnDefaultEvent...")
	x229022_UpdateEventList( sceneId, selfId, targetId )
end

--**********************************
--ÁĞ¾ÙÊÂ¼ş
--**********************************
function x229022_OnEnumerate( sceneId, selfId, targetId )
	--local f = openfile("D:/randomtest.txt", 'w')
	--for i=1, 10000 do
	--	write(f, tostring(random(10000)))
	--	write(f, tostring("\r\n"))
	--end
	--closefile(f)


	--ÔİÊ±ÆÁ±ÎÁ¬»·ÈÎÎñ
	--if 1==1 then
	--	return
	--end
	--Èç¹ûÍæ¼ÒÍê³É¹ıCái này ÈÎÎñ
		if IsMissionHaveDone(sceneId,selfId,x229022_g_MissionId) > 0 then
  	return
	--Thöa mãnÈÎÎñ½ÓÊÕÌõ¼ş
		elseif IsHaveMission(sceneId,selfId,x229022_g_MissionId) > 0 then
			local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)
			--Èç¹ûĞúngË÷È¡ÎïÆ·ÔòÏÔÊ¾ÓÃÉÆ¶ñÖµ¿ÉÒÔ»»È¡ÈÎÎñÎïÆ·
			if GetMissionParam(sceneId,selfId,misIndex,1) == x229022_g_SubMissionType.suoqu then
				AddNumText(sceneId, x229022_g_scriptId,x229022_g_GoodBadDescTable[1].str,1,1);
			end

			--local missionType = GetMissionParam(sceneId, selfId, misIndex, 1)
			--if missionType == x229022_g_SubMissionType.fubenjiaoxun then
			--	AddNumText(sceneId, x229022_g_scriptId,x229022_g_MissionName,2,-1);
			--end
			if GetName(sceneId,targetId) == x229022_g_Name then
				--Èç¹ûÒÑ¾­´æ´¢ÁËÁ¬»·ÈÎÎñ,ÔòÏÔÊ¾¼ÌĞø¸ÃÈÎÎñ
				if GetMissionParam(sceneId,selfId,misIndex, 2) == 1 then
					AddNumText(sceneId, x229022_g_scriptId,x229022_g_GoodBadDescTable[3].str,1,3);
				else
					AddNumText(sceneId, x229022_g_scriptId,x229022_g_GoodBadDescTable[2].str,1,2);
				end
			end
	--Thöa mãnÈÎÎñ½ÓÊÕÌõ¼ş
  elseif GetName(sceneId,targetId) == x229022_g_Name then
  		--Íæ¼ÒµÈc¤p>=60c¤p
			if GetLevel(sceneId, selfId) >= 60 then
				AddNumText(sceneId,x229022_g_scriptId, x229022_g_MissionName, 1, -1);
			end
  end
end

--**********************************
--¼ì²âTiªp thøÌõ¼ş
--**********************************
function x229022_CheckAccept( sceneId, selfId )
	--test begin
	--if 1== 1 then
	--	return 1
	--end
	--test end
	local nLevel = LuaFnGetLevel(sceneId, selfId)

	--Íæ¼Òµ±´Î½ÓÁ¬»·ÈÎÎñÊ±¼äÓëÉÏ´ÎÍê³ÉÁ¬»·ÈÎÎñÊ±¼äÖ®Ê±¼ä²î>48Ğ¡Ê±
	local iDayCount=GetMissionData(sceneId,selfId,MD_RENWULIAN_DAYCOUNT)

	-- ği¬mµ½»·Êı
	local round = GetMissionData(sceneId,selfId,MD_RENWULIAN_HUAN)
	if round < 50 then
		if (LuaFnGetCurrentTime()-iDayCount) < 15*60 then
			BeginEvent(sceneId)
				AddText(sceneId, "Khoäng cách giæa 2 l¥n nhi®m vø liên hoàn là 15 phút, xin giæ yên l£ng, không làm °n")
			EndEvent()
			DispatchEventList(sceneId,selfId,-1)
			return 0
		end
	elseif round == 100 then
		if (LuaFnGetCurrentTime()-iDayCount) < 48*60*60 then
			BeginEvent(sceneId)
				AddText(sceneId, "Khoäng cách giæa 2 l¥n nhi®m vø liên hoàn là 48 canh gi¶, xin giæ yên l£ng, không làm °n")
			EndEvent()
			DispatchEventList(sceneId,selfId,-1)
			return 0
		else
			SetMissionData(sceneId, selfId, MD_RENWULIAN_HUAN, 0)
		end
	elseif round >= 50 then
		--PrintNum(CurDaytime*96 + CurQuarterTime)
		--PrintNum(iDayTime*96 + iQuarterTime)
		--PrintNum( ((CurDaytime*96 + CurQuarterTime) - (iDayTime*96 + iQuarterTime)) )
		if (LuaFnGetCurrentTime()-iDayCount) < 24*60*60 then
			BeginEvent(sceneId)
				AddText(sceneId, "Khoäng cách giæa 2 l¥n nhi®m vø liên hoàn là 24 canh gi¶, xin giæ yên l£ng, không làm °n")
			EndEvent()
			DispatchEventList(sceneId,selfId,-1)
			return 0
		end
	end

	--Íæ¼ÒtoÕ ğµ Ğ¯´øKinh nghi®m¡ÙÍæ¼Ò¿ÉĞ¯´øKinh nghi®mÉÏÏŞ(ÄãĞ¯´øtoÕ ğµ Kinh nghi®mÒÑ´ïÉÏÏŞ,ÓÃĞ©ÔÙÀ´ÕÒÎÒ°É)
	if GetExp(sceneId, selfId)>= GetFullExp(sceneId, selfId) then
		BeginEvent(sceneId)
			AddText(sceneId, "Kinh nghi®m ngß½i mang theo ğã vßşt ngßŞng, hãy dùng b¾t r°i t¾i tìm ta")
		EndEvent()
		DispatchEventList(sceneId,selfId,-1)
		return 0
	end
	return 1;
end

--**********************************
--Tiªp thø
--**********************************
function x229022_OnAccept_Necessary( sceneId, selfId, targetId )

	-- ği¬mµ½»·Êı
	local round = GetMissionData(sceneId,selfId,MD_RENWULIAN_HUAN)
	if 0 == round and GetName(sceneId, targetId) == x229022_g_Name then
		--»¨·Ñ¼ÆËã:Ö»ÓĞµÚmµt ´Î½Ó,·ÅÆúÖØĞÂ½Ó,Ê±¼äµ½ÈÎÎñ×Ô¶¯É¾³ı²Å»áÊÕ·Ñ,Ò²¾ÍĞúng»·Êı=0Ê±
		--CostMoney(sceneId, selfId, GetLevel(sceneId, selfId)*1000)       
		LuaFnCostMoneyWithPriority(sceneId, selfId, GetLevel(sceneId, selfId)*1000)
	end

	round = round + 1
	if round > 100 then
		round = 1
	end
	--»·ÊıÔö¼Ó1

	SetMissionData(sceneId, selfId, MD_RENWULIAN_HUAN, round)
	--test code {
	--SetMissionData(sceneId, selfId, MD_RENWULIAN_HUAN, 100)
	--local round = GetMissionData(sceneId,selfId,MD_RENWULIAN_HUAN)
	-- }

	--Æô¶¯ÈÎÎñÊ±ÖÓ
	StartMissionTimer(sceneId, selfId, x229022_g_MissionId)

	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)

	SetMissionByIndex(sceneId, selfId, misIndex, 7, 30*60*1000) --ÉèÖÃÈÎÎñtoÕ ğµ ÏŞÖÆÊ±¼äÎª30 phút

	SetMissionData(sceneId, selfId, MD_RENWULIAN_ACCPETTIME, LuaFnGetCurrentTime())

end

--**********************************
--·ÅÆú
--**********************************
function x229022_OnAbandon( sceneId, selfId )
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)
	--Í£Ö¹ÈÎÎñÊ±ÖÓ
	StopMissionTimer(sceneId, selfId, x229022_g_MissionId)
	--É¾³ıÍæ¼ÒÈÎÎñÁĞ±íÖĞ¶ÔÓ¦toÕ ğµ ÈÎÎñ
 DelMission( sceneId, selfId, x229022_g_MissionId )

	--ÉèÖÃÑ­»·ÈÎÎñtoÕ ğµ Ê±¼ä
	SetMissionData(sceneId,selfId,MD_RENWULIAN_DAYCOUNT,LuaFnGetCurrentTime())
	SetMissionData(sceneId, selfId, MD_RENWULIAN_HUAN, 0)

end

--**********************************
--¼ÌĞø
--**********************************
function x229022_OnContinue( sceneId, selfId, targetId )
	BeginEvent(sceneId)

		AddText(sceneId,x229022_g_MissionName)
		local str
		local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)
		local missionType = GetMissionParam(sceneId, selfId, misIndex, 1)
		if missionType == x229022_g_SubMissionType.wenhou then
			str = "Ğa tÕ ngß½i t¾i ğßa tin, t¯t quá t¯t quá"
		elseif missionType == x229022_g_SubMissionType.suoqu
			or missionType == x229022_g_SubMissionType.chongwu then
			str = "Chà, thñc lòng cäm tÕ ngß½i, ta còn có chút chuy®n c¥n phäi ngß½i giúp ğŞ"
		elseif missionType == x229022_g_SubMissionType.fubenjiaoxun
			or missionType == x229022_g_SubMissionType.fubenduowu then
			str = "Quä nhiên võ công cao cß¶ng, ta không dám làm ği«u ác næa, nhßng ta còn có chút chuy®n c¥n phäi ngß½i giúp ğŞ"
		end

		AddText(sceneId,str)

	EndEvent( )
	DispatchMissionContinueInfo(sceneId, selfId, targetId, x229022_g_scriptId, x229022_g_MissionId,x229022_g_scriptId)
end

--**********************************
--¼ì²âĞúng·ñ¿ÉÒÔÌá½»
--**********************************
function x229022_CheckSubmit( sceneId, selfId )
 if IsHaveMission( sceneId, selfId, x229022_g_MissionId ) <= 0 then
		return 0
	end

	--TÕi ´ËÅĞ¶ÏÌá½»Ìõ¼şĞúng·ñ·ûºÏ,²¢¸øÓèÏàÓ¦½±Àø
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)
	local missionType = GetMissionParam(sceneId, selfId, misIndex, 1)

	--²ì¿´ÈÎÎñĞúng·ñÍê³É
	local bCompletion = GetMissionParam(sceneId, selfId, misIndex, 0)
	--PrintNum(bCompletion)
	if bCompletion > 0 then
		if missionType == x229022_g_SubMissionType.wenhou then
			return 1
		elseif missionType == x229022_g_SubMissionType.chongwu then
			local demandPetId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
			--¼ì²âÍæ¼ÒÉíÉÏtoÕ ğµ µÀ¾ßĞúng·ñÒÑ¾­Thöa mãnÍê³ÉÌõ¼ş
			for i=0, 6 do
				local petDataId = LuaFnGetPet_DataID(sceneId,selfId,i)
				if petDataId ~= nil and petDataId >= 0 then
					if GetPetName(demandPetId) == GetPetName(petDataId) then
					    return 2
			    	end
			    end
			end
		elseif missionType == x229022_g_SubMissionType.suoqu then
			local demandItemId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
			if HaveItem(sceneId, selfId, demandItemId) > 0 then
				if LuaFnGetAvailableItemCount(sceneId, selfId, demandItemId) >= 1 then
					if IsEquipItem(demandItemId) == 1 then
						return 2
					else
						return 1
					end
				else
					BeginEvent(sceneId)
						AddText(sceneId, "V§t ph¦m cüa các hÕ hi®n không dùng ğßşc ho£c ğã b¸ khóa.")
					EndEvent( )
					DispatchMissionTips(sceneId,selfId)
					return 0
				end
			else
				BeginEvent(sceneId)
					AddText(sceneId, "Thiªu v§t ph¦m mà nhi®m vø c¥n")
				EndEvent()
				DispatchMissionTips(sceneId, selfId)
				return 0
			end
		elseif missionType == x229022_g_SubMissionType.fubenjiaoxun then
				return 1
		end
	end
	return 0
end

--////////////////////////////////////////////////////////////////
--Ğ§ÂÊ¿ÉTÕi C++ÖĞÓÅ»¯,ÔİÊ±ÕâÑù,¿´Ğ§¹ûTÕi ¶¨
--////////////////////////////////////////////////////////////////
--function GetMissinonItemByCurrentHuan(playerLevel, round)
--	if round == 50 then
--		local itemId, itemName
--		local reqItemGrade = playerLevel / 10;
--		for i = 1, 5000 do
--			itemId, itemName = GetOneMissionBonusItem(x229022_g_RenwulianItem_Index)
--			local itemGrade = GetCommonItemGrade(itemId)
--			if itemGrade == reqItemGrade then
--				return itemId, itemName
--			end
--		end
--	elseif round == 100 then
--		local itemId, itemName
--		local reqItemGrade = (playerLevel+10) / 10;
--		for i = 1, 5000 do
--			itemId, itemName = GetOneMissionBonusItem(x229022_g_RenwulianItem_Index)
--			local itemGrade = GetCommonItemGrade(itemId)
--			if itemGrade == reqItemGrade then
--				return itemId, itemName
--			end
--		end
--	else
--		PrintStr("round=" .. round .. "·Ç·¨!")
--	end
--end

--**********************************
--ÈÎÎñ½±Àøº¯Êı
--**********************************
function x229022_MissionBonus(sceneId, selfId)
	local playerLevel = GetLevel(sceneId, selfId)
	local round = GetMissionData(sceneId,selfId,MD_RENWULIAN_HUAN)
	--µ±Íæ¼Ò50»·,¸ù¾İÍæ¼ÒµÈc¤p(Í¬µÈc¤p)Ëæ»ú¸øÓèÍæ¼ÒÎäÆ÷ÖÆ×÷±ØĞëÔ­ÁÏmµt ¼ş(¸øÓè100 %).
	if round == 50 then
		local itemId, itemName = GetRenwulianMissionBonusItemByLevel(x229022_g_RenwulianItem50_Index, playerLevel)
		BeginAddItem(sceneId)
			AddItem(sceneId,itemId, 1)
		if EndAddItem(sceneId,selfId) > 0 then
			AddItemListToHuman(sceneId,selfId)
			local szItemTransfer = GetItemTransfer(sceneId,selfId,0)
			Msg2Player(sceneId, selfId, "Ngß½i ğã ğÕt ğßşc 1 cái " .. itemName, MSG2PLAYER_PARA )
			local str = "#W#{_INFOUSR" .. LuaFnGetName(sceneId, selfId) .. "}#cffffccSau nhæng n² lñc không ng×ng, ğã hoàn thành 50 vòng nhi®m vø liên hoàn cüa#R Vß½ng Phu Nhân#cffffcc, thu ğßşc#W#{_INFOMSG" .. szItemTransfer .. "}#cffffcc ph¥n thß·ng."
			BroadMsgByChatPipe(sceneId, selfId, str, 4)
		else
			BeginEvent(sceneId)
				AddText(sceneId, "Tay näi cüa ngß½i ğã ğ¥y!")
			EndEvent()
			DispatchMissionTips(sceneId, selfId)
			return 0
		end
	--µ±Íæ¼ÒÂú100»·,¸ù¾İÍæ¼ÒµÈc¤p(Í¬µÈc¤p+10)Ëæ»ú¸øÓèÍæ¼ÒÎäÆ÷ÖÆ×÷±ØĞëÔ­ÁÏ(ÎäÆ÷[×°±¸]ÖÆ×÷Êé)mµt ¼ş(¸øÓè100 %).
	elseif round == 100 then

		local itemId, itemName, itemDesc, broadcastType = GetOneMissionBonusItem(x229022_g_RenwulianItem100_Index)
		local szItemTransfer = ""
		BeginAddItem(sceneId)
			AddItem(sceneId,itemId, 1)
			AddItem(sceneId, 30008034, 1) --½±Àømµt ¿Å½ğ¸ÕÉ°
		if EndAddItem(sceneId,selfId) > 0 then
			AddItemListToHuman(sceneId,selfId)
			
			szItemTransfer_0 = GetItemTransfer(sceneId, selfId, 0)
			szItemTransfer_1 = GetItemTransfer(sceneId, selfId, 1)
			
			Msg2Player(sceneId, selfId, "Ngß½i ğã ğÕt ğßşc 1 cái " .. itemName, MSG2PLAYER_PARA )
			Msg2Player(sceneId, selfId, "Các hÕ ğã nh§n ğßşc mµt ¿Å½ğ¸ÕÉ°", MSG2PLAYER_PARA )
			
			local targetStr = "#{_INFOMSG".. szItemTransfer_0 .."}"
			targetStr = targetStr .. "ºÍmµt ¿Å#{_INFOMSG" .. szItemTransfer_1 .. "}"
			local str = "#W#{_INFOUSR"..LuaFnGetName(sceneId, selfId) .. "}#cffffccSau nhæng n² lñc không ng×ng, ğã hoàn thành 100 vòng nhi®m vø liên hoàn cüa $R Vß½ng Phu Nhân#cffffcc, ğÕt ğßşc#W#{_INFOMSG" .. szItemTransfer .. "}#cffffcc ph¥n thß·ng."
			BroadMsgByChatPipe(sceneId, selfId, str, 4)
		else
			BeginEvent(sceneId)
				AddText(sceneId, "Tay näi cüa ngß½i ğã ğ¥y!")
			EndEvent()
			DispatchMissionTips(sceneId, selfId)
			return 0
		end
	end

	local expDelta = GetFullExp(sceneId, selfId) - GetExp(sceneId, selfId)
	if expDelta == 0 then
		Msg2Player( sceneId, selfId, "Kinh nghi®m ngß½i mang theo ğã ğ¥y, không th¬ hoàn t¤t nhi®m vø", MSG2PLAYER_PARA )
		return 1
	end
	--Kinh nghi®m½±Àø = Íæ¼Òµ±Ç°µÈc¤p½±Àø»ùÊı*»·Êı¼Ó³É
	--local A, B, C = 5, 1, 20*60
	--local D, E = 0.06, 4
	local playerLevel = GetLevel(sceneId, selfId)
	----Íæ¼Òµ±Ç°µÈc¤p½±Àø»ùÊı =(A+(Íæ¼ÒµÈc¤p-1)*B)*C £»A=5,B=1,C(Ã¿»·Æ½¾ùÊ±¼ä)=20*60(¿ÉÄÜµ÷Õû)
	--local BaseBonusValue = (A + (playerLevel-1)*B)*C
	----»·Êı¼Ó³É =D*(µ±Ç°»·Êı-1)+1+FLOOR((µ±Ç°»·Êı-1)/10)*((E-1-99*D)/9) £»D=0.06,E(100»·¼Ó³ÉÂÊ)=4(¿ÉÄÜµ÷Õû)
	--local RoundRefix = D*(round-1) + 1 + floor((round-1) / 10)*((E-1-99*D) / 9)
 local BaseBonusValue = 0
 local RoundRefix = 0

 for i, v in x229022_g_ExpBonusBaseTable do
 	if v.playerLevel == GetLevel(sceneId, selfId) then
 		BaseBonusValue = v.baseExp
 		break
 	end
 end

 for i, v in x229022_g_RoundRefixTable do
 	if v.round == round then
 		RoundRefix = v.refix
 		break
 	end
 end

	--Ôö¼ÓÍæ¼ÒKinh nghi®m
	local exp = BaseBonusValue * RoundRefix
	if exp > expDelta then
		AddExp(sceneId, selfId, expDelta)
	else
		AddExp(sceneId, selfId, exp)
	end
	--Msg2Player( sceneId, selfId, "Äã ği¬mµ½ÁË" .. tostring(exp) .. " ği¬mtoÕ ğµ Kinh nghi®m½±Àø.", MSG2PLAYER_PARA )

	return 1
end

function x229022_GetExpBonus(sceneId, selfId)

	local playerLevel = GetLevel(sceneId, selfId)
 local BaseBonusValue = 0
 local RoundRefix = 1

 for i, v in x229022_g_ExpBonusBaseTable do
 	if v.playerLevel == GetLevel(sceneId, selfId) then
 		BaseBonusValue = v.baseExp
 		break
 	end
 end
 --PrintStr("BaseBonusValue=" .. BaseBonusValue )
 local round = GetMissionData(sceneId,selfId,MD_RENWULIAN_HUAN)
 for i, v in x229022_g_RoundRefixTable do
 	if v.round == round then
 		RoundRefix = v.refix
 		break
 	end
 end
 --PrintStr("RoundRefix=" .. RoundRefix )

	return BaseBonusValue * RoundRefix
end

--*******************************************************
--Ìá½»ÈÎÎñtoÕ ğµ ¹«¹²¼ì²âº¯Êı
--*******************************************************
function x229022_MissionOnSubmit_Necessary(sceneId, selfId, targetId)
	-- ği¬mµ½»·Êı
	local round = GetMissionData(sceneId,selfId,MD_RENWULIAN_HUAN)
	if round >= 100 then
		--ÉèÖÃÑ­»·ÈÎÎñtoÕ ğµ Ê±¼ä
		SetMissionData(sceneId,selfId,MD_RENWULIAN_DAYCOUNT,LuaFnGetCurrentTime())
	end
	--¼ÇÂ¼Í³¼ÆĞÅÏ¢
	LuaFnAuditMissionChain(sceneId,selfId,round)

	Msg2Player( sceneId, selfId, "Ngß½i ğã hoàn t¤t nhi®m vø liên hoàn thÑ" .. tostring(round) .. "Vòng", MSG2PLAYER_PARA )

	--É¾³ı¸ÃÈÎÎñ
	DelMission(sceneId, selfId, x229022_g_MissionId)

	if round < 100 then
		--¼ÌĞø·¢ËÍÈÎÎñ
		if x229022_CheckAccept(sceneId,selfId) > 0 then
			x229022_AddMissionDirectly(sceneId, selfId,targetId)
		end
	end
end

--**********************************
--Ìá½»
--**********************************
function x229022_OnSubmit( sceneId, selfId, targetId, selectRadioId )
	if x229022_CheckSubmit( sceneId, selfId ) > 0 then
		local bGoon = 0
		local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)
		local missionType = GetMissionParam(sceneId, selfId, misIndex, 1)
		if missionType == x229022_g_SubMissionType.wenhou then
			bGoon = 1
		elseif missionType == x229022_g_SubMissionType.chongwu then
			--³èÎïtoÕ ğµ ·ÖÖ§²»TÕi x229022_OnSubmit,¶øĞúngTÕi x229022_OnMissionCheck.
		elseif missionType == x229022_g_SubMissionType.suoqu then
			local demandItemId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
			if 1==DelItem(sceneId, selfId, demandItemId, 1) then
				bGoon = 1
			end
		elseif missionType == x229022_g_SubMissionType.fubenjiaoxun then
			bGoon = 1
		end
		if bGoon == 1 then
			--ÈÎÎñ½±Àø¼ÆËã
			if x229022_MissionBonus(sceneId, selfId) > 0 then
				x229022_MissionOnSubmit_Necessary(sceneId, selfId, targetId)
			end
		end
	end
end

--**********************************
--TÕi ÈÎÎñÌá½»Ê±toÕ ğµ ¼ì²âº¯Êı
--**********************************
function x229022_My_MissionCheck_Necessary(sceneId, selfId, npcid, scriptId, index1, index2, index3, demandItemId)
	--PrintStr("My_MissionCheck_Necessary...demandItemId=" .. demandItemId)
	local find = CallScriptFunction( 500501, "OnMissionCheck_NecessaryEx", sceneId, selfId, index1, index2, index3, demandItemId )
	local _, strDemandItemName, _ = GetItemInfoByItemId(demandItemId)
	if find < 0 then
		BeginEvent(sceneId)
			local strText = format("Sao ngß½i vçn chßa ğem %s v« ğßşc mà ğã quay v«?", strDemandItemName)
			AddText(sceneId,strText)
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,-1)
		return
	end

	if LuaFnIsItemAvailable(sceneId, selfId, find) > 0 then
		local ret = EraseItem( sceneId, selfId, find )
		if	ret > 0 then
			--ÈÎÎñ½±Àø¼ÆËã
			if x229022_MissionBonus(sceneId, selfId) == 1 then
				x229022_MissionOnSubmit_Necessary(sceneId, selfId, npcid)
			end
		else
			BeginEvent(sceneId)
				local strText = format("Sao ngß½i vçn chßa ğem %s v« ğßşc mà ğã quay v«?", strDemandItemName)
				AddText(sceneId,strText)
			EndEvent(sceneId)
			DispatchEventList(sceneId,selfId,-1)
		end
	else
		BeginEvent(sceneId)
			AddText(sceneId, "V§t ph¦m cüa các hÕ hi®n không dùng ğßşc ho£c ğã b¸ khóa.")
		EndEvent( )
		DispatchMissionTips(sceneId,selfId)
		return
	end

end

--************************************************************
--Cái này ½Ó¿Úº¬ÒåĞúng´íÎótoÕ ğµ ,ÆäÊµĞúngx229022_OnSubmitÖ»²»¹ıĞúng²ÎÊı²»Í¬¶øÒÑ
--ÕâĞúngcáiÀúÊ·ÒÅÁôÎÊÌâ,ÏÖTÕi ÒÑ¾­ÎŞ·¨¸Ä±ä½Ó¿ÚÁË.
--************************************************************
function x229022_OnMissionCheck( sceneId, selfId, npcid, scriptId, index1, index2, index3, petindex )
	if x229022_CheckSubmit( sceneId, selfId ) > 0 then
		local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)		-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ
		local missionType = GetMissionParam(sceneId, selfId, misIndex, 1)

		local demandItemId
		if missionType == x229022_g_SubMissionType.suoqu then
			demandItemId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
			--PrintStr("demandItemId=" .. demandItemId)
			x229022_My_MissionCheck_Necessary(sceneId, selfId, npcid, scriptId, index1, index2, index3, demandItemId)
		elseif missionType == x229022_g_SubMissionType.fubenduowu then
			demandItemId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+2)
			x229022_My_MissionCheck_Necessary(sceneId, selfId, npcid, scriptId, index1, index2, index3, demandItemId)
		elseif missionType == x229022_g_SubMissionType.chongwu then
			local demandPetId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
			local petId = LuaFnGetPet_DataID(sceneId, selfId, petindex)
			if petId ~= nil and petId >= 0 then
				if GetPetName(petId) == GetPetName(demandPetId) then
					--ÈÎÎñ½±Àø¼ÆËã
					if LuaFnIsPetAvailable(sceneId, selfId, petindex) == 1 then
						if x229022_MissionBonus(sceneId, selfId) > 0 then
							LuaFnDeletePet(sceneId, selfId, petindex)
							x229022_MissionOnSubmit_Necessary(sceneId, selfId, npcid)
						end
					else
						BeginEvent(sceneId)
							AddText(sceneId, "Trân thú ngß½i giao không th¬ dùng ho£c b¸ khóa!")
						EndEvent()
						DispatchMissionTips(sceneId, selfId)
					end
				else
					BeginEvent(sceneId)
						AddText(sceneId, "Trân thú ngß½i giao không chính xác!")
					EndEvent()
					DispatchMissionTips(sceneId, selfId)
				end
			end
		end
	end
end


--**********************************
--É±ËÀ¹ÖÎï»òÍæ¼Ò
--**********************************
function x229022_OnKillObject( sceneId, selfId, objdataId ,objId)--²ÎÊıÒâË¼: ³¡¾°ºÅ¡¢Íæ¼ÒobjId¡¢¹ÖÎï±íÎ»ÖÃºÅ¡¢¹ÖÎïobjId
	--PrintStr("OnKillObject...")
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)		-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ

	local missionType = GetMissionParam(sceneId, selfId, misIndex, 1)
	if missionType == x229022_g_SubMissionType.suoqu then
		local bStored = GetMissionParam(sceneId, selfId, misIndex, 2)
		if bStored <= 0 then --¸ÃÈÎÎñ»¹Ã»ÓĞ´æ´¢
		if GetMissionParam(sceneId, selfId, misIndex, 0) == 0 then
		local nItemId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
		local playerLevel = GetLevel(sceneId, selfId)
		local targetLevel = GetLevel(sceneId, objId)
		if abs(playerLevel-targetLevel) < 6 then
				local rate = 50
			for i, v in x229022_g_HongyunRateTable do
				if playerLevel <= v.level then
					rate = (1 / v.value) * 10000
					break
				end
			end --endfor

			if random(1000) < rate then --ÁÙÊ±toÕ ğµ ËùÎ½toÕ ğµ Ğ¡¼¸ÂÊ:(
				AddMonsterDropItem(sceneId, objId, selfId, nItemId)
				end --endif4
			end	--endif3
		end	--endif1
		end
	elseif 	missionType == x229022_g_SubMissionType.fubenjiaoxun then
		-- È¡ ği¬mCái này ¹ÖÎïËÀºóÓµÓĞ·ÖÅäÈ¨toÕ ğµ ÈËÊı
		local num = GetMonsterOwnerCount(sceneId,objId)
		--PrintNum(num)
		for i=0,num-1 do
			-- È¡ ği¬mÓµÓĞ·ÖÅäÈ¨toÕ ğµ ÈËtoÕ ğµ objId
			local humanObjId = GetMonsterOwnerID(sceneId,objId,i)
			--PrintStr("humanObjId=" .. humanObjId)
			-- ¿´Cái này ÈËĞúng²»ĞúngÓĞCái này ÈÎÎñ
			if IsHaveMission(sceneId, humanObjId, x229022_g_MissionId) > 0 then
				-- ÏÈÅĞ¶ÏĞúng²»ĞúngÒÑ¾­Thöa mãnÁËÍê³É±êÖ¾
				local misIndex = GetMissionIndexByID(sceneId,humanObjId,x229022_g_MissionId)
				if GetMissionParam(sceneId, humanObjId, misIndex, 0) <=0 then
					local demandKillCount = GetMissionParamEx(sceneId, humanObjId, misIndex, 3, 0)
					--PrintStr("demandKillCount=" .. demandKillCount)
					if CallScriptFunction(229023 , "IsMonsterOfDemanded", sceneId, humanObjId, objdataId) > 0 then
						local killedCount =	GetMissionParamEx(sceneId, humanObjId, misIndex, 3, 1)
						killedCount = killedCount + 1
						SetMissionParamByIndexEx(sceneId, humanObjId, misIndex, 3, 1, killedCount)
						--PrintStr("killedCount=" .. killedCount)
						if killedCount == demandKillCount then
							--PrintStr("Succ...")
							BeginEvent(sceneId)
								SetMissionByIndex(sceneId, humanObjId, misIndex, 0, 1)
								local npcIndex = GetMissionParam(sceneId, humanObjId, misIndex, x229022_g_StrForePart+1)
								local _, npcName = GetNpcInfoByNpcId(sceneId,npcIndex)
								local str = format("Nhi®m vø dÕy bäo %s ğã hoàn thành", npcName)
								AddText(sceneId, str)
							EndEvent()
							DispatchMissionTips(sceneId, humanObjId)
						end --if
					end --if
				end --if
			end --if
		end --for
	end	--elseif

end

--**********************************
--½øÈëÇøÓòÊÂ¼ş
--**********************************
function x229022_OnEnterArea( sceneId, selfId, zoneId )
end

--**********************************
--µÀ¾ß¸Ä±ä
--**********************************
function x229022_OnItemChanged( sceneId, selfId, itemdataId )
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)		-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ

	local missionType = GetMissionParam(sceneId, selfId, misIndex, 1)
	local demandItemId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)

	if missionType == x229022_g_SubMissionType.suoqu then

		local _, strDemandItemName, _ = GetItemInfoByItemId(demandItemId)
		local _, strItemName, _ = GetItemInfoByItemId(itemdataId)

		if strItemName == strDemandItemName then
			BeginEvent(sceneId)
				strText = format("Ğã ğÕt t¾i %s", strItemName)
				AddText(sceneId,strText)
			EndEvent(sceneId)

			DispatchMissionTips(sceneId,selfId)
			ResetMissionEvent(sceneId, selfId, x229022_g_MissionId, 2)
			SetMissionByIndex(sceneId, selfId, misIndex, 0, 1)
		end
	end

end

--**********************************
--µÀ¾ßÊ¹ÓÃ
--**********************************
function x229022_OnUseItem( sceneId, selfId, targetId, eventId )
end


--**********************************
--Ğúng·ñĞúngÒªÇótoÕ ğµ npc
--**********************************
function x229022_IsDemandNpc(sceneId, selfId, objId)
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)		-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ
	local missionType = GetMissionParam(sceneId, selfId, misIndex, 1)
	local npcId
	if missionType == x229022_g_SubMissionType.wenhou or
		 missionType == x229022_g_SubMissionType.fubenjiaoxun then
		npcId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
	elseif missionType == x229022_g_SubMissionType.suoqu or
		 		 missionType == x229022_g_SubMissionType.chongwu	then
 		npcId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+2)
 	else
 		return 0
 	end
	local _, npcName, strNrpcScene, _, _, _, npcSceneId = GetNpcInfoByNpcId(sceneId,npcId)
	--PrintStr(npcName)
	if GetName(sceneId, objId) == npcName
		and npcSceneId == sceneId then
		return 1
	end
	return 0
end

--**********************************
--Ëø¶¨Ä¿±ê
--**********************************
function x229022_OnLockedTarget(sceneId, selfId, objId )
	--PrintStr("...OnLockedTarget")
	if x229022_IsDemandNpc(sceneId, selfId, objId) == 1 then
		--TAddText(sceneId, "ÄãÖÕÓÚÀ´ÁË, ÎÒÒÑ¾­µÈ´ıÄãºÃ¾ÃÁË!")
		TAddNumText(sceneId, x229022_g_scriptId,x229022_g_MissionName,2,-1,x229022_g_scriptId);

		--local bDone = x229022_CheckSubmit(sceneId, selfId)
		--DispatchMissionDemandInfo(sceneId, selfId, objId, x229022_g_scriptId, x229022_g_MissionId, bDone)
	end
end

--**********************************
--¶¨Ê±ÊÂ¼ş
--**********************************
function x229022_OnTimer(sceneId,selfId)
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)		-- ği¬mµ½ÈÎÎñTÕi 20cáiÈÎÎñÖĞtoÕ ğµ ĞòÁĞºÅ
	local leaveSecond = GetMissionParam(sceneId, selfId, misIndex, 7)
	--PrintNum(leaveSecond)

	local bStored = GetMissionParam(sceneId, selfId, misIndex, 2)
	if bStored == 1 then
		--Í£Ö¹ÈÎÎñÊ±ÖÓ
		StopMissionTimer(sceneId, selfId, x229022_g_MissionId)
		return
	end

	local currTime = LuaFnGetCurrentTime()
	local acceptTime = GetMissionData(sceneId,selfId,MD_RENWULIAN_ACCPETTIME)
	if (currTime - acceptTime) > 30*60 then
		leaveSecond = 0
	else
		leaveSecond = (30*60 - (currTime - acceptTime))*1000
	end

	--leaveSecond = leaveSecond - 1000
	SetMissionByIndex(sceneId,selfId,misIndex,7,leaveSecond)
	--PrintNum(leaveSecond)

	if leaveSecond <= 0 then
		--Í£Ö¹ÈÎÎñÊ±ÖÓ
		StopMissionTimer(sceneId, selfId, x229022_g_MissionId)
		--Èç¹ûÈÎÎñÒÑ¾­th¤t bÕi, ÔòÌáÊ¾ÈÎÎñth¤t bÕi²¢½«Æä´ÓÈÎÎñÁĞ±íÖĞÉ¾³ı
		local str = "Nhi®m vø liên hoàn th¤t bÕi, ğã xóa"
		BeginEvent(sceneId)
			AddText(sceneId, str)
		EndEvent()
		DispatchMissionTips(sceneId, selfId)
		Msg2Player(sceneId, selfId, str, MSG2PLAYER_PARA )
		DelMission( sceneId, selfId, x229022_g_MissionId )

		--ÉèÖÃÑ­»·ÈÎÎñtoÕ ğµ Ê±¼ä
		SetMissionData(sceneId,selfId,MD_RENWULIAN_DAYCOUNT,LuaFnGetCurrentTime())
		SetMissionData(sceneId, selfId, MD_RENWULIAN_HUAN, 0)

		return
	end

	if leaveSecond > 10*60000 and leaveSecond < 15*60000 then
		if mod(leaveSecond, 60000) == 0 then
			BeginEvent(sceneId)
				AddText(sceneId, "Trong 20 phút ngß½i có th¬ lßu nhi®m vø t¾i ch² #RVß½ng phu nhân#W")
			EndEvent()
			DispatchMissionTips(sceneId, selfId)
			return
		end
	end

	if leaveSecond < 60000 then
		BeginEvent(sceneId)
			AddText(sceneId, "Nhi®m vø liên hoàn s¨ ·" .. tostring(leaveSecond/1000) .. "Giây sau th¤t bÕi")
		EndEvent()
		DispatchMissionTips(sceneId, selfId)
		return
	end

end

function x229022_OnPetChanged(sceneId, selfId, petDataId)
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229022_g_MissionId)
	local demandPetDataId = GetMissionParam(sceneId, selfId, misIndex, x229022_g_StrForePart+1)
	if petDataId == nil or petDataId < 0 then
		return
	end
	if demandPetDataId == nil or demandPetDataId < 0 then
		return
	end

	if GetPetName(demandPetDataId) == GetPetName(petDataId) then
		local str = format("Các hÕ ğã b¡t ğßşc trân thú %s", GetPetName(petDataId))
		BeginEvent(sceneId)
			AddText(sceneId, str)
		EndEvent()
		DispatchMissionTips(sceneId, selfId)
		Msg2Player( sceneId, selfId, str , MSG2PLAYER_PARA )
		SetMissionByIndex(sceneId, selfId, misIndex, 0, 1)
	end

end

