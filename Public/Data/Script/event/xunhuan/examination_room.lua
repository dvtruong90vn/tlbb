-- µ¥ÈË¸±±¾

-- ¿Æ¾Ù»î¶¯,¿¼³¡
--MisDescBegin
-- ½Å±¾ºÅ
x801018_g_ScriptId = 801018

--ÈÎÎñºÅ
x801018_g_MissionId = 1220

--Møc tiêu nhi®m vønpc
x801018_g_Name = "Khäo Trß¶ng"

--ÈÎÎñ¹éÀà
x801018_g_MissionKind = 6


--ĞÆng c¤p nhi®m vø 
x801018_g_MissionLevel = 10000

--Ğúng·ñĞúngTinhÓ¢ÈÎÎñ
x801018_g_IfMissionElite = 0

--ÏÂÃæ¼¸ÏîĞúng¶¯Ì¬ÏÔÊ¾toÕ ğµ ÄÚÈİ,ÓÃÓÚTÕi ÈÎÎñÁĞ±íÖĞ¶¯Ì¬ÏÔÊ¾ÈÎÎñÇé¿ö**********************
x801018_g_IsMissionOkFail = 0							-- ÈÎÎñÍê³É±ê¼Ç

--ÒÔÉÏĞúng¶¯Ì¬**************************************************************

--ÈÎÎñ±äÁ¿µÚmµt Î»ÓÃÀ´´æ´¢Ëæ»ú ği¬mµ½toÕ ğµ ½Å±¾ºÅ
--ÈÎÎñÎÄ±¾ÃèÊö
x801018_g_TransScript = 400900
x801018_g_MissionName = "Khäo trß¶ng"
x801018_g_MissionInfo = "Ğánh bÕi t¤t cä th¸ v¸ trong Khäo trß¶ng có th¬ giành th¡ng lşi"		--ÈÎÎñÃèÊö
x801018_g_MissionTarget = "Ğánh bÕi t¤t cä th¸ v¸ trong Khäo trß¶ng có th¬ giành th¡ng lşi"	--Møc tiêu nhi®m vø
x801018_g_ContinueInfo = "    Nhi®m vø cüa các hÕ vçn chßa hoàn thành à?"						--Î´Hoàn t¤t nhi®m vøtoÕ ğµ npc¶Ô»°
x801018_g_MissionComplete = "    Làm t¯t l¡m, r¤t t¯t r¤t t¯t. "						--Hoàn t¤t nhi®m vønpcËµ»°toÕ ğµ »°
x801018_g_MissionRound = 38

--MisDescEnd

x801018_g_Pos = {{x=10,z=11},{x=31,z=13},{x=52,z=11},
								 {x=31,z=27},{x=14,z=34},{x=48,z=34},
								 {x=31,z=40},{x=14,z=49},{x=31,z=45},
								 {x=50,z=49}}

--¸±±¾Ãû³Æ
x801018_g_CopySceneName = "Khäo trß¶ng"
x801018_g_CopySceneType = FUBEN_KAOCHANG	--¸±±¾ÀàĞÍ,¶¨ÒåTÕi ScriptGlobal.luaÀïÃæ
x801018_g_CopySceneMap = "kaochang.nav"
x801018_g_LimitMembers = 1					--¿ÉÒÔ½ø¸±±¾toÕ ğµ ×îĞ¡¶ÓÎéÈËÊı
x801018_g_TickTime = 5							--»Øµ÷½Å±¾toÕ ğµ Ê±ÖÓÊ±¼ä(µ¥Î»:  giây/´Î)
x801018_g_LimitTotalHoldTime = 360	--¸±±¾¿ÉÒÔ´æ»îtoÕ ğµ Ê±¼ä(µ¥Î»: ´ÎÊı),Èç¹û´ËÊ±¼äµ½ÁË,ÔòÈÎÎñ½«»áth¤t bÕi
x801018_g_LimitTimeSuccess = 500		--¸±±¾Ê±¼äÏŞÖÆ(µ¥Î»: ´ÎÊı),Èç¹û´ËÊ±¼äµ½ÁË,ÈÎÎñÍê³É
x801018_g_CloseTick = 6							--¸±±¾¹Ø±ÕÇ°µ¹¼ÆÊ±(µ¥Î»: ´ÎÊı)
x801018_g_NoUserTime = 300					--¸±±¾ÖĞÃ»ÓĞÈËºó¿ÉÒÔ¼ÌĞø±£´ætoÕ ğµ Ê±¼ä(µ¥Î»:  giây)
x801018_g_DeadTrans = 0							--ËÀÍö×ªÒÆÄ£Ê½,0: ËÀÍöºó»¹¿ÉÒÔ¼ÌĞøTÕi ¸±±¾,1: ËÀÍöºó±»Ç¿ÖÆÒÆ³ö¸±±¾
--x801018_g_Fuben_X = 50							--½øÈë¸±±¾toÕ ğµ Î»ÖÃX
--x801018_g_Fuben_Z = 10							--½øÈë¸±±¾toÕ ğµ Î»ÖÃZ
x801018_g_Back_X = 376								--Ô´³¡¾°Î»ÖÃX
x801018_g_Back_Z = 220								--Ô´³¡¾°Î»ÖÃZ
x801018_g_NeedMonsterGroupID = 1		--Boss toÕ ğµ ×éºÅ
x801018_g_TotalNeedKillBoss = 5			--C¥n É±ËÀBossÊıÁ¿

x801018_g_TargetNPC = "Khäo Trß¶ng Hµ V®"
x801018_g_Param_sceneid = 2
x801018_g_Param_nPosRandom = 3

--**********************************
--ÈÎÎñÈë¿Úº¯Êı
--**********************************
function x801018_OnDefaultEvent( sceneId, selfId )	-- ği¬m»÷¸ÃÈÎÎñºóÖ´ĞĞ´Ë½Å±¾

--	if GetName( sceneId, targetId ) ~= x801018_g_Name then		--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
--		return
--	end
	local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)
	--Èç¹ûÒÑ½Ó´ËÈÎÎñ
	if IsHaveMission( sceneId, selfId, x801018_g_MissionId ) > 0 then
		x801018_MakeCopyScene( sceneId, selfId )
		--·¢ËÍÈÎÎñĞèÇótoÕ ğµ ĞÅÏ¢
--		BeginEvent( sceneId )
--			AddText( sceneId, x801018_g_MissionName )
--			AddText( sceneId, x801018_g_ContinueInfo )
--		EndEvent( )
--		local bDone = x801018_CheckSubmit( sceneId, selfId )
--		DispatchMissionDemandInfo( sceneId, selfId, targetId, x801018_g_ScriptId, x801018_g_MissionId, bDone )
	--Thöa mãnÈÎÎñ½ÓÊÕÌõ¼ş
	elseif x801018_CheckAccept( sceneId, selfId ) > 0 then
		x801018_OnAccept( sceneId, selfId, targetId )
	end
	
end

--**********************************
--ÁĞ¾ÙÊÂ¼ş
--**********************************
function x801018_OnEnumerate( sceneId, selfId, targetId )
--	if GetName( sceneId, targetId ) ~= x801018_g_Name then		--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
--		return
--	end
   --Èç¹ûÒÑ½Ó´ËÈÎÎñ
	if IsHaveMission( sceneId, selfId, x801018_g_MissionId ) > 0 then
		AddNumText( sceneId, x801018_g_ScriptId, x801018_g_MissionName, 4,-1 )
	end
end

--**********************************
--Tiªp thø
--**********************************
function x801018_OnAccept( sceneId, selfId, targetId )
--	if GetName( sceneId, targetId ) ~= x801018_g_Name then		--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
--		return
--	end

	--¼ÓÈëÈÎÎñµ½Íæ¼ÒÁĞ±í
	AddMission( sceneId, selfId, x801018_g_MissionId, x801018_g_ScriptId, 1, 0, 0 )	-- kill¡¢area¡¢item
	if IsHaveMission( sceneId, selfId, x801018_g_MissionId ) <= 0 then
		return
	end

	-- Ëæ»ú³öÍæ¼ÒtoÕ ğµ Âä½Å ği¬m
	local nPos  = random( getn(x801018_g_Pos) )

	local misIndex = GetMissionIndexByID(sceneId,selfId,x801018_g_MissionId)
	
	SetMissionByIndex(sceneId, selfId, misIndex, x801018_g_Param_nPosRandom, nPos)

	--ÏÔÊ¾ÄÚÈİ¸æËßÍæ¼ÒÒÑ¾­Tiªp thøÁËÈÎÎñ
	local missionInfo = "    Ğánh bÕi t¤t cä th¸ v¸ trong Khäo trß¶ng có th¬ giành th¡ng lşi."

	BeginEvent( sceneId )
		AddText( sceneId, "Các hÕ ğã nh§n nhi®m vø: " .. x801018_g_MissionName )
		AddText( sceneId, missionInfo )
	EndEvent( sceneId )
	DispatchEventList( sceneId, selfId, targetId )
	x801018_MakeCopyScene( sceneId, selfId )
end

--**********************************
--¼ì²âTiªp thøÌõ¼ş
--**********************************
function x801018_CheckAccept( sceneId, selfId )
--	local ret = CallScriptFunction( x801018_g_MilitaryScript, "CheckAccept", sceneId, selfId )
--	return ret
	--ÔõÃ´¼ì²â??
	return 1
end

--**********************************
--¼ì²âĞúng·ñ¿ÉÒÔÌá½»
--**********************************
function x801018_CheckSubmit( sceneId, selfId )
	local misIndex = GetMissionIndexByID( sceneId, selfId, x801018_g_MissionId )
	if  GetMissionParam(sceneId, selfId, misIndex, x801018_g_IsMissionOkFail) >0  then
		return 1
	end 
	return 0
end

--**********************************
--·ÅÆúÈÎÎñ
--**********************************
function x801018_OnAbandon( sceneId, selfId )
	--É¾³ıÍæ¼ÒÈÎÎñÁĞ±íÖĞ¶ÔÓ¦toÕ ğµ ÈÎÎñ
	local misIndex = GetMissionIndexByID( sceneId, selfId, x801018_g_MissionId )
	local copyscene = GetMissionParam( sceneId, selfId, misIndex, x801018_g_Param_sceneid )

--	if IsHaveMission( sceneId, selfId, x801018_g_UpMissionId ) > 0 then				--¸¸ÈÎÎñÉèÖÃ³Éth¤t bÕi
--		misIndex = GetMissionIndexByID( sceneId, selfId, x801018_g_UpMissionId )
--		SetMissionByIndex( sceneId, selfId, misIndex, x801018_g_IsMissionOkFail, 2 )
--		ResetMissionEvent( sceneId, selfId, x801018_g_UpMissionId, 4 )
--	end

	--É¾³ıÍæ¼ÒÈÎÎñÁĞ±íÖĞ¶ÔÓ¦toÕ ğµ ÈÎÎñ
	DelMission( sceneId, selfId, x801018_g_MissionId )

	if sceneId == copyscene then											--Èç¹ûTÕi ¸±±¾ÀïÉ¾³ıÈÎÎñ,ÔòÖ±½Ó´«ËÍ»Ø
		x801018_NotifyFailTips( sceneId, selfId, "Nhi®m vø th¤t bÕi!" )
	end
	--ÔõÃ´É¾³ıÈÎÎñ??
end

--**********************************
--É±ËÀ¹ÖÎï»òÍæ¼Ò
--**********************************
function x801018_OnKillObject( sceneId, selfId, objdataId ,objId )

	-- Ê¹ÓÃÈÎÎñÖĞ¼ÇÂ¼toÕ ğµ À´ÅĞ¶ÏĞúng²»ĞúngÉ±¶ÔÁËÈË
	if IsHaveMission( sceneId, selfId, x801018_g_MissionId ) == 0 then
		return
	end

	local misIndex = GetMissionIndexByID( sceneId, selfId, x801018_g_MissionId )

	--Ğúng·ñĞúngËùC¥n toÕ ğµ ¸±±¾
	local fubentype = LuaFnGetCopySceneData_Param( sceneId, 0 )
	if fubentype ~= x801018_g_CopySceneType then
		return
	end

	--¸±±¾¹Ø±Õ±êÖ¾
	local leaveFlag = LuaFnGetCopySceneData_Param( sceneId, 4 )
	if leaveFlag == 1 then														--Èç¹û¸±±¾ÒÑ¾­±»ÖÃ³É¹Ø±Õ×´Ì¬,ÔòÉ±¹ÖÎŞĞ§
		return
	end

	local monsterName = GetName(sceneId, objId)
	
	if monsterName ~= x801018_g_TargetNPC   then
		return
	end
	
	local monstercount = LuaFnGetCopySceneData_Param( sceneId, 6 )
	monstercount = monstercount - 1
	LuaFnSetCopySceneData_Param( sceneId, 6, monstercount )						--Ê£Óà¿¼³¡»¤ÎÀtoÕ ğµ ÊıÁ¿

	local strText

	if monstercount > 0 then
		strText = format( "Còn lÕi %d hµ v® tÕi khäo trß¶ng", monstercount )
		x801018_NotifyFailTips( sceneId, selfId, strText )
	else
		--ÉèÖÃÈÎÎñÍê³É±êÖ¾
		LuaFnSetCopySceneData_Param( sceneId, 4, 1 )

		SetMissionData(sceneId,selfId,MD_EXAM_FLAG,1)
		
		strText = format( "Hoàn t¤t nhi®m vø, trong vòng %d giây næa s¨ ğßa ğªn ch² ra vào", x801018_g_CloseTick * x801018_g_TickTime )
		x801018_NotifyFailTips( sceneId, selfId, strText )

--		if IsHaveMission( sceneId, selfId, x801018_g_UpMissionId ) > 0 then				--¸¸ÈÎÎñÉèÖÃĞÂ½×¶Î
--			misIndex = GetMissionIndexByID( sceneId, selfId, x801018_g_UpMissionId )
--			SetMissionByIndex( sceneId, selfId, misIndex, 2, 4 )
--		end

		--É¾³ıÍæ¼ÒÈÎÎñÁĞ±íÖĞ¶ÔÓ¦toÕ ğµ ÈÎÎñ
		DelMission( sceneId, selfId, x801018_g_MissionId )
	end
end

--**********************************
--¼ÌĞø
--**********************************
function x801018_OnContinue( sceneId, selfId, targetId )
	BeginEvent( sceneId )
		AddText( sceneId, x801018_g_MissionName )
		AddText( sceneId, x801018_g_MissionComplete )
	EndEvent( )
	DispatchMissionContinueInfo( sceneId, selfId, targetId, x801018_g_ScriptId, x801018_g_MissionId )
end

--**********************************
--Ìá½»
--**********************************
function x801018_OnSubmit( sceneId, selfId, targetId, selectRadioId )
--	if GetName( sceneId, targetId ) ~= x801018_g_Name then		--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
--		return
--	end

	if x801018_CheckSubmit( sceneId, selfId ) == 1 then
		-- É¾³ıCái này ÈÎÎñ
	  DelMission( sceneId, selfId, x801018_g_MissionId )
	end
end



--**********************************
--Íæ¼ÒÍ¬Òâ½øÈë¸±±¾
--**********************************
function x801018_AcceptEnterCopyScene( sceneId, selfId )

	if IsHaveMission( sceneId, selfId, x801018_g_MissionId ) > 0 then					--ÓĞÈÎÎñ²Å¿ÉÒÔ×ßÕâÀï
		local misIndex = GetMissionIndexByID( sceneId, selfId, x801018_g_MissionId )
		local copysceneid = GetMissionParam( sceneId, selfId, misIndex, x801018_g_Param_sceneid )
--		local teamid = GetTeamId( sceneId, selfId )

		if copysceneid >= 0 then						--½ø¹ı¸±±¾
			--½«×Ô¼º´«ËÍµ½¸±±¾³¡¾°
			if IsCanEnterCopyScene( copysceneid, GetHumanGUID( sceneId, selfId ) ) == 1 then
				local nPos = GetMissionParam(sceneId, selfId, misIndex, x801018_g_Param_nPosRandom)
		
				if nPos < 1 or nPos > 10 then
					nPos = 1
				end
				local go_Fuben_X = x801018_g_Pos[nPos].x
				local go_Fuben_Z = x801018_g_Pos[nPos].z

				NewWorld( sceneId, selfId, copysceneid, go_Fuben_X, go_Fuben_Z )
			else		-- Ö»ÒªTÕi ÀïÃæÃ»ÓĞÍê³É,¾ÍËãth¤t bÕi,C¥n ÖØ×ö
				x801018_NotifyFailTips( sceneId, selfId, "Nhi®m vø th¤t bÕi, hãy bö ği và nh§n lÕi" )
			end
			return
		end

		SetMissionByIndex( sceneId, selfId, misIndex, x801018_g_IsMissionOkFail, 0 )	--½«ÈÎÎñtoÕ ğµ µÚ0ºÅÊı¾İÉèÖÃÎª0,±íÊ¾Î´Íê³ÉtoÕ ğµ ÈÎÎñ
		SetMissionByIndex( sceneId, selfId, misIndex, x801018_g_Param_sceneid, -1 )		--½«ÈÎÎñtoÕ ğµ µÚ3ºÅÊı¾İÉèÖÃÎª-1, ÓÃÓÚ±£´æ¸±±¾toÕ ğµ ³¡¾°ºÅ
		--SetMissionByIndex( sceneId, selfId, misIndex, x801018_g_Param_teamid, teamid )	--½«ÈÎÎñtoÕ ğµ µÚ4ºÅÊı¾İ¶ÓÎéºÅ
		x801018_MakeCopyScene( sceneId, selfId )
	end

end

function x801018_MakeCopyScene( sceneId, selfId )

	local mylevel = GetLevel( sceneId, selfId )

	local leaderguid = LuaFnObjId2Guid( sceneId, selfId )
	LuaFnSetSceneLoad_Map( sceneId, x801018_g_CopySceneMap )						--µØÍ¼Ğúng±ØĞëÑ¡È¡toÕ ğµ ,¶øÇÒ±ØĞëTÕi Config/SceneInfo.iniÀïÅäÖÃºÃ
	LuaFnSetCopySceneData_TeamLeader( sceneId, leaderguid )
	LuaFnSetCopySceneData_NoUserCloseTime( sceneId, x801018_g_NoUserTime * 1000 )
	LuaFnSetCopySceneData_Timer( sceneId, x801018_g_TickTime * 1000 )
	LuaFnSetCopySceneData_Param( sceneId, 0, x801018_g_CopySceneType )				--ÉèÖÃ¸±±¾Êı¾İ,ÕâÀï½«0ºÅË÷ÒıtoÕ ğµ Êı¾İÉèÖÃÎª999,ÓÃÓÚ±íÊ¾¸±±¾ºÅ999(Êı×Ö×Ô¶¨Òå)
	LuaFnSetCopySceneData_Param( sceneId, 1, x801018_g_ScriptId )					--½«1ºÅÊı¾İÉèÖÃÎª¸±±¾³¡¾°ÊÂ¼ş½Å±¾ºÅ
	LuaFnSetCopySceneData_Param( sceneId, 2, 0 )							--ÉèÖÃ¸±±¾³¡¾°ºÅ
	LuaFnSetCopySceneData_Param( sceneId, 3, -1 )							--ÉèÖÃ½øÈë¸±±¾toÕ ğµ Ëæ»úÎ»ÖÃ
	LuaFnSetCopySceneData_Param( sceneId, 4, 0 )							--ÉèÖÃ¸±±¾¹Ø±Õ±êÖ¾, 0¿ª·Å,1¹Ø±Õ
	LuaFnSetCopySceneData_Param( sceneId, 5, 0 )							--ÉèÖÃÀë¿ªµ¹¼ÆÊ±´ÎÊı
	LuaFnSetCopySceneData_Param( sceneId, 6, x801018_g_TotalNeedKillBoss )	--C¥n É±ËÀtoÕ ğµ »¤ÎÀÊıÁ¿
	
	local x, z = LuaFnGetWorldPos( sceneId, selfId )
	LuaFnSetCopySceneData_Param( sceneId, 7, x )							--Íæ¼Ò³öÀ´Ê±ºòtoÕ ğµ Î»ÖÃ
	LuaFnSetCopySceneData_Param( sceneId, 8, z )							--Íæ¼Ò³öÀ´Ê±ºòtoÕ ğµ Î»ÖÃ
	
	local PlayerMaxLevel = GetHumanMaxLevelLimit()
	local iniLevel
	if mylevel < 10 then
		iniLevel = 10
	elseif mylevel < PlayerMaxLevel then
		iniLevel = floor( mylevel/10 ) * 10
	else
		iniLevel = PlayerMaxLevel
	end

	LuaFnSetSceneLoad_Monster( sceneId, "kaochang_monster_" .. tostring(iniLevel) .. ".ini" )
	LuaFnSetCopySceneData_Param(sceneId, CopyScene_LevelGap, mylevel - iniLevel) --c¤p±ğ²î,CopyScene_LevelGap TÕi  scene.lua ÖĞ¸³Öµ
	local bRetSceneID = LuaFnCreateCopyScene( sceneId )						--³õÊ¼»¯Íê³Éºóµ÷ÓÃ´´½¨¸±±¾º¯Êı
	
	if bRetSceneID > 0 then
		x801018_NotifyFailTips( sceneId, selfId, "D¸ch chuy¬n thành công!" )
	else
		x801018_NotifyFailTips( sceneId, selfId, "S¯ lßşng bän sao ğã ğªn gi¾i hÕn, ğ« ngh¸ lát næa thØ lÕi!" )
	end
end

--**********************************
--¸±±¾ÊÂ¼ş
--**********************************
function x801018_OnCopySceneReady( sceneId, destsceneId )

	LuaFnSetCopySceneData_Param( destsceneId, 3, sceneId )					--ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ
	local leaderguid = LuaFnGetCopySceneData_TeamLeader( destsceneId )
	local leaderObjId = LuaFnGuid2ObjId( sceneId, leaderguid )

	if leaderObjId == -1 then
		return
	end

	if LuaFnIsCanDoScriptLogic( sceneId, leaderObjId ) ~= 1 then			-- ´¦ÓÚÎŞ·¨Ö´ĞĞÂß¼­toÕ ğµ ×´Ì¬
		return
	end

	if IsHaveMission( sceneId, leaderObjId, x801018_g_MissionId ) > 0 then			--ÓĞÈÎÎñ²Å¿ÉÒÔ×ßÕâÀï
		local misIndex = GetMissionIndexByID( sceneId, leaderObjId, x801018_g_MissionId )

		--½«ÈÎÎñtoÕ ğµ µÚ2ºÅÊı¾İÉèÖÃÎª¸±±¾toÕ ğµ ³¡¾°ºÅ
		SetMissionByIndex( sceneId, leaderObjId, misIndex, x801018_g_Param_sceneid, destsceneId )
		
		--  ğÕt ğßşc½øÈë¸±±¾toÕ ğµ Î»ÖÃ
		local misIndex = GetMissionIndexByID(sceneId,leaderObjId,x801018_g_MissionId)
		local nPos = GetMissionParam(sceneId, leaderObjId, misIndex, x801018_g_Param_nPosRandom)
		
		if nPos < 1 or nPos > 10 then
			nPos = 1
		end
		local go_Fuben_X = x801018_g_Pos[nPos].x
		local go_Fuben_Z = x801018_g_Pos[nPos].z
		
		NewWorld( sceneId, leaderObjId, destsceneId, go_Fuben_X, go_Fuben_Z )

	end
end

--**********************************
--ÓĞÍæ¼Ò½øÈë¸±±¾ÊÂ¼ş
--**********************************
function x801018_OnPlayerEnter( sceneId, selfId )
--	LuaFnSetCopySceneData_Param( sceneId, 8, LuaFnGetCopySceneData_Param( sceneId, 8 ) + 1 )
	local x = LuaFnGetCopySceneData_Param( sceneId, 7 )
	local z = LuaFnGetCopySceneData_Param( sceneId, 8 )
	SetPlayerDefaultReliveInfo( sceneId, selfId, "%10", -1, "0", 2, x, z );

end

--**********************************
--ÓĞÍæ¼ÒTÕi ¸±±¾ÖĞËÀÍöÊÂ¼ş
--**********************************
function x801018_OnHumanDie( sceneId, selfId, killerId )
	local leaderguid = LuaFnGetCopySceneData_TeamLeader( sceneId )

	-- ÈÎÎñÈËËÀÍö,ÈÎÎñth¤t bÕi,ÓÎÏ·½áÊø
	if leaderguid == LuaFnGetGUID( sceneId, selfId ) then
--		x801018_OnAbandon( sceneId, selfId )
		local	oldsceneId	= LuaFnGetCopySceneData_Param( sceneId, 3 )
		x801018_BackToCity( sceneId, selfId )
	end
end

function x801018_NotifyFailTips( sceneId, selfId, Tip )
	BeginEvent( sceneId )
		AddText( sceneId, Tip )
	EndEvent( sceneId )
	DispatchMissionTips( sceneId, selfId )
end

--**********************************
-- »Ø³Ç
--**********************************
function x801018_BackToCity( sceneId, selfId )
	local oldsceneId = LuaFnGetCopySceneData_Param( sceneId, 3 )			--È¡ ği¬m¸±±¾Èë¿Ú³¡¾°ºÅ
	local x = LuaFnGetCopySceneData_Param( sceneId, 7 )
	local z = LuaFnGetCopySceneData_Param( sceneId, 8 )
	CallScriptFunction( x801018_g_TransScript, "TransferFunc", sceneId, selfId, oldsceneId, x, z )
end

--**********************************
--¸±±¾³¡¾°¶¨Ê±Æ÷ÊÂ¼ş
--**********************************
function x801018_OnCopySceneTimer( sceneId, nowTime )
local monstercount = GetMonsterCount( sceneId )
		local monsterId
		for i = 0, monstercount - 1 do
			--ÕÒµ½Boss
			monsterId		= GetMonsterObjID( sceneId, i )
--			if GetMonsterGroupID( sceneId, monsterId ) == x600042_g_BossGroupId then
--				SetCharacterName( sceneId, monsterId, BossName )
--			end
		end
		
		
	--¸±±¾Ê±ÖÓ¶ÁÈ¡¼°ÉèÖÃ
	local TickCount = LuaFnGetCopySceneData_Param( sceneId, 2 )						--È¡ ği¬mÒÑ¾­Ö´ĞĞtoÕ ğµ ¶¨Ê±´ÎÊı
	TickCount = TickCount + 1
	LuaFnSetCopySceneData_Param( sceneId, 2, TickCount )							--ÉèÖÃĞÂtoÕ ğµ ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊı

	-- ½«Monster¸ÄÃû
	if TickCount == 1 then
		local monsterId
		for i = 0, monstercount - 1 do
			monsterId		= GetMonsterObjID( sceneId, i )
			SetCharacterName( sceneId, monsterId, x801018_g_TargetNPC )
		end
	end

	--¸±±¾¹Ø±Õ±êÖ¾
	local leaveFlag = LuaFnGetCopySceneData_Param( sceneId, 4 )

	local membercount = LuaFnGetCopyScene_HumanCount( sceneId )
	local mems = {}
	local i

	for i=0, membercount-1 do
		mems[i] = LuaFnGetCopyScene_HumanObjId( sceneId, i )
	end

	if leaveFlag == 1 then															--C¥n Àë¿ª
		--Àë¿ªµ¹¼ÆÊ±¼ätoÕ ğµ ¶ÁÈ¡ºÍÉèÖÃ
		local leaveTickCount = LuaFnGetCopySceneData_Param( sceneId, 5 )
		leaveTickCount = leaveTickCount + 1
		LuaFnSetCopySceneData_Param( sceneId, 5, leaveTickCount )

		if leaveTickCount >= x801018_g_CloseTick then										--µ¹¼ÆÊ±¼äµ½,´ó¼Ò¶¼³öÈ¥°É
			--½«µ±Ç°¸±±¾³¡¾°ÀïtoÕ ğµ ËùÓĞÈË´«ËÍ»ØÔ­À´½øÈëÊ±ºòtoÕ ğµ ³¡¾°
			for i=0, membercount-1 do
				if LuaFnIsObjValid( sceneId, mems[i] ) == 1 then
					x801018_BackToCity( sceneId, mems[i] )
				end
			end
		else
			--Í¨Öªµ±Ç°¸±±¾³¡¾°ÀïtoÕ ğµ ËùÓĞÈË,³¡¾°¹Ø±Õµ¹¼ÆÊ±¼ä
			local strText = format( "Các hÕ s¨ r¶i khöi n½i này trong vòng %d giây næa..", ( x801018_g_CloseTick - leaveTickCount ) * x801018_g_TickTime )

			for i=0, membercount-1 do
				if LuaFnIsObjValid( sceneId, mems[i] ) == 1 then
					x801018_NotifyFailTips( sceneId, mems[i], strText )
				end
			end
		end
	elseif TickCount == x801018_g_LimitTotalHoldTime then --¸±±¾×ÜÊ±¼äÏŞÖÆµ½ÁË
		--´Ë´¦ÉèÖÃ¸±±¾ÈÎÎñÓĞÊ±¼äÏŞÖÆtoÕ ğµ Çé¿ö,µ±Ê±¼äµ½ºó´¦Àí...
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId)
		local mems = {}
		for	i=0,membercount-1 do
			mems[i] = LuaFnGetCopyScene_HumanObjId(sceneId,i)
  		x801018_BackToCity(sceneId,mems[i])
		end
	end
end
