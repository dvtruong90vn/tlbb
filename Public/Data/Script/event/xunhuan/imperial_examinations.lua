x801016_g_ScriptId = 801016

x801016_g_MissionName="Khoa cØ"

x801016_g_Switch = 1
-- ÎÊÌâUI 	2

--1.clientµ¯³öNPCµÚmµt cái¶Ô»°½çÃæ
--2.¸øclient³öÌâ
--3.¸æËßclient´ð´íÁË.
--4.¸æËß´ð¹»ÁË10µÀÌâ,½áÊø.
x801016_g_Imperial_Exam_Hortation = {}

x801016_g_Imperial_Exam_Hortation[1] = 1
x801016_g_Imperial_Exam_Hortation[2] = 1.5
x801016_g_Imperial_Exam_Hortation[3] = 2
x801016_g_Imperial_Exam_Hortation[4] = 2.5
x801016_g_Imperial_Exam_Hortation[5] = 3
x801016_g_Imperial_Exam_Hortation[6] = 3.5
x801016_g_Imperial_Exam_Hortation[7] = 4
x801016_g_Imperial_Exam_Hortation[8] = 4.5
x801016_g_Imperial_Exam_Hortation[9] = 5
x801016_g_Imperial_Exam_Hortation[10] = 5.5

x801016_g_Imperial_Exam_Table = {}
x801016_g_Imperial_Exam_Table[10] = {money =  2783 ,	exp =   20}
x801016_g_Imperial_Exam_Table[11] = {money =  3336 ,	exp =   24}
x801016_g_Imperial_Exam_Table[12] = {money =  3935 ,	exp =   29}
x801016_g_Imperial_Exam_Table[13] = {money =  4582 ,	exp =   34}
x801016_g_Imperial_Exam_Table[14] = {money =  5274 ,	exp =   39}
x801016_g_Imperial_Exam_Table[15] = {money =  6013 ,	exp =   45}
x801016_g_Imperial_Exam_Table[16] = {money =  6798 ,	exp =   51}
x801016_g_Imperial_Exam_Table[17] = {money =  7628 ,	exp =   58}
x801016_g_Imperial_Exam_Table[18] = {money =  8503 ,	exp =   64}
x801016_g_Imperial_Exam_Table[19] = {money =  9423 ,	exp =   72}
x801016_g_Imperial_Exam_Table[20] = {money = 10387 ,	exp =   80}
x801016_g_Imperial_Exam_Table[21] = {money = 11396 ,	exp=88}
x801016_g_Imperial_Exam_Table[22] = {money = 12449 ,	exp=96}
x801016_g_Imperial_Exam_Table[23] = {money = 13546 ,	exp=105} 
x801016_g_Imperial_Exam_Table[24] = {money = 14687 ,	exp=115} 
x801016_g_Imperial_Exam_Table[25] = {money = 15872 ,	exp=124} 
x801016_g_Imperial_Exam_Table[26] = {money = 17100 ,	exp=135} 
x801016_g_Imperial_Exam_Table[27] = {money = 18371 ,	exp=145} 
x801016_g_Imperial_Exam_Table[28] = {money = 19685 ,	exp=156} 
x801016_g_Imperial_Exam_Table[29] = {money = 21042 ,	exp=167} 
x801016_g_Imperial_Exam_Table[30] = {money = 22442 ,	exp=179} 
x801016_g_Imperial_Exam_Table[31] = {money = 23885 ,	exp=191} 
x801016_g_Imperial_Exam_Table[32] = {money = 25370 ,	exp=204} 
x801016_g_Imperial_Exam_Table[33] = {money = 26897 ,	exp=217} 
x801016_g_Imperial_Exam_Table[34] = {money = 28467 ,	exp=230} 
x801016_g_Imperial_Exam_Table[35] = {money = 30079 ,	exp=244} 
x801016_g_Imperial_Exam_Table[36] = {money = 31733 ,	exp=258} 
x801016_g_Imperial_Exam_Table[37] = {money = 33429 ,	exp=273} 
x801016_g_Imperial_Exam_Table[38] = {money = 35166 ,	exp=287} 
x801016_g_Imperial_Exam_Table[39] = {money = 36945 ,	exp=303} 
x801016_g_Imperial_Exam_Table[40] = {money = 38766 ,	exp=319} 
x801016_g_Imperial_Exam_Table[41] = {money = 40628 ,	exp=335} 
x801016_g_Imperial_Exam_Table[42] = {money = 42531 ,	exp=351} 
x801016_g_Imperial_Exam_Table[43] = {money = 44476 ,	exp=368} 
x801016_g_Imperial_Exam_Table[44] = {money = 46462 ,	exp=385} 
x801016_g_Imperial_Exam_Table[45] = {money = 48489 ,	exp=403} 
x801016_g_Imperial_Exam_Table[46] = {money = 50556 ,	exp=421} 
x801016_g_Imperial_Exam_Table[47] = {money = 52665 ,	exp=440} 
x801016_g_Imperial_Exam_Table[48] = {money = 54814 ,	exp=459} 
x801016_g_Imperial_Exam_Table[49] = {money = 57004 ,	exp=478} 
x801016_g_Imperial_Exam_Table[50] = {money = 59235 ,	exp=498} 
x801016_g_Imperial_Exam_Table[51] = {money = 61506 ,	exp=518} 
x801016_g_Imperial_Exam_Table[52] = {money = 63818 ,	exp=538} 
x801016_g_Imperial_Exam_Table[53] = {money = 66170 ,	exp=559} 
x801016_g_Imperial_Exam_Table[54] = {money = 68562 ,	exp=580} 
x801016_g_Imperial_Exam_Table[55] = {money = 70994 ,	exp=602} 
x801016_g_Imperial_Exam_Table[56] = {money = 73467 ,	exp=624} 
x801016_g_Imperial_Exam_Table[57] = {money = 75980 ,	exp=647} 
x801016_g_Imperial_Exam_Table[58] = {money = 78532 ,	exp=670} 
x801016_g_Imperial_Exam_Table[59] = {money = 81125 ,	exp=693} 
x801016_g_Imperial_Exam_Table[60] = {money = 83757 ,	exp=717} 
x801016_g_Imperial_Exam_Table[61] = {money = 86430 ,	exp=741} 
x801016_g_Imperial_Exam_Table[62] = {money = 89141 ,	exp=765} 
x801016_g_Imperial_Exam_Table[63] = {money = 91893 ,	exp=790} 
x801016_g_Imperial_Exam_Table[64] = {money = 94684 ,	exp=815} 
x801016_g_Imperial_Exam_Table[65] = {money = 97515 ,	exp=841} 
x801016_g_Imperial_Exam_Table[66] = {money = 100385, exp=	867} 
x801016_g_Imperial_Exam_Table[67] = {money = 103295, exp=	894} 
x801016_g_Imperial_Exam_Table[68] = {money = 106243, exp=	920} 
x801016_g_Imperial_Exam_Table[69] = {money = 109232, exp=	948} 
x801016_g_Imperial_Exam_Table[70] = {money = 112259, exp=	975} 
x801016_g_Imperial_Exam_Table[71] = {money = 115326, exp=	1003}
x801016_g_Imperial_Exam_Table[72] = {money = 118431, exp=	1032}
x801016_g_Imperial_Exam_Table[73] = {money = 121576, exp=	1061}
x801016_g_Imperial_Exam_Table[74] = {money = 124760, exp=	1090}
x801016_g_Imperial_Exam_Table[75] = {money = 127983, exp=	1120}
x801016_g_Imperial_Exam_Table[76] = {money = 131245, exp=	1150}
x801016_g_Imperial_Exam_Table[77] = {money = 134545, exp=	1180}
x801016_g_Imperial_Exam_Table[78] = {money = 137884, exp=	1211}
x801016_g_Imperial_Exam_Table[79] = {money = 141262, exp=	1242}
x801016_g_Imperial_Exam_Table[80] = {money = 144679, exp=	1274}
x801016_g_Imperial_Exam_Table[81] = {money = 148135, exp=	1306}
x801016_g_Imperial_Exam_Table[82] = {money = 151629, exp=	1338}
x801016_g_Imperial_Exam_Table[83] = {money = 155161, exp=	1371}
x801016_g_Imperial_Exam_Table[84] = {money = 158733, exp=	1405}
x801016_g_Imperial_Exam_Table[85] = {money = 162342, exp=	1438}
x801016_g_Imperial_Exam_Table[86] = {money = 165990, exp=	1472}
x801016_g_Imperial_Exam_Table[87] = {money = 169677, exp=	1507}
x801016_g_Imperial_Exam_Table[88] = {money = 173401, exp=	1542}
x801016_g_Imperial_Exam_Table[89] = {money = 177164, exp=	1577}
x801016_g_Imperial_Exam_Table[90] = {money = 180966, exp=	1612}
x801016_g_Imperial_Exam_Table[91] = {money = 184805, exp=	1648}
x801016_g_Imperial_Exam_Table[92] = {money = 188683, exp=	1685}
x801016_g_Imperial_Exam_Table[93] = {money = 192599, exp=	1722}
x801016_g_Imperial_Exam_Table[94] = {money = 196552, exp=	1759}
x801016_g_Imperial_Exam_Table[95] = {money = 200544, exp=	1797}
x801016_g_Imperial_Exam_Table[96] = {money = 204574, exp=	1835}
x801016_g_Imperial_Exam_Table[97] = {money = 208642, exp=	1873}
x801016_g_Imperial_Exam_Table[98] = {money = 212748, exp=	1912}
x801016_g_Imperial_Exam_Table[99] = {money = 216891, exp=	1951}
--x801016_g_Imperial_Exam_Table[100] = {money = 221073,exp = 1951}
x801016_g_Imperial_Exam_Table[100] = {money = 221073,exp = 1991}
x801016_g_Imperial_Exam_Table[101] = {money = 225292,exp = 2031}
x801016_g_Imperial_Exam_Table[102] = {money = 229549,exp = 2071}
x801016_g_Imperial_Exam_Table[103] = {money = 233844,exp = 2112}
x801016_g_Imperial_Exam_Table[104] = {money = 238176,exp = 2153}
x801016_g_Imperial_Exam_Table[105] = {money = 242547,exp = 2195}
x801016_g_Imperial_Exam_Table[106] = {money = 246954,exp = 2237}
x801016_g_Imperial_Exam_Table[107] = {money = 251400,exp = 2279}
x801016_g_Imperial_Exam_Table[108] = {money = 255882,exp = 2322}
x801016_g_Imperial_Exam_Table[109] = {money = 260403,exp = 2365}
x801016_g_Imperial_Exam_Table[110] = {money = 264961,exp = 2409}
x801016_g_Imperial_Exam_Table[111] = {money = 269556,exp = 2453}
x801016_g_Imperial_Exam_Table[112] = {money = 274189,exp = 2497}
x801016_g_Imperial_Exam_Table[113] = {money = 278859,exp = 2542}
x801016_g_Imperial_Exam_Table[114] = {money = 283566,exp = 2587}
x801016_g_Imperial_Exam_Table[115] = {money = 288311,exp = 2633}
x801016_g_Imperial_Exam_Table[116] = {money = 293093,exp = 2679}
x801016_g_Imperial_Exam_Table[117] = {money = 297912,exp = 2725}
x801016_g_Imperial_Exam_Table[118] = {money = 302769,exp = 2772}
x801016_g_Imperial_Exam_Table[119] = {money = 307663,exp = 2819}
x801016_g_Imperial_Exam_Table[120] = {money = 312593,exp = 2867}

x801016_g_AccomplishCircumstance = 1
-- modify by zchw È¥³ý¾»»¯¼¼ÄÜÊé
--x801016_g_Award = {20109001,20109002,20109003,20109004,20109005,20109006,20109007,20109008,20109009,20109010,50101001,50101002,50102001,50102002,50102003,50102004,50103001,50104002,50111001,50111002,50112001,50112002,50112003,50112004,50113001,50113002,50113003,50113004,50113005,50114001,30503011,30606001,30402001,30402002,30402003,30402004,30402005,30402006,30402007,30402008,30402009,30402010,30402011,30402013,30402015,30402017,30402019,30402025,30402029,30402031,30402033,30402035,30402037,30402039,30402041,30402043,30402045,30402047,30402049,30402051,30402052,30402053,30402054,30402055,30402059,30402061,30402063,30402065,30402067,30402069,30402071,30402073}
x801016_g_Award = {20109001,20109002,20109003,20109004,20109005,20109006,20109007,20109008,20109009,20109010,50101001,50101002,50102001,50102002,50102003,50102004,50103001,50104002,50111001,50111002,50112001,50112002,50112003,50112004,50113001,50113002,50113003,50113004,50113005,50114001,30503011,30606001,30402001,30402002,30402003,30402004,30402005,30402006,30402007,30402008,30402009,30402010,30402011,30402013,30402015,30402017,30402019,30402025,30402029,30402033,30402035,30402037,30402039,30402041,30402043,30402045,30402047,30402049,30402051,30402052,30402053,30402054,30402055,30402059,30402061,30402063,30402065,30402067,30402069,30402071,30402073}
x801016_g_Examinant_Name = {"(Chü nhi®m) Khäo quan 1","Khäo quan 2","Khäo quan 3","Khäo quan 4","Khäo quan 5","Khäo quan 6","Khäo quan 7","Khäo quan 8","Khäo quan 9","Khäo quan 10","Khäo quan 11","Khäo quan 12","Khäo quan 13","Khäo quan 14","Khäo quan 15","Khäo quan 16","Khäo quan 17","Khäo quan 18","Khäo quan 19","Khäo quan 20"}

x801016_g_Bribe_Money = 10000

x801016_g_Count_Examinant = 20
x801016_g_Count_Question  = 10

x801016_g_Examinant_Position = {}
x801016_g_Examinant_Position[1] ={x=146,z=252}
x801016_g_Examinant_Position[2] ={x=177,z=250}
x801016_g_Examinant_Position[3] ={x=205,z=210}
x801016_g_Examinant_Position[4] ={x=230,z=180}
x801016_g_Examinant_Position[5] ={x=244,z=220}
x801016_g_Examinant_Position[6] ={x=276,z=223}
x801016_g_Examinant_Position[7] ={x=292,z=201}
x801016_g_Examinant_Position[8] ={x=310,z=182}
x801016_g_Examinant_Position[9] ={x=359,z=184}
x801016_g_Examinant_Position[10]={x=378,z=220}
x801016_g_Examinant_Position[11]={x=367,z=251}
x801016_g_Examinant_Position[12]={x=330,z=250}
x801016_g_Examinant_Position[13]={x=344,z=311}
x801016_g_Examinant_Position[14]={x=310,z=320}
x801016_g_Examinant_Position[15]={x=282,z=329}
x801016_g_Examinant_Position[16]={x=259,z=301}
x801016_g_Examinant_Position[17]={x=209,z=285}
x801016_g_Examinant_Position[18]={x=177,z=280}
x801016_g_Examinant_Position[19]={x=156,z=280}
x801016_g_Examinant_Position[20]={x=155,z=266}

x801016_g_Reward_Gem = {50101001,50101002,50102001,50102002,50102003,50102004,50103001,50104002,50111001,50111002,50112001,50112002,50112003,50112004,50113001,50113002,50113003,50113004,50113005,50114001}
x801016_g_Reward_Reborn_Medicine = 30503011
x801016_g_Reward_Prolong_Medicine = 30606001
x801016_g_Reward_Punch = {20109001,20109002,20109003,20109004,20109005,20109006,20109007,20109008,20109009,20109010}
-- modify by zchw È¥³ý¾»»¯¼¼ÄÜÊé
--x801016_g_Reward_Craftsmanship = {30402001,30402002,30402003,30402004,30402005,30402006,30402007,30402008,30402009,30402010,30402011,30402013,30402015,30402017,30402019,30402025,30402029,30402031,30402033,30402035,30402037,30402039,30402041,30402043,30402045,30402047,30402049,30402051,30402052,30402053,30402054,30402055,30402059,30402061,30402063,30402065,30402067,30402069,30402071,30402073}
x801016_g_Reward_Craftsmanship = {30402001,30402002,30402003,30402004,30402005,30402006,30402007,30402008,30402009,30402010,30402011,30402013,30402015,30402017,30402019,30402025,30402029,30402033,30402035,30402037,30402039,30402041,30402043,30402045,30402047,30402049,30402051,30402052,30402053,30402054,30402055,30402059,30402061,30402063,30402065,30402067,30402069,30402071,30402073}
x801016_g_Reward_Dress = 10124018
x801016_g_Reward_Ticket = 30505079
x801016_g_Jiangli_JinBang = 30505133
--**********************************
function x801016_OnDefaultEvent( sceneId, selfId, targetId, param2, param3, param4, param5 )
	local npcobjid
	if param5~=nil and param5 == 1000 then
		for i = 1,20 do 
			npcobjid = LuaFnCreateMonster( sceneId, 11, x801016_g_Examinant_Position[i].x,x801016_g_Examinant_Position[i].z, 3, -1, 801017 )
			if i == 1 then
				SetCharacterDieTime(sceneId, npcobjid, (4+2.5)*3600000)
			else
				SetCharacterDieTime(sceneId, npcobjid, 3*3600000+100) 
			end
			SetCharacterName(sceneId, npcobjid, x801016_g_Examinant_Name[i])
		end
		x801016_Clear_Candidate( sceneId, selfId )
		x801016_Clear_Top( sceneId, selfId )
		return
	end
	if  x801016_EstimationPhase( sceneId, selfId) == 0 then

		local msg = "Hi®n không tiªn hành thi khoa cØ"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
  end
  local Player_Level = GetLevel( sceneId, selfId )
	local TransportNPCName = GetName(sceneId,targetId);
	
	local times = GetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE)
	local Wrong_Times = mod(times,100)
	local Question_Sequence_Before = floor(times/100)
	local Question_Sequence = mod(Question_Sequence_Before,x801016_g_Count_Question)
	local Examinator_Sequence = floor(Question_Sequence_Before/x801016_g_Count_Question)
	
	local PlayerMaxLevel = GetHumanMaxLevelLimit()
	if Question_Sequence == 0 and Examinator_Sequence == 0 and 
			Player_Level >= 10 and Player_Level <= PlayerMaxLevel and
			GetMissionData(sceneId,selfId,MD_EXAM_FEE_FLAG) == 0 then
		BeginUICommand(sceneId)
			UICommand_AddInt(sceneId,1)
			UICommand_AddString(sceneId,TransportNPCName)
			UICommand_AddInt(sceneId,targetId)
			UICommand_AddInt(sceneId,x801016_g_Imperial_Exam_Table[Player_Level].money)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 28)
	else
		x801016_AskQuestion( sceneId, selfId )
	end
	
	return
end
--**********************************
--ÐÄÌøº¯Êý
--**********************************
function x801016_OnTimer( sceneId, actId, uTime )
end

function x801016_Broadcast_CANDIDATE_EXAM( sceneId, selfId )
--	local sum_Candidate = getn(CANDIDATE_EXAM)
--	local str = "µÚmµt ÂÖÖÝÊÔÒÑ¾­½áÊø,½øÈëµÚ¶þÂÖÊ¡ÊÔtoÕ ðµ Íæ¼ÒÓÐ:"
--	for i,EachStudent in CANDIDATE_EXAM do
--		if EachStudent then 
--				if EachStudent.guid ~= 0 then
--					local tName=EachStudent.guid
--					str = str .. "#{_INFOUSR"..tName.."},"
--				end
--		end
--	end
--	str = str .. "Çëµ½ÐÕi LýtoÕ ðµ Ö÷¿¼¹Ù´¦½øÐÐµÚ¶þÂÖÃæÊÔ."
	
	--»ñÈ¡ÈÕÆÚ--add by xindefeng
	local Year = LuaFnGetThisYear()
	local Month = LuaFnGetThisMonth() + 1
	if(Month < 10) then
		Month = "0"..Month		
	end
	local Day = LuaFnGetDayOfThisMonth()
	
	local str = "Cuµc thi châu vòng 1 ðã kªt thúc, nhæng ngß¶i ch½i ðßþc l÷t vào vòng 2 là: "
	BroadMsgByChatPipe( sceneId,selfId,str,4)

	for i,EachStudent in CANDIDATE_EXAM do
		if EachStudent then 
			if EachStudent.guid ~= 0 then
				local tName = EachStudent.guid
				str = "  #{_INFOUSR"..tName.."}, "
				if str ~= "  "  then
					--C¥n ÐÞ¸Ä,Ôö¼Ó·¢ËÍÓÊ¼þ¹¦ÄÜ½øÈëµÚ¶þÂÖtoÕ ðµ Íæ¼Òmodi:lby20071209
					--local tGuid = LuaFnGuid2ObjId(sceneId,EachStudent.guid)
					--local strName=GetName(sceneId,tGuid);
					
					--changed by xindefeng
					--LuaFnSendSystemMail(sceneId, strName, "Chúc m×ngÄãKhoa cØÃûÁÐÇ°Ã©,³É¹¦½øÈëÊ¡ÊÔ.ÇëËÙµ½ËÙµ½ÐÕi Lý²Î¼ÓKhoa cØÊ¡ÊÔ.")
					local strMai = format("#YChúc m×ngÄãKhoa cØÃûÁÐÇ°Ã©,³É¹¦½øÈëÊ¡ÊÔ.ÇëËÙµ½#GÐÕi Lýmµt ºÅ¿¼¹Ù(46,152)#Y´¦²Î¼ÓKhoa cØÊ¡ÊÔ.#GÊ¡ÊÔ½«TÕi µ±ÈÕ(ÓÊ¼þ·¢ËÍµ±ÈÕ)21: 30½áÊø.#r                                  %s-%s-%s", Year, Month, Day)					
					LuaFnSendSystemMail(sceneId, tName, strMai)					
					
					BroadMsgByChatPipe( sceneId,selfId,str,4)
				end
			end
		end
	end
	
	str = "Xin t¾i ch² quan chü khäo · ÐÕi Lý tiªn hành vòng thi nói l¥n 2"
	BroadMsgByChatPipe( sceneId,selfId,str,4)

end

function x801016_Broadcast_TOP_3_EXAM( sceneId, selfId )
	local sum_Candidate = getn(TOP_3_EXAM)
	local str = "#PHoÕt ðµng khoa cØ l¥n này ðã hoàn toàn kªt thúc, tam giáp g°m:"
	local strMingCi=""
	--»ñÈ¡ÈÕÆÚ--add by xindefeng
	local Year = LuaFnGetThisYear()
	local Month = LuaFnGetThisMonth() + 1
	if(Month < 10) then
		Month = "0"..Month		
	end
	local Day = LuaFnGetDayOfThisMonth()
	
	for i,EachStudent in TOP_3_EXAM do
		if EachStudent then 
				if EachStudent.guid ~= 0 then
--					local tGuid = LuaFnGuid2ObjId(sceneId,EachStudent.guid)
--					local tName=GetName(sceneId,tGuid);
					local tName=EachStudent.guid
					if i == 1 then
						str = str .. "TrÕng Nguyên: "
						strMingCi = "×´Ôª"
					elseif i == 2 then
						str = str .. "Bäng Nhãn: "
						strMingCi = "°ñÑÛ"
					elseif i == 3 then
						str = str .. "Thám Hoa: "
						strMingCi = "Ì½»¨"
					end
					str = str .. "#{_INFOUSR"..tName.."},"
					
					--C¥n ÐÞ¸Ä,Ôö¼Ó·¢ËÍÓÊ¼þ¹¦ÄÜÇ°Èý¼×toÕ ðµ ÈËÔ±modi:lby20071209
					--changed by xindefeng
					--strMai	= format( "Chúc m×ngÄã¸ßÖÐ±¾´ÎKhoa cØtoÕ ðµ %s,Các hÕ ðã nh§n ðßþc ³¯Í¢°ä·¢toÕ ðµ ¼Î½±,Çëµ½ÐÕi LýÖ÷¿¼¹Ù´¦Lînh .", strMingCi )
					local strMai = format("#YChúc m×ngÄã¸ßÖÐ±¾´ÎKhoa cØtoÕ ðµ #G%s#Y,Các hÕ ðã nh§n ðßþc ³¯Í¢°ä·¢toÕ ðµ ¼Î½±,ÇëËÙµ½ÐÕi LýÖ÷¿¼¹Ù´¦Lînh .#G½±Æ·Ö»ÄÜµ±ÈÕ(ÓÊ¼þ·¢ËÍµ±ÈÕ)ÁìÈ.¬ÓâÆÚ½«ÎÞ·¨Lînh .#r                                  %s-%s-%s", strMingCi, Year, Month, Day)
					--local tGuid = LuaFnGuid2ObjId(sceneId,EachStudent.guid)
					--local strName=GetName(sceneId,tGuid);
					LuaFnSendSystemMail(sceneId, tName, strMai)
				end
		end
		
	end
	
	str = str .. "Xin các thí sinh ðoÕt giäi t¾i ch² quan chü khäo lînh thß·ng"
	
	BroadMsgByChatPipe( sceneId,selfId,str,4)
	
end

--**********************************
--¼ÓÈëµ½Candidate 10Ãûµ¥
--**********************************
function x801016_Add_To_Candidate( sceneId, selfId, currentPlayer_Time, currentPlayer_Guid )
	local sum_Candidate = getn(CANDIDATE_EXAM)

	for i,EachStudent in CANDIDATE_EXAM do
		
		if EachStudent then 
--				PrintStr("candidate i="..i.." guid="..currentPlayer_Guid)
--				PrintStr("EachStudent.time="..EachStudent.time.." EachStudent.guid="..EachStudent.guid)
				if EachStudent.time > currentPlayer_Time then
					local max = sum_Candidate - i
					
					for j=1,max do
						CANDIDATE_EXAM[sum_Candidate - j + 1].time = CANDIDATE_EXAM[sum_Candidate - j].time
						CANDIDATE_EXAM[sum_Candidate - j + 1].guid = CANDIDATE_EXAM[sum_Candidate - j].guid
					end

					CANDIDATE_EXAM[i].time = currentPlayer_Time
					CANDIDATE_EXAM[i].guid = currentPlayer_Guid
--					PrintStr("candidate i="..i.." guid="..currentPlayer_Guid)
					
	  	 		break
				end
		end
		
	end

end

function x801016_Clear_Candidate( sceneId, selfId )

	for i,EachStudent in CANDIDATE_EXAM do
		CANDIDATE_EXAM[i].time = 99999
		CANDIDATE_EXAM[i].guid = 0
	end
	
end

function x801016_Query_Candidate( sceneId, selfId )
	local selfGuid = GetName(sceneId,selfId)
	for i,EachStudent in CANDIDATE_EXAM do
--		PrintStr("guid="..EachStudent.guid.." selfGuid="..selfGuid)

		if EachStudent.guid == selfGuid then
			return 1
		end

	end
	return 0
end

function x801016_Delete_Candidate( sceneId, selfId )
	local selfGuid = GetName(sceneId,selfId)
	for i,EachStudent in CANDIDATE_EXAM do
--		PrintStr("guid="..EachStudent.guid.." selfGuid="..selfGuid)

		if EachStudent.guid == selfGuid then
			CANDIDATE_EXAM[i].time = 99999
			CANDIDATE_EXAM[i].guid = 0
			return 1
		end

	end
	return 0
end
--**********************************
--¼ÓÈëµ½TOP 3Ãûµ¥
--**********************************
function x801016_Add_To_Top( sceneId, selfId, currentPlayer_Time, currentPlayer_Guid )
	local sum_Top = getn(TOP_3_EXAM)

	for i,EachStudent in TOP_3_EXAM do
		
		if EachStudent then 
				if EachStudent.time > currentPlayer_Time then
					local max = sum_Top - i
					
					for j=1,max do
						TOP_3_EXAM[sum_Top - j + 1].time = TOP_3_EXAM[sum_Top - j].time
						TOP_3_EXAM[sum_Top - j + 1].guid = TOP_3_EXAM[sum_Top - j].guid
					end
										
					TOP_3_EXAM[i].time = currentPlayer_Time
					TOP_3_EXAM[i].guid = currentPlayer_Guid
--					PrintStr("top 3 i="..i.." guid="..currentPlayer_Guid)
					
	  	 		break
				end
		end
		
	end

end

function x801016_Clear_Top( sceneId, selfId )

	for i,EachStudent in TOP_3_EXAM do
		TOP_3_EXAM[i].time = 99999
		TOP_3_EXAM[i].guid = 0
	end
	
end

function x801016_Query_Top( sceneId, selfId )
	local selfGuid = GetName(sceneId,selfId)
	for i,EachStudent in TOP_3_EXAM do
--		PrintStr("guid="..EachStudent.guid.." selfGuid="..selfGuid)
		if EachStudent.guid == selfGuid then
			return i
		end

	end
	return 0
end

function x801016_Delete_Top( sceneId, selfId )
	local selfGuid = GetName(sceneId,selfId)
	for i,EachStudent in TOP_3_EXAM do
	
		if EachStudent.guid == selfGuid then
			TOP_3_EXAM[i].time = 99999
			TOP_3_EXAM[i].guid = 0
			return 1
		end

	end
	return 0
end

--**********************************
--ÅÐ¶ÏÐúng·ñ»î¶¯
--**********************************
function x801016_EstimationPhase( sceneId, selfId )
	--begin modified by zhangguoxin 090208
	--local CurTime = GetHourTime()								--µ±Ç°Ê±¼ä
	local CurTime = GetQuarterTime()								--µ±Ç°Ê±¼ä
	--begin modified by zhangguoxin 090208
	local CurQuarterTime = mod( CurTime, 100 )	--µ±Ç°Ê±¼ä(¿Ì)
	
	if CurQuarterTime >= 70 and CurQuarterTime < 82 then
		return 1
	end
	
	if CurQuarterTime >= 84 and CurQuarterTime < 86 then
		return 2
	end

	return 0
end

--**********************************
--ÅÐ¶Ï ði¬mµ½toÕ ðµ ÐúngÄÄcáiNPC
--**********************************
function x801016_Which_Examinant( sceneId, selfId, targetId )

	local ExaminantNPCName=GetName(sceneId,targetId);

	for i,EachOne in x801016_g_Examinant_Name do
		if ExaminantNPCName == EachOne then
			return i
		end
	end
	return 0

end

function x801016_Bestow_Gift_OnTop( sceneId, selfId, place)
	local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)
	local str_item = ""
	local str_title = "Thám Hoa"
	local str_msg_2 = ""



	local huodongItemIndex = -1;
	BeginAddItem(sceneId)
		AddItem( sceneId,x801016_g_Reward_Reborn_Medicine,1)
		str_item = str_item .. "#r#{_ITEM"..x801016_g_Reward_Reborn_Medicine.."}."
		str_msg_2 = str_msg_2 .."Các hÕ ðã ðã ðÕt ðßþc 1 #B#{_ITEM"..x801016_g_Reward_Reborn_Medicine.."}#W."
--		Msg2Player( sceneId,selfId,"Các hÕ ðã ðã ðÕt ðßþc 1 #B#{_ITEM"..x801016_g_Reward_Reborn_Medicine.."}#W.",MSG2PLAYER_PARA)
		--»î¶¯½±ÀøÍ³¼Æ
		local itemName;
		_,itemName,_ = GetItemInfoByItemId(x801016_g_Reward_Reborn_Medicine)
		LuaFnAuditItemCreate(sceneId,selfId,1,x801016_g_Reward_Reborn_Medicine,itemName,"#PKhoa cØ-Ì½»¨")
		
		if place < 3 then
			local sum = getn(x801016_g_Reward_Gem)
			local rrr = random(sum)
			
			AddItem( sceneId,x801016_g_Reward_Gem[rrr],1)
			str_item = str_item .. "#r#{_ITEM"..x801016_g_Reward_Gem[rrr].."}."
			str_msg_2 = str_msg_2 .."Các hÕ ðã ðã ðÕt ðßþc 1 #B#{_ITEM"..x801016_g_Reward_Gem[rrr].."}#W."
--			Msg2Player( sceneId,selfId,"Các hÕ ðã ðã ðÕt ðßþc 1 #B#{_ITEM"..x801016_g_Reward_Gem[rrr].."}#W.",MSG2PLAYER_PARA)
			str_title = "Bäng Nhãn"
			--»î¶¯½±ÀøÍ³¼Æ
			_,itemName,_ = GetItemInfoByItemId(x801016_g_Reward_Gem[rrr])
			LuaFnAuditItemCreate(sceneId,selfId,1,x801016_g_Reward_Gem[rrr],itemName,"#PKhoa cØ - Bäng nhãn")
		end
		
		if place < 2 then
			AddItem( sceneId,x801016_g_Reward_Prolong_Medicine,1)
			AddItem( sceneId,x801016_g_Reward_Prolong_Medicine,1)
			str_item = str_item .. "#rhai cái#{_ITEM"..x801016_g_Reward_Prolong_Medicine.."}"
			str_msg_2 = str_msg_2 .."Các hÕ ðã ðÕt ðßþc 2 chÑc #B#{_ITEM"..x801016_g_Reward_Prolong_Medicine.."}#W"
--			Msg2Player( sceneId,selfId,"Các hÕ ðã ðÕt ðßþc 2 chÑc #B#{_ITEM"..x801016_g_Reward_Prolong_Medicine.."}#W.",MSG2PLAYER_PARA)
			str_title = "TrÕng Nguyên"
			--»î¶¯½±ÀøÍ³¼Æ
			_,itemName,_ = GetItemInfoByItemId(x801016_g_Reward_Prolong_Medicine)
			LuaFnAuditItemCreate(sceneId,selfId,2,x801016_g_Reward_Prolong_Medicine,itemName,"#PKhoa cØ - TrÕng Nguyên")
		end
		
		--5ÔÂ9ÈÕ¡ª¡ª5ÔÂ31ÈÕ(¸ßc¤p»éÀñÈ¯ÔùËÍ)
		local leftDayLimit = 7128;
		local rightDayLimit = 7151;
		local curDay = GetDayTime();
		if curDay and curDay >= leftDayLimit and curDay < rightDayLimit then
			if place == 3 or place == 2 then
				huodongItemIndex = AddItem(sceneId, 10124018, 1);
			elseif place == 1 then
				huodongItemIndex = AddItem(sceneId, 30505079, 1);
			end
		end

	ret = EndAddItem(sceneId,selfId)
	if ret > 0 then
		AddItemListToHuman(sceneId,selfId)
		x801016_Delete_Top( sceneId, selfId )
		x801016_Delete_Candidate( sceneId, selfId )
		x801016_MessageBox( sceneId, selfId, str_msg_2)
		Msg2Player( sceneId,selfId,str_msg_2,MSG2PLAYER_PARA)
		local msg = "Xin chúc m×ng, kÏ thi khoa cØ nåm nay, các hÕ là"..str_title.."Và ðã ðÕt ðßþc nhæng t£ng ph¦m dß¾i ðây: "..str_item
		local cmsg = "R¶i khöi.."
		
		x801016_MyAwardTitle( sceneId, selfId, place )
		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		if huodongItemIndex and huodongItemIndex > -1 then
			local strHodongItem = GetItemTransfer(sceneId, selfId, huodongItemIndex);
			local strMsg = "#cff99ccTrong lúc l­ cß¾i c¤p hoàng gia t± chÑc mi­n phí, do#W#{_INFOUSR"..GetName(sceneId, selfId).."}#cff99cc trong hoÕt ðµng khoa cØ ðÕt ðßþc #Ykhoa cØ"..str_title.."#cff99cc danh xßng. Tri«u ðình tán thß·ng ph¥n thß·ng ð£c bi®#{_INFOMSG"..strHodongItem.."}"
			BroadMsgByChatPipe(sceneId, selfId, "@*;SrvMsg;SCA:"..strMsg, 4);
		end
		if place == 3 then
				Msg2Player( sceneId,selfId,"Các hÕ ðã ðÕt ðßþc danh xßng #B khoa cØ Thám Hoa#W",MSG2PLAYER_PARA)
		elseif place == 2 then
				Msg2Player( sceneId,selfId,"Các hÕ ðã ðÕt ðßþc danh xßng #B khoa cØ Bäng Nhãn#W",MSG2PLAYER_PARA)
		elseif place == 1 then
				Msg2Player( sceneId,selfId,"Các hÕ ðã ðÕt ðßþc danh xßng #B khoa cØ TrÕng Nguyên#W",MSG2PLAYER_PARA)
		end
		return
	else
		local msg = "Tay näi ðã ð¥y, d÷n tay näi xong hãy t¾i lînh t£ng thß·ng"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
--		Msg2Player( sceneId,selfId,"±³°üÒÑÂú,ÇëÇåÀíÍê±³°üÔÙÀ´Lînh ½±Àø.",MSG2PLAYER_PARA)
	end

	return
end
--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x801016_OnEnumerate( sceneId, selfId, targetId )
--SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,203)

	local starttime = GetMissionData(sceneId,selfId,MD_EXAM_STARTTIME)
	local New_Time = LuaFnGetCurrentTime()
	local current_time = New_Time - starttime
--	x801016_Bestow_Gift_OnTop( sceneId, selfId, 1)
	if current_time >= 72000 then

		SetMissionData(sceneId,selfId,MD_EXAM_STARTTIME,New_Time)
		SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,10)
		SetMissionData(sceneId,selfId,MD_EXAM_FEE_FLAG,0)
		SetMissionData(sceneId,selfId,MD_EXAM_FLAG,0)
		
		SetMissionData(sceneId,selfId,MD_EXAM_FIGHT_FLAG,0)
		SetMissionData(sceneId,selfId,MD_EXAM_BRIBE_FLAG,0)

		-- ÈÎÎñ»mµt î¶¯Í³¼Æ
		LuaFnAuditQuest(sceneId, selfId, "Khoa cØ")

	end
	
	if LuaFnGetLevel( sceneId, selfId) < 10 then

		local msg = "Ngß¶i ch½i t× c¤p 10 tr· lên có th¬ tham gia hoÕt ðµng"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return

	end

	if  x801016_EstimationPhase( sceneId, selfId) == 0 then
		local ret = x801016_Query_Top( sceneId, selfId) 
		if ret ~= 0 then
			x801016_Bestow_Gift_OnTop( sceneId, selfId, ret);
			return
--		elseif  x801016_Query_Candidate( sceneId, selfId ) == 1 then
--			local msg = "ÄãÃ»ÓÐ½øÈëÇ°Èý¼×."
--			local cmsg = "R¶i khöi.."

--			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
--			return
		end
		
		local msg = "Hi®n vçn chßa t¾i th¶i gian b¡t ð¥u cuµc thi khoa cØ, xin ðþi sau khi hoÕt ðµng b¡t ð¥u thì hãy t¾i tìm ta"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
  end
  
	local times = GetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE)
	local Wrong_Times = mod(times,100)
	local Question_Sequence_Before = floor(times/100)
	local Question_Sequence = mod(Question_Sequence_Before,x801016_g_Count_Question)
	local Examinator_Sequence = floor(Question_Sequence_Before/x801016_g_Count_Question)

	if Wrong_Times == 0 then

		local msg = "Th§t ðáng tiªc, ngß½i không còn c½ hµi trä l¶i lÕi. Hãy tiªp tøc n² lñc · kÏ thi sau"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
	end

	if times~=0 and x801016_EstimationPhase( sceneId, selfId ) == 1 then

		if Examinator_Sequence >= x801016_g_Count_Examinant then
			local msg = "Xin hãy ðþi ðªn hoÕt ðµng khoa cØ l¥n sau"
			local cmsg = "R¶i khöi.."

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
	end
	if times~=0 and x801016_EstimationPhase( sceneId, selfId ) == 1 then
	
		if Examinator_Sequence+1 ~= x801016_g_Count_Examinant and Examinator_Sequence+1 ~= x801016_Which_Examinant( sceneId, selfId, targetId ) then
			--local msg = "ÇëÕÒµÚ"..tostring(Examinator_Sequence+1).."Î»¿¼¹ÙÓ¦ÊÔ.#r´Ë¿¼¹ÙÎ»ÖÃTÕi ("..x801016_g_Examinant_Position[Examinator_Sequence+1].x..", "..x801016_g_Examinant_Position[Examinator_Sequence+1].z..")."
			local msg = "Xin tìm v¸ thÑ"..tostring(Examinator_Sequence+1).."Thí sinh Ñng thi. #rCh² cüa thí sinh Ñng thi · ("..x801016_g_Examinant_Position[Examinator_Sequence+1].x..", "..x801016_g_Examinant_Position[Examinator_Sequence+1].z..")"
			local cmsg = "R¶i khöi.."
			CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, sceneId, x801016_g_Examinant_Position[Examinator_Sequence+1].x, x801016_g_Examinant_Position[Examinator_Sequence+1].z, x801016_g_Examinant_Name[Examinator_Sequence+1] )

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
	end

	if GetMissionData(sceneId,selfId,MD_EXAM_FLAG) == 1 then
		x801016_OnHandle_Violence(sceneId, selfId)
		return
	end
	if x801016_EstimationPhase( sceneId, selfId) == 2 then
		if x801016_Query_Candidate( sceneId, selfId ) == 0 then

			local msg = "Ngß½i không có tß cách tham gia cuµc thi tïnh"
			local cmsg = "R¶i khöi.."

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end

		if Examinator_Sequence > x801016_g_Count_Examinant then

			local msg = "Xin chúc m×ng thí sinh ðã trä l¶i hªt m÷i ð« møc cüa cuµc thi tïnh. Sau ðây xin công b¯ Tam giáp"
			local cmsg = "R¶i khöi.."

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
		if x801016_Which_Examinant( sceneId, selfId, targetId ) == 1 then
			SetMissionData(sceneId,selfId,MD_EXAM_TARGETID,targetId)
			AddNumText(sceneId,x801016_g_ScriptId,x801016_g_MissionName,4,-1);
		else
			--local msg = "ÇëÕÒ(Ö÷)¿¼¹Ùmµt Ó¦ÊÔ.#r´Ë¿¼¹ÙÎ»ÖÃTÕi ("..x801016_g_Examinant_Position[1].x..", "..x801016_g_Examinant_Position[1].z..")."
			local msg = "Xin tìm quan (chü khäo) - Ñng thi. #rV¸ trí cüa quan chü khäo n¢m · ("..x801016_g_Examinant_Position[1].x..", "..x801016_g_Examinant_Position[1].z..")"
			local cmsg = "R¶i khöi.."
			CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, sceneId, x801016_g_Examinant_Position[0+1].x, x801016_g_Examinant_Position[0+1].z, x801016_g_Examinant_Name[0+1] )

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
	elseif x801016_EstimationPhase( sceneId, selfId) == 1 then
		SetMissionData(sceneId,selfId,MD_EXAM_TARGETID,targetId)
		AddNumText(sceneId,x801016_g_ScriptId,x801016_g_MissionName,4,-1);
	else
		local msg = "Hi®n không tiªn hành thi khoa cØ"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
  end
end

--**********************************
--ÌáÎÊ
--**********************************
function x801016_AskQuestion( sceneId, selfId )
--	SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,1093)
	local times = GetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE)
	local Wrong_Times = mod(times,100)
	local Question_Sequence_Before = floor(times/100)
	local Question_Sequence = mod(Question_Sequence_Before,x801016_g_Count_Question)
	local Examinator_Sequence = floor(Question_Sequence_Before/x801016_g_Count_Question)
	local Player_Level = GetLevel( sceneId, selfId )

--	if Examinator_Sequence == 0 then
--		Examinator_Sequence = 1
--	end
	local New_Time = LuaFnGetCurrentTime()
	local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)
	local phase_now = x801016_EstimationPhase( sceneId, selfId )
	
	local PlayerMaxLevel = GetHumanMaxLevelLimit()
	if Question_Sequence == 0 and Examinator_Sequence == 0 and 
			Player_Level >= 10 and Player_Level <= PlayerMaxLevel and
			GetMissionData(sceneId,selfId,MD_EXAM_FEE_FLAG) == 0 then
			local need_money = x801016_g_Imperial_Exam_Table[Player_Level].money

			--local ret = CostMoney( sceneId, selfId, need_money )
			local jz,jb = LuaFnCostMoneyWithPriority( sceneId, selfId, need_money )  

			if jz == -1  then                                           
				local msg = "Xin l²i, trên ngß¶i các hÕ không ðü ngân lßþng"
				local cmsg = "R¶i khöi.."

				x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
				return
			else
				SetMissionData(sceneId,selfId,MD_EXAM_FEE_FLAG,1)
			end
			
	end
	
	if times ~= 0 and Wrong_Times == 0 then
		local msg = "Th§t ðáng tiªc, ngß½i không còn c½ hµi trä l¶i lÕi. Hãy tiªp tøc n² lñc · kÏ thi sau"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
	end
	if phase_now == 2 and Examinator_Sequence >= x801016_g_Count_Examinant then
		Examinator_Sequence = Examinator_Sequence - x801016_g_Count_Examinant
	end 

	if phase_now == 1 then

		if Examinator_Sequence >= x801016_g_Count_Examinant then
			local msg = "Xin hãy ðþi ðªn hoÕt ðµng khoa cØ l¥n sau"
			local cmsg = "R¶i khöi.."

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
--		PrintNum(Question_Sequence_Before)
		if Examinator_Sequence+1 ~= x801016_Which_Examinant( sceneId, selfId, targetId ) then
			--local msg = "ÇëÕÒµÚ"..tostring(Examinator_Sequence+1).."Î»¿¼¹ÙÓ¦ÊÔ.#r´Ë¿¼¹ÙÎ»ÖÃTÕi ("..x801016_g_Examinant_Position[Examinator_Sequence+1].x..", "..x801016_g_Examinant_Position[Examinator_Sequence+1].z..")."
			local msg = "Xin tìm v¸ thÑ"..tostring(Examinator_Sequence+1).."Thí sinh Ñng thi. #rCh² cüa thí sinh Ñng thi · ("..x801016_g_Examinant_Position[Examinator_Sequence+1].x..", "..x801016_g_Examinant_Position[Examinator_Sequence+1].z..")"
			local cmsg = "R¶i khöi.."
			CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, sceneId, x801016_g_Examinant_Position[Examinator_Sequence+1].x, x801016_g_Examinant_Position[Examinator_Sequence+1].z, x801016_g_Examinant_Name[Examinator_Sequence+1] )

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
		local starttime = GetMissionData(sceneId,selfId,MD_EXAM_STARTTIME)
		local current_time = New_Time - starttime
		if Question_Sequence == 1 and Wrong_Times == 0 then
			if current_time < 72000 then
				local msg = "M²i ngày chï có th¬ tham gia 1 hoÕt ðµng khoa cØ"
				local cmsg = "R¶i khöi.."

				x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
				return
			end
			SetMissionData(sceneId,selfId,MD_EXAM_STARTTIME,New_Time)
			SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,(1*x801016_g_Count_Question+1)*100+3)
		end
	
	elseif phase_now == 2 then
		
		if x801016_Query_Candidate( sceneId, selfId ) == 0 then
			local msg = "Ngß½i không có tß cách tham gia cuµc thi tïnh"
			local cmsg = "R¶i khöi.."

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
		
		if x801016_Which_Examinant( sceneId, selfId, targetId ) ~= 1 then
			local msg = "Xin m¶i thí sinh Ñng thi thÑ nh¤t"
			local cmsg = "R¶i khöi.."
			CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, sceneId, x801016_g_Examinant_Position[0+1].x, x801016_g_Examinant_Position[0+1].z, x801016_g_Examinant_Name[0+1] )

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
	
		if Examinator_Sequence == x801016_g_Count_Examinant then

			local msg = "Xin chúc m×ng thí sinh ðã trä l¶i hªt m÷i ð« møc cüa cuµc thi tïnh. Sau ðây xin công b¯ Tam giáp"
			local cmsg = "R¶i khöi.."

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		else
			local New_Time_2 = LuaFnGetCurrentTime()
			SetMissionData(sceneId,selfId,MD_EXAM_STARTTIME,New_Time_2)
		end

	else
		local msg = "Hi®n không tiªn hành thi khoa cØ"
		local cmsg = "R¶i khöi.."

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
		
	end

	local wenti = GetMissionData(sceneId,selfId,MD_EXAM_QUESTION)
	if wenti == 0 then
		--Ëæ»ú³ömµt cáiºÅÂë
		-- Èç¹ûÐúngÇ°5ÂÖ,¾ÍTÕi 4ÀïÍ·Ëæ»ú,ºóÃætoÕ ðµ TÕi 5ÖÐËæ»ú
		--  ðÕt ðßþcµ±Ç°ÐúngµÚ¼¸ÂÖ
		local nRing = x801016_Which_Examinant(sceneId, selfId, targetId)
		if nRing<=5  then
			wenti = GetRandomQuestionsIndex(4)
		else
			local rr = random(2)
			if rr == 1  then
				wenti = GetRandomQuestionsIndex(4)
			else
				wenti = GetRandomQuestionsIndex(5)
			end
		end
	end

	local con,opt0,opt1,opt2,opt3,opt4,opt5,key0,key1,key2,key3,key4,key5,sztype=GetQuestionsRecord(wenti)

	if con=="" then		--×¢ÒâÕâÀïÈç¹ûÑ¡ÏîÐúng¿ÕÔòÓÃ  ==""   À´ÅÐ¶Ï
		Msg2Player( sceneId,selfId,"Không tìm th¤y câu höi: "..wenti,MSG2PLAYER_PARA)
	end
	
	SetMissionData(sceneId,selfId,MD_EXAM_QUESTION,wenti)
	
	local key_position = {}
	--°ÑËûÃÇÎ»Ö giâyæ»úµô
	x801016_g_rand = random(0,2)
	if x801016_g_rand == 0 then
		key_position[0] = 1
		key_position[1] = 2
		key_position[2] = 0
		key_position[3] = -1
		key_position[4] = -1
		key_position[5] = -1
	elseif x801016_g_rand == 1 then
		key_position[0] = 2
		key_position[1] = 0
		key_position[2] = 1
		key_position[3] = -1
		key_position[4] = -1
		key_position[5] = -1
	else
		key_position[0] = 0
		key_position[1] = 1
		key_position[2] = 2
		key_position[3] = -1
		key_position[4] = -1
		key_position[5] = -1
	end

	--SetMissionData(sceneId,selfId,MD_EXAM_ASKTIME,New_Time)

	BeginUICommand(sceneId)
		UICommand_AddInt(sceneId,2)
		UICommand_AddInt(sceneId,Question_Sequence+1)
		UICommand_AddInt(sceneId,wenti)		
		UICommand_AddString(sceneId,con)
		UICommand_AddString(sceneId,opt0)
		UICommand_AddString(sceneId,opt1)
		UICommand_AddString(sceneId,opt2)
		UICommand_AddString(sceneId,opt3)
		UICommand_AddString(sceneId,opt4)
		UICommand_AddString(sceneId,opt5)
		UICommand_AddInt(sceneId,key_position[0])
		UICommand_AddInt(sceneId,key_position[1])
		UICommand_AddInt(sceneId,key_position[2])
		UICommand_AddInt(sceneId,key_position[3])
		UICommand_AddInt(sceneId,key_position[4])
		UICommand_AddInt(sceneId,key_position[5])
		UICommand_AddInt(sceneId,-1 )
		UICommand_AddInt(sceneId,Wrong_Times)
		UICommand_AddString(sceneId,sztype)

		if x801016_g_Switch == 1 and GetMissionData(sceneId,selfId,MD_EXAM_BRIBE_FLAG) == 1 then
			UICommand_AddInt(sceneId, 1 )
		else
			UICommand_AddInt(sceneId, 0 )
		end

		if x801016_g_Switch == 1 and GetMissionData(sceneId,selfId,MD_EXAM_FIGHT_FLAG) == 1 then
			UICommand_AddInt(sceneId, 1 )
		else
			UICommand_AddInt(sceneId, 0 )
		end
	UICommand_AddInt(sceneId, targetId )
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 28)
	return

end

--**********************************
--»Ø´ð
--**********************************
function x801016_AnswerQuestion( sceneId, selfId, Question, Answer1 )
	local times = GetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE)
	local Wrong_Times = mod(times,100)
	local Question_Sequence_Before = floor(times/100)
	local Question_Sequence = mod(Question_Sequence_Before,x801016_g_Count_Question)
	local Examinator_Sequence =   floor(Question_Sequence_Before/x801016_g_Count_Question)
	
	local Answer_List={}
	
	local wenti = GetMissionData(sceneId,selfId,MD_EXAM_QUESTION)
	if Question ~= wenti  then
		--PrintStr("Íæ¼ÒÌá½»toÕ ðµ ÎÊÌâ´íÎó,Ðúng²»ÐúngTÕi ×÷±×?")
		return
	end

	local con,opt0,opt1,opt2,opt3,opt4,opt5,key0,key1,key2,key3,key4,key5=GetQuestionsRecord(Question)
	Answer_List[0] = key0;
	Answer_List[1] = key1;
	Answer_List[2] = key2;
	Answer_List[3] = key3;
	Answer_List[4] = key4;
	Answer_List[5] = key5;

	local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)
		
	if Wrong_Times == 0 then
		local msg = "Th§t ðáng tiªc, ngß½i không còn c½ hµi trä l¶i lÕi. Hãy tiªp tøc n² lñc · kÏ thi sau"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
	end
	if Examinator_Sequence > x801016_g_Count_Examinant then
		Examinator_Sequence =   Examinator_Sequence - x801016_g_Count_Examinant
	end 
	if x801016_EstimationPhase( sceneId, selfId ) == 1 then
	
		if Examinator_Sequence+1 ~= x801016_Which_Examinant( sceneId, selfId, targetId ) then
			local msg = "Xin tìm v¸ thÑ"..tostring(Examinator_Sequence+1).."Thí sinh Ñng thi"
			local cmsg = "R¶i khöi.."
			CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, sceneId, x801016_g_Examinant_Position[Examinator_Sequence+1].x, x801016_g_Examinant_Position[Examinator_Sequence+1].z, x801016_g_Examinant_Name[Examinator_Sequence+1] )

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
	elseif x801016_EstimationPhase( sceneId, selfId ) == 2 then
	
		if x801016_Query_Candidate( sceneId, selfId ) == 0 then
			local msg = "Ngß½i không có tß cách tham gia cuµc thi tïnh"
			local cmsg = "R¶i khöi.."
	
			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
		
		if x801016_Which_Examinant( sceneId, selfId, targetId ) ~= 1 then
			local msg = "Xin m¶i thí sinh Ñng thi thÑ nh¤t"
			local cmsg = "R¶i khöi.."
			CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, sceneId, x801016_g_Examinant_Position[0+1].x, x801016_g_Examinant_Position[0+1].z, x801016_g_Examinant_Name[0+1] )

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end

	else
		local msg = "Hi®n không tiªn hành thi khoa cØ"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		
		return
	end
	
	if con=="" then		--×¢ÒâÕâÀïÈç¹ûÑ¡ÏîÐúng¿ÕÔòÓÃ  ==""   À´ÅÐ¶Ï
		Msg2Player( sceneId,selfId,"Không tìm ðßþc câu höi",MSG2PLAYER_PARA)
	end
	
	-- local asktime = GetMissionData(sceneId,selfId,MD_EXAM_ASKTIME)
	if Answer_List[Answer1-1] == 1 then
		--and LuaFnGetCurrentTime() - asktime < 35 then
		
		x801016_Answer_Right( sceneId, selfId )
		
	else

		x801016_Answer_Wrong( sceneId, selfId )
	
	end	
	
end

function x801016_Answer_Wrong( sceneId, selfId )
	local msg,cmsg
	local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)

	local times = GetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE)
	local Wrong_Times = mod(times,100)
	local Question_Sequence_Before = floor(times/100)
	local Question_Sequence = mod(Question_Sequence_Before,x801016_g_Count_Question)
	local Examinator_Sequence =   floor(Question_Sequence_Before/x801016_g_Count_Question)
	SetMissionData(sceneId,selfId,MD_EXAM_QUESTION,0)
	if Wrong_Times == 0 then
		msg = "Th§t ðáng tiªc, ngß½i không còn c½ hµi trä l¶i lÕi. Hãy tiªp tøc n² lñc · kÏ thi sau"
		cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
	end
	
	SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,times-1)
	local error_times = Wrong_Times - 1
	if error_times == 0 then
		msg = "Th§t ðáng tiªc, ngß½i không còn c½ hµi trä l¶i lÕi. Hãy tiªp tøc n² lñc · kÏ thi sau"
		cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
	else
		msg = "Xin l²i, thí sinh ðã ðáp sai, thí sinh không có"..error_times.."Nh¤t ð¸nh phäi n¡m giæ c½ hµi l¥n này"
		cmsg = "Chu¦n b¸ xong, b¡t ð¥u.."
	
		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 1)
	end
	return
end

function x801016_Answer_Right( sceneId, selfId )
	local times = GetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE)

	local Wrong_Times = mod(times,100)
	local Question_Sequence_Before = floor(times/100)
	local Question_Sequence = mod(Question_Sequence_Before,x801016_g_Count_Question)
	local Examinator_Sequence =   floor(Question_Sequence_Before/x801016_g_Count_Question)
	
	local starttime = GetMissionData(sceneId,selfId,MD_EXAM_STARTTIME)
	local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)
	
	if x801016_EstimationPhase(sceneId,selfId) == 2 then
		if x801016_Query_Candidate( sceneId, selfId ) == 0 then
			local msg = "Ngß½i không có tß cách tham gia cuµc thi tïnh"
			local cmsg = "R¶i khöi.."
		
			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
	end
	CallScriptFunction( SCENE_SCRIPT_ID, "PlaySoundEffect", sceneId, selfId, 66 )
	if Examinator_Sequence > x801016_g_Count_Examinant then
		Examinator_Sequence = Examinator_Sequence - x801016_g_Count_Examinant
	end 
		LuaFnSendSpecificImpactToUnit(sceneId,selfId,selfId,selfId,18,1000)
		
		SetMissionData(sceneId,selfId,MD_EXAM_QUESTION,0)
		
		x801016_Give_Premium( sceneId, selfId )
		
		local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)
		
		local ExamNPCName=GetName(sceneId,targetId)

		if Examinator_Sequence+1 >= x801016_g_Count_Examinant and Question_Sequence+1 == x801016_g_Count_Question and 
		   ExamNPCName == x801016_g_Examinant_Name[x801016_g_Count_Examinant] and x801016_EstimationPhase(sceneId,selfId) == 1 then
			local selfGuid = LuaFnObjId2Guid(sceneId,selfId)

			local current_time = LuaFnGetCurrentTime() - starttime
			local msg = "Chúc m×ng thí sinh ðã trä l¶i hªt m÷i ð« møc cüa kÏ thi châu, không biªt có l÷t ðßþc vào vòng thi huy®n hay không. Xin chú ý thông báo sau"
			local cmsg = "R¶i khöi.."

			local myname = GetName(sceneId,selfId)
			BroadMsgByChatPipe( sceneId,selfId,"#W#{_INFOUSR"..myname.."}#PTÕi µÚmµt ÂÖtoÕ ðµ Khoa cØµ±ÖÐË³ÀûtoÕ ðµ »Ø´ðÍêÈ«²¿toÕ ðµ ÌâÄ¿.",4) 
--			x801016_Add_To_Candidate( sceneId, selfId, current_time, selfGuid)
			x801016_Add_To_Candidate( sceneId, selfId, current_time, myname)
			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			SetMissionData(sceneId,selfId,MD_EXAM_BRIBE_FLAG,0)
			SetMissionData(sceneId,selfId,MD_EXAM_FIGHT_FLAG,0)
			SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,(x801016_g_Count_Examinant*x801016_g_Count_Question)*100+3)
			AuditCandidate(sceneId,selfId)                               --Í³¼ÆÍ¨¹ýµÚmµt ÂÖtoÕ ðµ ´ÎÊý add by Dengxianxi
		elseif x801016_EstimationPhase(sceneId,selfId) == 2 then
--			PrintNum(Question_Sequence)
			SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,times + 100)

			if Question_Sequence >= x801016_g_Count_Question -1 then
				local selfGuid = LuaFnObjId2Guid(sceneId,selfId)

				local current_time = LuaFnGetCurrentTime() - starttime
				local msg = "Xin chúc m×ng thí sinh ðã trä l¶i hªt m÷i ð« møc cüa cuµc thi tïnh. Sau ðây xin công b¯ Tam giáp"
				local cmsg = "R¶i khöi.."
--				PrintNum(current_time)
--				PrintNum(selfGuid)
				local myname = GetName(sceneId,selfId)
--				x801016_Add_To_Top( sceneId, selfId, current_time, selfGuid)
				x801016_Add_To_Top( sceneId, selfId, current_time, myname)
				x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
				return
			end
			
			x801016_AskQuestion(sceneId,selfId)

		elseif Question_Sequence >= x801016_g_Count_Question - 1 then
			SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,times + 101)
			SetMissionData(sceneId,selfId,MD_EXAM_BRIBE_FLAG,0)
			SetMissionData(sceneId,selfId,MD_EXAM_FIGHT_FLAG,0)
--dong yi ÈÃÎÒ¸ÉtoÕ ðµ 
			--local msg = "ÄútoÕ ðµ »Ø´ðÍêÈ«ÕýÈ·,ÇëÕÒÏÂmµt Î»¿¼¹ÙÓ¦ÊÔ.#rÄúÔö¼ÓÁËmµt ´ÎtoÕ ðµ ¿ÉÒÔ´ð´ítoÕ ðµ »ú»á.#rÏÂmµt cái¿¼¹ÙÎ»ÖÃTÕi ("..x801016_g_Examinant_Position[Examinator_Sequence+2].x..", "..x801016_g_Examinant_Position[Examinator_Sequence+2].z..")."
			local msg = "Câu trä l¶i cüa thí sinh hoàn toàn chính xác. Xin m¶i thí sinh tiªp theo. #r#rThí sinh ðã tång thêm c½ hµi trä l¶i sai. #r#rV¸ trí thí sinh tiªp theo · ("..x801016_g_Examinant_Position[Examinator_Sequence+2].x..", "..x801016_g_Examinant_Position[Examinator_Sequence+2].z..")"
			local cmsg = "R¶i khöi.."
			CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, sceneId, x801016_g_Examinant_Position[Examinator_Sequence+2].x, x801016_g_Examinant_Position[Examinator_Sequence+2].z, x801016_g_Examinant_Name[Examinator_Sequence+2] )

			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			
			x801016_JinBangTiMing( sceneId, selfId, targetId )
			
		else
--			if Question_Sequence == 0 then
--				SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,times + 101)
--			else
			SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,times + 100)
--			end

			x801016_AskQuestion(sceneId,selfId)
		end
end

function x801016_OnAccept_Imperial_Exam( sceneId, selfId )

	return 1
	
end

function x801016_GenPreminuTxt1(rr,szItem)
		local str = ""
		if rr == 1 then
			str = "#cff99ccTrong lúc thi khoa cØ, tìm mãi không th¤y bút ðâu, chï còn cách tìm #W#{_INFOMSG"..szItem.."}#cff99cc thay thª bút."
		elseif rr == 2 then
			str = "#cff99ccTrong lúc thi khoa cØ, phát hi®n trên bàn có 1#W#{_INFOMSG"..szItem.."}"
		elseif rr == 3 then
			str = "#cff99ccTrong lúc thi khoa cØ, phát hi®n trên bàn có 1#W#{_INFOMSG"..szItem.."}"
		end
		return str
end

function x801016_GenPreminuTxt2(rr,szItem)
		local str = ""
		if rr == 1 then
			str = "#cff99ccTrong lúc thi khoa cØ, do ðßþc quan chü khäo chú ý tr÷ng døng, ðßþc t£ng 1 #W#{_INFOMSG"..szItem.."}"
		elseif rr == 2 then
			str = "#cff99ccTrong lúc thi khoa cØ, phát hi®n trên bàn có 1#W#{_INFOMSG"..szItem.."}#cff99cc."
		elseif rr == 3 then
			str = "#cff99ccTrong lúc thi khoa cØ, phát hi®n trên bàn có 1#W#{_INFOMSG"..szItem.."}#cff99cc."
		end
		return str
end

function x801016_GenPreminuTxt3(type,rr,idItem)
		local str = ""
		if idItem == nil or idItem <= 0 then
			return str
		end
		if rr == 1 and type == 1 then
			str = "#cff99ccTrong lúc thi khoa cØ, tìm mãi không th¤y bút ðâu, chï còn cách tìm #W#{_ITEM"..idItem.."}#cff99cc thay thª bút. Tiªc là lúc ra khöi khäo trß¶ng, do tay näi ðã ð¥y, #{_ITEM"..idItem.."}b¸ Khäo Quan xung công r°i."
		elseif rr == 1 and type == 2 then
			str = "#cff99ccTrong lúc thi khoa cØ, do ðßþc quan chü khäo chú ý tr÷ng døng. Quan chü khäo dñ tính t£ng #W#{_ITEM"..idItem.."}#cff99cc 1 món, vì tay näi ðã ð¥y nên ðã thôi."
		else
			str = "#cff99ccTrong lúc thi khoa cØ, phát hi®n trên bàn có 1 #W#{_ITEM"..idItem.."}#cff99cc. Ðáng tiªc tay näi ðã ð¥y, mu¯n mang ði cûng mang không ðßþc."
		end
		return str
end

function x801016_Give_Premium( sceneId, selfId )
	local Player_Level = GetLevel( sceneId, selfId )
	local times = GetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE)
	local szItemTransfer = ""
	local myname = GetName(sceneId,selfId)

	local Wrong_Times = mod(times,100)
	local Question_Sequence_Before = floor(times/100)
	local Question_Sequence = mod(Question_Sequence_Before,x801016_g_Count_Question)
	local Examinator_Sequence =   floor(Question_Sequence_Before/x801016_g_Count_Question)
	
	--½±ÀøKinh nghi®m
	local PlayerMaxLevel = GetHumanMaxLevelLimit()
	if Player_Level <= PlayerMaxLevel and Player_Level >=10 then
		LuaFnAddExp(sceneId,selfId,x801016_g_Imperial_Exam_Hortation[Question_Sequence+1] * x801016_g_Imperial_Exam_Table[Player_Level].exp)
	end

	if	(random(1000) <= 1 and Examinator_Sequence < x801016_g_Count_Examinant)  then
		local rr = random(3)
		local reward_object
    local msg = "Các hÕ ðã ðã ðÕt ðßþc 1 "    --ÐÑÄ¿ÌáÊ¾ÓÃ
		
		if rr == 1 then
			local sum = getn(x801016_g_Reward_Punch)
			local rrr = random(sum)
			reward_object = x801016_g_Reward_Punch[rrr]
			msg = "Các hÕ ðã ðã ðÕt ðßþc 1 "
		elseif rr == 2 then
			local sum = getn(x801016_g_Reward_Gem)
			local rrr = random(sum)
			reward_object = x801016_g_Reward_Gem[rrr]
		elseif rr == 3 then
			reward_object = x801016_g_Reward_Reborn_Medicine
		end
		
		BeginAddItem(sceneId)
			AddItem( sceneId,reward_object, 1 )
		ret = EndAddItem(sceneId,selfId)
		if ret > 0 then
			AddItemListToHuman(sceneId,selfId)
			szItemTransfer = GetItemTransfer(sceneId,selfId,0)
			Msg2Player( sceneId,selfId,"Ngß½i"..x801016_GenPreminuTxt1(rr,szItemTransfer),MSG2PLAYER_PARA)
			BroadMsgByChatPipe( sceneId,selfId,"#{_INFOUSR"..myname.."}"..x801016_GenPreminuTxt1(rr,szItemTransfer),4)
			
			local itemName;
			_,itemName,_ = GetItemInfoByItemId(reward_object)
			
			--ÐÑÄ¿ÌáÊ¾
			x801016_MessageBox(sceneId,selfId,msg..itemName)
			
			--»î¶¯½±ÀøÍ³¼Æ
			LuaFnAuditItemCreate(sceneId,selfId,1,reward_object,itemName,"Khoa cØ")
			
			
		else
			BroadMsgByChatPipe( sceneId,selfId,"#{_INFOUSR"..myname.."}"..x801016_GenPreminuTxt3(1,rr,reward_object),4)
		end
	end
	
	if (random(1000) <= 100 and Examinator_Sequence >= x801016_g_Count_Examinant) then
		local rr = random(3)
		local reward_object
		local msg = "Các hÕ ðã ðã ðÕt ðßþc 1 "    --ÐÑÄ¿ÌáÊ¾ÓÃ
		
		if rr == 1 then
			local sum = getn(x801016_g_Reward_Craftsmanship)
			local rrr = random(sum)
			reward_object = x801016_g_Reward_Craftsmanship[rrr]
			msg = "Các hÕ ðã ðã ðÕt ðßþc 1 "
		elseif rr == 2 then
			reward_object = x801016_g_Reward_Prolong_Medicine
		elseif rr == 3 then
			reward_object = x801016_g_Reward_Reborn_Medicine
		end

		BeginAddItem(sceneId)
			AddItem( sceneId,reward_object, 1 )
		ret = EndAddItem(sceneId,selfId)
		if ret > 0 then
			AddItemListToHuman(sceneId,selfId)
			szItemTransfer = GetItemTransfer(sceneId,selfId,0)
			Msg2Player( sceneId,selfId,"Ngß½i"..x801016_GenPreminuTxt2(rr,szItemTransfer),MSG2PLAYER_PARA)
			BroadMsgByChatPipe( sceneId,selfId,"#{_INFOUSR"..myname.."}"..x801016_GenPreminuTxt2(rr,szItemTransfer),4)
			
			local itemName;
			_,itemName,_ = GetItemInfoByItemId(reward_object)
			
			--ÐÑÄ¿ÌáÊ¾
			x801016_MessageBox(sceneId,selfId,msg..itemName)
			
			--»î¶¯½±ÀøÍ³¼Æ
			LuaFnAuditItemCreate(sceneId,selfId,1,reward_object,itemName,"Khoa cØ")
		
		else
			BroadMsgByChatPipe( sceneId,selfId,"#{_INFOUSR"..myname.."}"..x801016_GenPreminuTxt3(2,rr,reward_object),4)
		end
		
	end
		
end


function x801016_OnOverTime( sceneId, selfId )
		x801016_Answer_Wrong( sceneId, selfId )
		return 1
end

function x801016_OnHandle_QuestUI( sceneId, selfId, targetId, NumText )

	if NumText == 0 then
		BeginUICommand(sceneId)
		EndUICommand(sceneId)
		DispatchUICommand(sceneId,selfId, 1000)
	elseif NumText ==1 then
		x801016_AskQuestion(sceneId,selfId)
	elseif NumText ==2 then
		x801016_OnHandle_Bribe(sceneId,selfId)
	elseif NumText == -1 then
		x801016_OnDefaultEvent( sceneId, selfId, targetId )
	end
end

function x801016_OnBribe(sceneId, selfId)
	local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)
	if GetMoney(sceneId, selfId)+ GetMoneyJZ(sceneId, selfId) < x801016_g_Bribe_Money then  --dengxx
		
		local msg = "Ngß½i còn nghèo h½n cä ta, hãy trä l¶i th§t ði!"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
	end
	
  --local msg = "²»´í²»´í,¿´À´ÄãºÍÆäËûÈË²»Í¬,¾ÓÈ»¶® ði¬mÒâË¼ÒâË¼,ÕâÑù°É,Èç¹ûÄãÔ¸Òâ¸¶#{_EXCHG"..tostring(10000).."},ÎÒ¾ÍËãÄãÕâÌâ¹ýÁË."
	--local cmsg = "ÎÒÒª¸¶#{_EXCHG"..tostring(10000).."}."
	--local cmsg2 = "Îmµt ¹Ðúng×Ô¼º»Ø´ð°É."
	local msg = "Khá l¡m khá l¡m, xem ra ngß½i khác v¾i nhæng ngß¶i khác, ðã hi¬u biªt nhß v§y. Thª này, nªu ngß½i ch¸u bö 1 ð°ng vàng, ta coi nhß ngß½i ðã qua ðßþc ð« này"
	local cmsg = "TÕi hÕ mu¯n trä 1 ð°ng vàng"
	local cmsg2 = "TÕi hÕ mu¯n tñ trä l¶i"

	BeginEvent(sceneId)

		AddText(sceneId,msg)
		AddNumText(sceneId,x801016_g_ScriptId,cmsg,6,2)
		AddNumText(sceneId,x801016_g_ScriptId,cmsg2,6,0)

	EndEvent(sceneId)
	DispatchEventList(sceneId,selfId,targetId)

end

function x801016_OnHandle_Bribe(sceneId, selfId)
	local msg,cmsg
	local jz,jb = LuaFnCostMoneyWithPriority(sceneId, selfId, x801016_g_Bribe_Money) 
	
	if jz == -1 then
			
		local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)
		local times = GetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE)
	
		SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,times-1)
		local error_times = mod(times-1, 100)
		if error_times == 0 then
			msg = "Ngß½i th§t to gan, ðªn cä quan ch¤m thi, ngß½i cûng dám ðùa giÞn, ð« này coi nhß ngß½i ðã ðáp sai, ngß½i ðã không còn c½ hµi trä l¶i næa, hãy tiªp tøc n² lñc cho kÏ thi sau"
			cmsg = "R¶i khöi.."
	
			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		else
			msg = "Ngß½i th§t to gan, ðªn cä quan ch¤m thi, ngß½i cûng dám ðùa giÞn, ð« này coi nhß ngß½i ðã ðáp sai, ngß½i vçn còn"..error_times.."Nh¤t ð¸nh phäi n¡m giæ c½ hµi l¥n này"
			cmsg = "Chu¦n b¸ xong, b¡t ð¥u.."
		
			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 1)
		end
		return
		
	end
	local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)
	if ( x801016_EstimationPhase( sceneId, selfId) ~= 2 ) and x801016_EstimationPhase( sceneId, selfId) ~= 1 then

		local msg = "Hi®n không tiªn hành thi khoa cØ"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
  end
  SetMissionData(sceneId,selfId,MD_EXAM_BRIBE_FLAG,1)
	x801016_Answer_Right( sceneId, selfId )
	
end

function x801016_OnHandle_Violence(sceneId, selfId)
	SetMissionData(sceneId,selfId,MD_EXAM_FLAG,0)
	local starttime = GetMissionData(sceneId,selfId,MD_EXAM_STARTTIME)
	local times = GetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE)
	local targetId = GetMissionData(sceneId,selfId,MD_EXAM_TARGETID)
	local Wrong_Times = mod(times,100)
	local Question_Sequence_Before = floor(times/100)
	local Question_Sequence = mod(Question_Sequence_Before,x801016_g_Count_Question)
	local Examinator_Sequence =   floor(Question_Sequence_Before/x801016_g_Count_Question)
	
	if ( x801016_EstimationPhase( sceneId, selfId) ~= 2 ) and x801016_EstimationPhase( sceneId, selfId) ~= 1 then

		local msg = "Hi®n không tiªn hành thi khoa cØ"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		return
  end
  SetMissionData(sceneId,selfId,MD_EXAM_FIGHT_FLAG,1)
  SetMissionData(sceneId,selfId,MD_EXAM_QUESTION,0)
  CallScriptFunction( SCENE_SCRIPT_ID, "PlaySoundEffect", sceneId, selfId, 66 )
	if x801016_EstimationPhase(sceneId,selfId) == 1 then
		x801016_Give_Premium( sceneId, selfId )
		if Examinator_Sequence >= x801016_g_Count_Examinant+1 then
			local selfGuid = LuaFnObjId2Guid(sceneId,selfId)

			local current_time = LuaFnGetCurrentTime() - starttime
			local msg = "Chúc m×ng thí sinh ðã trä l¶i hªt m÷i ð« møc cüa kÏ thi châu, không biªt có l÷t ðßþc vào vòng thi huy®n hay không. Xin chú ý thông báo sau"
			local cmsg = "R¶i khöi.."
			
			local myname = GetName(sceneId,selfId)
			BroadMsgByChatPipe( sceneId,selfId,"#{_INFOUSR"..myname.."}#cff99cc trong vòng khoa cØ ð¥u ðã thu§n lþi ðáp hªt m÷i ð« møc.",4) 

--			x801016_Add_To_Candidate( sceneId, selfId, current_time, selfGuid)
			x801016_Add_To_Candidate( sceneId, selfId, current_time, myname)
			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			SetMissionData(sceneId,selfId,MD_EXAM_BRIBE_FLAG,0)
			SetMissionData(sceneId,selfId,MD_EXAM_FIGHT_FLAG,0)
			SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,(x801016_g_Count_Question*x801016_g_Count_Examinant+1)*100+3)
			
			return
		end
		if Examinator_Sequence > x801016_g_Count_Examinant then
			Examinator_Sequence = Examinator_Sequence - x801016_g_Count_Examinant
		end 
		
		if Question_Sequence >= x801016_g_Count_Question - 1 then
			SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,times + 101)
			SetMissionData(sceneId,selfId,MD_EXAM_BRIBE_FLAG,0)
			SetMissionData(sceneId,selfId,MD_EXAM_FIGHT_FLAG,0)
			
			x801016_JinBangTiMing( sceneId, selfId, targetId )
			
		else
			SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,times + 100)
		end
		
		local msg = "Xem ra ngß½i cûng có bän bînh, ð« này coi nhß ngß½i ðã qua"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
		
	elseif x801016_EstimationPhase(sceneId,selfId) == 2 then
	
		if x801016_Query_Candidate( sceneId, selfId ) == 0 then
			local msg = "Ngß½i không có tß cách tham gia cuµc thi tïnh"
			local cmsg = "R¶i khöi.."
	
			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
		x801016_Give_Premium( sceneId, selfId )
		SetMissionData(sceneId,selfId,MD_EXAM_SEQUENCE,times + 100)

		if Examinator_Sequence >= x801016_g_Count_Examinant+1 then
			local selfGuid = LuaFnObjId2Guid(sceneId,selfId)

			local current_time = LuaFnGetCurrentTime() - starttime
			local msg = "Xin chúc m×ng thí sinh ðã trä l¶i hªt m÷i ð« møc cüa cuµc thi tïnh. Sau ðây xin công b¯ Tam giáp"
			local cmsg = "R¶i khöi.."
			local myname = GetName(sceneId,selfId)
--			x801016_Add_To_Top( sceneId, selfId, current_time, selfGuid)
			x801016_Add_To_Top( sceneId, selfId, current_time, myname)
			x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
			return
		end
		if Question_Sequence >= x801016_g_Count_Question - 1 then
			SetMissionData(sceneId,selfId,MD_EXAM_FIGHT_FLAG,0)
		end
		
		local msg = "Xem ra ngß½i cûng có bän bînh, ð« này coi nhß ngß½i ðã qua"
		local cmsg = "R¶i khöi.."

		x801016_Client_Show_Message( sceneId, selfId, targetId, msg, cmsg, 0)
	end
end

function x801016_Client_Show_Message( sceneId, selfId, targetId, Message, CloseMessage, NumText)

	BeginEvent(sceneId)

		AddText(sceneId,Message)
		AddNumText(sceneId,x801016_g_ScriptId,CloseMessage,4,NumText)

	EndEvent(sceneId)
	DispatchEventList(sceneId,selfId,targetId)
	
end

--**********************************
--³ÆºÅÊÚÓè
--**********************************
function x801016_MyAwardTitle( sceneId, selfId, place )

	if place < 1 or place > 3 then
		return
	end
	local	lstTitle	=
	{
		139,	--×´Ôª
		140,	--°ñÑÛ
		141,	--Ì½»¨
	}
	local	curTitle	= GetTitle( sceneId, selfId, 4 )
	local	newTitle	= lstTitle[ place ]
	if curTitle > 0 then
		--½ö±£ÁôÈ¨ÖØ¸ßtoÕ ðµ ³ÆºÅ
		if newTitle <= curTitle then
			DeleteTitle( sceneId, selfId, 4 )
			AwardTitle( sceneId, selfId, 4, newTitle, 24 * 7 )	--ÓÐÐ§ÆÚ: mµt ÖÜ
			SetCurTitle( sceneId, selfId, 4, newTitle )
		end
	else
		AwardTitle( sceneId, selfId, 4, newTitle, 24 * 7 )		--ÓÐÐ§ÆÚ: mµt ÖÜ
		SetCurTitle( sceneId, selfId, 4, newTitle )
	end
	LuaFnDispatchAllTitle( sceneId, selfId )

end

--**********************************
--·¢·Å½ð°ñÌâÃû½±ÀøÎïÆ·
--**********************************
function x801016_JinBangTiMing( sceneId, selfId, targetId )

	local NPCName=GetName(sceneId, targetId)	
	-- ±ØÐëTÕi ¿¼¹Ùmµt ²ÅÄÜLînh 
	if NPCName ~= x801016_g_Examinant_Name[1] then
		return 0
	end
	
	local MyLevel = GetLevel( sceneId, selfId )
	-- Íæ¼Ò±ØÐëTÕi 40c¤pÒÔÉÏ	
	if MyLevel < 40 then
		return 0
	end
	
	-- ±³°ü±ØÐë»¹ÓÐ¿Õ¼ä
	BeginAddItem( sceneId )
	AddItem( sceneId, x801016_g_Jiangli_JinBang, 1 )
	space = EndAddItem( sceneId, selfId )
		
	if space <= 0 then
		return 0
	end
	
	-- ½±Àø½ð°ñÌâÃû
	local bagpos = TryRecieveItem( sceneId, selfId, x801016_g_Jiangli_JinBang, QUALITY_MUST_BE_CHANGE )	-- ·Å²»ÏÂ¾ÍÃ»ÓÐÁË
	local itemInfo = GetBagItemTransfer( sceneId, selfId, bagpos )
	
	x801016_MessageBox( sceneId, selfId, "Các hÕ hôm nay ðã n¯ lñc hªt mình r°i, chúc m×ng các hÕ ðoÕt giäi nh¤t!" )

end

--**********************************
--ÐÑÄ¿ÐÅÏ¢ÌáÊ¾
--**********************************
function x801016_MessageBox( sceneId, selfId, msg )
	BeginEvent( sceneId )
      AddText( sceneId, msg )
  EndEvent( sceneId )
  DispatchMissionTips( sceneId, selfId )		
end
