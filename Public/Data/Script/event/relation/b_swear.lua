-- ½á°ÝÈÎÎñ

--½Å±¾ºÅ
x806001_g_ScriptId = 806001

--½á°ÝÐèÒªµÄ½ðÇ®
x806001_g_NeedMoney = 100000
x806001_g_DrawTitleNeedMoney = 50000
x806001_g_ChangeTitleNeedMoney = 10000

--ÌáÊ¾ÐÅÏ¢
x806001_g_msg_swear					= {}
x806001_g_msg_swear["swr"]	= "Kªt bái"
x806001_g_msg_swear["tit"]	= "Nh§n danh hi®u"
x806001_g_msg_swear["chr"]	= "SØa danh hi®u cá nhân"
x806001_g_msg_swear["tem"]	= "Ngß½i c¥n phäi cùng nhóm ngß¶i mà ngß½i mu¯n kªt bái t¾i tìm ta trß¾c, ta m¾i có th¬ làm chü trì nghi l­ kªt bái cho ngß½i"
x806001_g_msg_swear["ten"]	= "Nhóm cüa ngß½i có ngß¶i ðang ngoài thành LÕc Dß½ng, nên ta không th¬ chü trì nghi thÑc kªt bái"
x806001_g_msg_swear["cap"]	= "Chï có ðµi trß·ng m¾i có th¬ hoàn thành thao tác kªt bái"
x806001_g_msg_swear["mar"]	= "Giæa phu thê không th¬ kªt bái. Các ngß½i hãy v« ði"
x806001_g_msg_swear["mat"]	= "Giæa sß ð° không th¬ kªt bái. Các ngß½i hãy v« ði"
x806001_g_msg_swear["fri"]	= "Chï có bÕn hæu m¾i có th¬ kªt bái. Các ngß½i c¥n phäi tång cß¶ng tình hæu häo trß¾c"
x806001_g_msg_swear["all"]	= "T¤t cä huynh ð® kªt bái c¥n phäi cùng lúc có m£t trong nhóm m¾i có th¬ gia nh§p thêm huynh ð® kªt bái m¾i"
x806001_g_msg_swear["one"]	= "Các ngß½i ðã là huynh ð® kªt bái r°i. Không c¥n phäi kªt bái l¥n næa ð¬ tång tình hæu ngh¸"
x806001_g_msg_swear["alr"]	= "A trong ðµi cüa ngß½i ðã t×ng kªt bái, nên ta không th¬ kªt bái cho các ngß½i"
x806001_g_msg_swear["frd"]	= "Nªu các ngß½i mu¯n kªt bái, ta có th¬ chü trì nghi l­ kªt bái, viªt Kim Lan Ph±. Nhßng trß¾c ðó, ta c¥n phäi xác ð¸nh ðµ hæu häo giæa các ngß½i ðã ðÕt ðßþc 1000 ði¬m"
x806001_g_msg_swear["mon"]	= "Tiªn hành nghi thÑc kªt bái c¥n t¯n #{_MONEY%d}, ngß½i xác ð¸nh có c¥n kªt bái không? "
x806001_g_msg_swear["nom"]	= "Ngân lßþng cüa các hÕ không ðü #{_MONEY%d}"
x806001_g_msg_swear["con"]	= "Huynh ð® kªt bái, t× nay có phúc cùng hß·ng, có nÕn cùng chia. Các ngß½i thñc sñ mu¯n kªt bái không?"
x806001_g_msg_swear["chn"]	= "Nhóm cüa ngß½i ðã có thay ð±i, nên ta không th¬ chü trì nghi l­ kªt bái"
x806001_g_msg_swear["bul"]	= "Hoàng thiên tÕi thßþng, h§u th± tÕi hÕ. T× hôm nay các ngß½i kªt bái làm huynh ð®, t× nay có phúc cùng hß·ng, có nÕn cùng chia. Tuy không sinh cùng ngày, cùng tháng, cùng nåm, nhßng nguy®n ðßþc chªt cùng nåm, cùng tháng, cùng ngày. Thiên hÕ anh hùng, hãy chúc m×ng h÷!"
x806001_g_msg_swear["pro"]	= "Chúc m×ng chß v¸, các ngß½i ðã tr· thành huynh ð® kªt bái. Xin ðµi trß·ng ra lãnh xßng danh kªt bái"
x806001_g_msg_swear["caa"]	= "C¥n l§p nhóm v¾i t¤t cä huynh ð® kªt bái v¾i ngß½i m¾i có th¬ lînh nh§n xßng danh kªt bái"
x806001_g_msg_swear["cac"]	= "Chï có ðµi trß·ng m¾i ðßþc lãnh xßng danh kªt bái"
x806001_g_msg_swear["cas"]	= "Ngß½i vçn chßa ðßþc kªt bái, không th¬ lãnh xßng danh kªt bái"
x806001_g_msg_swear["cab"]	= "Trong nhóm cüa ngß½i có ngß¶i không phäi là huynh ð® kªt bái v¾i ngß½i"
x806001_g_msg_swear["cat"]	= "Ngß½i ðã t×ng lãnh danh xßng kªt bái"
x806001_g_msg_swear["can"]	= "Ngß½i chßa t×ng lãnh danh xßng kªt bái, không th¬ sØa danh xßng kªt bái"
x806001_g_msg_swear["ccs"]	= "Ngß½i ðã t×ng lãnh danh xßng kªt bái, không th¬ sØa danh xßng kªt bái"
x806001_g_msg_swear["nmm"]	= "SØa danh hi®u kªt bái c¥n có #{_MONEY%d}, ngân lßþng hi®n có trên ngß¶i các hÕ không ðü"
x806001_g_msg_swear["ner"]	= "Khoäng cách giæa ta và ngß½i quá xa, ta không th¬ chü trì nghi l­ kªt bái cho các ngß½i ðßþc"
x806001_g_msg_swear["nel"]	= "Nhóm cüa ngß½i ðang kªt bái, nhßng khoäng cách giæa ta và ngß½i quá xa, ta không th¬ chü trì nghi l­ kªt bái cho các ngß½i ðßþc"
x806001_g_msg_swear["wait"]	= "Hãy thØ lÕi mµt lát sau."

--Key for AddNumText
x806001_g_key					= {}
x806001_g_key["swear"]	= 10000	--½á°ÝÁ÷³Ì
x806001_g_key["allow"]	= 10001	--È·¶¨½á°Ý»¨·Ñ½çÃæ
x806001_g_key["unall"]	= 10002	--È¡Ïû½á°Ý»¨·Ñ½çÃæ
x806001_g_key["confi"]	= 10003	--È·¶¨½á°ÝÍ¬Òâ½çÃæ
x806001_g_key["uncon"]	= 10004	--È¡Ïû½á°ÝÍ¬Òâ½çÃæ
x806001_g_key["title"]	= 20000	--ÁìÈ¡³ÆºÅ
x806001_g_key["chrti"]	= 30000	--ÐÞ¸Ä³ÆºÅ

--**********************************
--ÈÎÎñÈë¿Úº¯Êý
--**********************************
function x806001_OnDefaultEvent( sceneId, selfId, targetId )
	local	key	= GetNumText()
	
	-- ¼ì²éÊÇ·ñ·ûºÏÌõ¼þ
	if key == x806001_g_key["swear"] then
		if x806001_CheckAccept( sceneId, selfId, targetId ) == 0 then
			return 0
		end
		x806001_LogTeamInfo( sceneId, selfId, targetId )
		x806001_OnSubmit( sceneId, selfId, targetId )
		return 1
	end
	
	--È·ÈÏ»¨·Ñ
	if key == x806001_g_key["allow"] then
		--local money
		--money = LuaFnGetMoney( sceneId, selfId )
		--hzp 2008-12-9
		local nMoneyJZ = GetMoneyJZ(sceneId, selfId);
		local nMoneyJB = LuaFnGetMoney(sceneId, selfId);
		local nMoneySelf = nMoneyJZ + nMoneyJB;
		if nMoneySelf < x806001_g_NeedMoney then	
			local msg	= format( x806001_g_msg_swear["nom"], x806001_g_NeedMoney )
			x806001_MessageBox( sceneId, selfId, targetId, msg )
			return 0
		end
		x806001_OnConfirm( sceneId, selfId, targetId )
		return 1
	end
	
	--È¡Ïû»¨·Ñ
	if key == x806001_g_key["unall"] then
		BeginUICommand( sceneId )
		UICommand_AddInt( sceneId, targetId )
		EndUICommand( sceneId )
		DispatchUICommand( sceneId, selfId, 1000 )
		return 1
	end
	
	--Í¬Òâ½á°Ý
	if key == x806001_g_key["confi"] then
		--¼ÇÂ¼ÐÅÏ¢
		x806001_AgreeSwear( sceneId, selfId, targetId )
		
		--¹Ø±Õ´°¿Ú
		BeginUICommand( sceneId )
		UICommand_AddInt( sceneId, targetId )
		EndUICommand( sceneId )
		DispatchUICommand( sceneId, selfId, 1000 )
		
		--²é¿´ÊÇ·ñËùÓÐµÄ¶ÓÔ±¶¼Í¬ÒâÁË
		if x806001_CheckIfAllAgreeSwear( sceneId, selfId, targetId ) == 1 then
			x806001_DoSwear( sceneId, selfId, targetId )
		else
			x806001_WaitSwear( sceneId, selfId, targetId )
		end
		return 1
	end

	--²»Í¬Òâ½á°Ý
	if key == x806001_g_key["uncon"] then
		x806001_QuitSwear( sceneId, selfId, targetId )
		return 1
	end
	
	--ÁìÈ¡³ÆºÅ
	if key == x806001_g_key["title"] then
		local TeamSize = x806001_CheckDrawTitle( sceneId, selfId, targetId )
		if TeamSize == 0 then
			return 0
		end
		
		--¼ÇÂ¼¶ÓÎéÐÅÏ¢
		x806001_LogTeamInfo( sceneId, selfId, targetId )
		
		--ÁìÈ¡½á°Ý³ÆºÅ
		LuaFnDrawJieBaiName( sceneId, selfId, TeamSize )
		return 1
	end
	
	--ÐÞ¸Ä¸öÈË³ÆºÅ
	if key == x806001_g_key["chrti"] then
		if x806001_CheckChangeTitle( sceneId, selfId, targetId ) == 0 then
			return 0
		end
		
		--ÐÞ¸Ä½á°Ý³ÆºÅ
		LuaFnChangeJieBaiName( sceneId, selfId, TeamSize )
		return 1
	end

	return 0
end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x806001_OnEnumerate( sceneId, selfId, targetId )
	AddNumText( sceneId, x806001_g_ScriptId, x806001_g_msg_swear["swr"], 6, x806001_g_key["swear"] )
	AddNumText( sceneId, x806001_g_ScriptId, x806001_g_msg_swear["tit"], 6, x806001_g_key["title"] )
	AddNumText( sceneId, x806001_g_ScriptId, x806001_g_msg_swear["chr"], 6, x806001_g_key["chrti"] )
end

--**********************************
--¼ì²â½ÓÊÜÌõ¼þ
--**********************************
function x806001_CheckAccept( sceneId, selfId, targetId )

	--(1)ÊÇ·ñ×é¶Ó
	if LuaFnHasTeam( sceneId, selfId ) == 0 then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["tem"] )
		return 0
	end
	
	--È¡¶ÓÎéÈËÊý£¬ÈËÊý²»ÄÜÊÇ1¸ö
	local TeamSize = LuaFnGetTeamSize( sceneId, selfId )
	TotalTeamNum = TeamSize
	if TeamSize == 1 then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["tem"] )
		return 0
	end

	--È¡Í¬³¡¾°¶ÓÎéÈËÊý
	local TeamSizeSameScene = LuaFnGetTeamSceneMemberCount( sceneId, selfId )
	if TeamSizeSameScene+1 ~= TeamSize then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["ten"] )
		return 0
	end

	--(2)ÊÇ·ñ¶Ó³¤
	if LuaFnIsTeamLeader( sceneId, selfId ) ~= 1 then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["cap"] )
		return 0
	end
	
	--(3)¾àÀëÊÇ·ñºÏÊÊ
	if IsInDist( sceneId, selfId, targetId, 6 ) ~= 1 then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["ner"] )
		return 0
	end
	
	--(4)¶ÓÔ±ÖÐÊÇ·ñ´æÔÚ·òÆÞ¡¢Ê¦Í½¡¢½á°Ý¡¢·ÇºÃÓÑ¹ØÏµ
	local i = 0
	local j = 0
	local theID = 0
	local otherID = 0
	local Friend1 = 0
	local Friend2 = 0
	local Brothers = 0
	local BrotherNum = LuaFnIsSweared(sceneId, selfId) --¶Ó³¤ÊÇ·ñ½á°Ý¹ý
	while i < TeamSizeSameScene do
		theID = LuaFnGetTeamSceneMember( sceneId, selfId, i )

		--ÊÇ·ñ·òÆÞ
		if LuaFnIsSpouses(sceneId, selfId, theID) == 1 then
			x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["mar"] )
			return 0
		end

		--ÊÇ·ñÊ¦¸¸
		if LuaFnIsMaster(sceneId, selfId, theID) == 1 then
			x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["mat"] )
			return 0
		end

		--ÊÇ·ñÍ½µÜ
		if LuaFnIsPrentice(sceneId, theID, selfId) == 1 then
			x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["mat"] )
			return 0
		end

		--ÊÇ·ñºÃÓÑ
		if LuaFnIsFriend(sceneId, selfId, theID) == 0 then
			x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["fri"] )
			return 0
		end
		if LuaFnIsFriend(sceneId, theID, selfId) == 0 then
			x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["fri"] )
			return 0
		end

		--ÓÑºÃ¶ÈÊÇ·ñ>=1000
		Friend1 = LuaFnGetFriendPoint( sceneId, selfId, theID )
		Friend2 = LuaFnGetFriendPoint( sceneId, theID, selfId )
		if Friend1 < 1000 or Friend2 < 1000 then
			x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["frd"] )
			return 0
		end
		
		--¾àÀëÊÇ·ñºÏÊÊ
		if IsInDist( sceneId, theID, targetId, 6 ) ~= 1 then
			local	theName	= LuaFnGetName( sceneId, theID )
			x806001_MessageBox( sceneId, selfId, targetId, "T± ðµi cüa các hÕ có #R" .. theName .. "#W cách ta quá xa, nên ta không th¬ kªt bái cho các ngß½i" )
			x806001_MessageBox( sceneId, theID, targetId, x806001_g_msg_swear["nel"] )
			return 0
		end

		--ÊÇ·ñÒÑ¾­ÓÐ½á°Ý¹ØÏµ
		local theSwear = LuaFnIsSweared(sceneId, theID)
		if theSwear > 0 then --¶ÓÔ±ÓÐ½á°Ý¹ØÏµ
			if BrotherNum > 0 then --¶Ó³¤ÓÐ½á°Ý¹ØÏµ
				if LuaFnIsBrother(sceneId, selfId, theID) == 0 then
					local	theName	= LuaFnGetName( sceneId, theID )
					x806001_MessageBox( sceneId, selfId, targetId, "T± ðµi cüa các hÕ có " .. theName .. " Ðã là huynh ð® kªt bái cüa ngß¶i khác, ta không tài nào chü trì nghi l­ kªt bái cho các ngß½i ðßþc" )
					return 0
				end
			else
				local	theName	= LuaFnGetName( sceneId, theID )
				x806001_MessageBox( sceneId, selfId, targetId, "T± ðµi cüa các hÕ có " .. theName .. " Ðã là huynh ð® kªt bái cüa ngß¶i khác, ta không tài nào chü trì nghi l­ kªt bái cho các ngß½i ðßþc" )
			end
		end
		
		--Èç¹û¶Ó³¤ÒÑ¾­ÓÐ½á°Ý¹ØÏµ£¬½«¶ÓÎéÖÐËùÓÐµÄÓë¶Ó³¤ÊÇÐÖµÜµÄÈË·Åµ½DICÀïÃæÈ¥
		if theSwear > 0 and BrotherNum > 0 then
			Brothers = Brothers + 1
		end

		--±éÀú¶ÓÔ±
		j = i
		while j < TeamSizeSameScene do
			otherID = LuaFnGetTeamSceneMember( sceneId, theID, j )
			if LuaFnIsSpouses(sceneId, theID, otherID) == 1 then
				x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["mar"] )
				return 0
			end
			if LuaFnIsMaster(sceneId, theID, otherID) == 1 then
				x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["mat"] )
				return 0
			end
			if LuaFnIsPrentice(sceneId, otherID, theID) == 1 then
				x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["mat"] )
				return 0
			end
			if LuaFnIsFriend(sceneId, theID, otherID) == 0 then
				x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["fri"] )
				return 0
			end
			if LuaFnIsFriend(sceneId, otherID, theID) == 0 then
				x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["fri"] )
				return 0
			end
			Friend1 = LuaFnGetFriendPoint( sceneId, theID, otherID )
			Friend2 = LuaFnGetFriendPoint( sceneId, otherID, theID )
			if Friend1 < 1000 or Friend2 < 1000 then
				x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["frd"] )
				return 0
			end
			j = j + 1
		end
		i = i + 1
	end
		
	--(5)Èç¹û¶Ó³¤ÓÐ½á°Ý¹ØÏµ£¬¿´¿´ËùÓÐµÄÐÖµÜÊÇ·ñ¶¼ÔÚÕâ¸ö¶ÓÎéÀïÃæ
	if BrotherNum > 0 then
		-- ÐÖµÜÊýµÈÓÚÍ¬³¡¾°µÄ¶ÓÔ±Êý
		if BrotherNum == Brothers then
			if BrotherNum == TeamSizeSameScene then
				x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["one"] )
				return 0
			end
		else
			x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["all"] )
			return 0
		end
	end
	
	return 1

end

--**********************************
--¶Ô»°´°¿ÚÐÅÏ¢ÌáÊ¾
--**********************************
function x806001_MessageBox( sceneId, selfId, targetId, msg )
	BeginEvent( sceneId )
		AddText( sceneId, msg )
	EndEvent( sceneId )
	DispatchEventList( sceneId, selfId, targetId )
end

--**********************************
--¶Ô»°´°¿ÚÐÅÏ¢ÌáÊ¾
--**********************************
function x806001_ConfirmSwear( sceneId, selfId, targetId )
	BeginEvent( sceneId )
		AddText( sceneId, x806001_g_msg_swear["con"] )
		AddNumText( sceneId, x806001_g_ScriptId, "Xác nh§n kªt bái", 6, x806001_g_key["confi"] )
		AddNumText( sceneId, x806001_g_ScriptId, "Ta không mu¯n kªt bái næa", 8, x806001_g_key["uncon"] )
	EndEvent( sceneId )
	DispatchEventList( sceneId, selfId, targetId )
end

--**********************************
--È·ÈÏ»¨·Ñ¶Ô»°´°¿Ú
--**********************************
function x806001_OnSubmit( sceneId, selfId, targetId )
	BeginEvent( sceneId )
		local msg	= format( x806001_g_msg_swear["mon"], x806001_g_NeedMoney )
		AddText( sceneId, msg )
		AddNumText( sceneId, x806001_g_ScriptId, "Xác nh§n", 6, x806001_g_key["allow"] )
		AddNumText( sceneId, x806001_g_ScriptId, "Hüy bö", 8, x806001_g_key["unall"] )
	EndEvent( sceneId )
	DispatchEventList( sceneId, selfId, targetId )
end

--**********************************
--È·ÈÏÍ¬Òâ¶Ô»°´°¿Ú
--**********************************
function x806001_OnConfirm( sceneId, selfId, targetId )
	x806001_ConfirmSwear( sceneId, selfId, targetId )

	local i = 0
	local TeamSizeSameScene = LuaFnGetTeamSceneMemberCount( sceneId, selfId )
	while i < TeamSizeSameScene do
		x806001_ConfirmSwear( sceneId, LuaFnGetTeamSceneMember( sceneId, selfId, i ), targetId )
		i = i + 1
	end
end

--**********************************
--¼ÇÂ¼¶ÓÎéÐÅÏ¢
--**********************************
function x806001_LogTeamInfo( sceneId, selfId, targetId )
	LuaFnTeamSnapshort( sceneId, selfId )
	local i = 0
	local TeamSizeSameScene = LuaFnGetTeamSceneMemberCount( sceneId, selfId )
	while i < TeamSizeSameScene do
		LuaFnTeamSnapshort( sceneId, LuaFnGetTeamSceneMember( sceneId, selfId, i ) )
		i = i + 1
	end
end

--**********************************
--·ÅÆú½á°Ý
--**********************************
function x806001_QuitSwear( sceneId, selfId, targetId )

	--¹Ø±Õ×Ô¼ºµÄ´°¿Ú
	BeginUICommand( sceneId )
	UICommand_AddInt( sceneId, targetId )
	EndUICommand( sceneId )
	DispatchUICommand( sceneId, selfId, 1000 )
	
	--¸øÆäËûÈË·¢ÏûÏ¢
	local TeamLeaderID = GetTeamLeader( sceneId, selfId )
	if TeamLeaderID ~= nil then
		local i = 0
		local TeamSizeSameScene = LuaFnGetTeamSceneMemberCount( sceneId, TeamLeaderID )
		local	msg = LuaFnGetName( sceneId, selfId ) .. " mu¯n kªt bái v¾i các hÕ!"
		if TeamLeaderID ~= selfId then
			x806001_MessageBox( sceneId, selfId, targetId, msg )
			x806001_MessageBox( sceneId, TeamLeaderID, targetId, msg )
		end
		while i < TeamSizeSameScene do
			local theID = LuaFnGetTeamSceneMember( sceneId, TeamLeaderID, i )
			if theID ~= selfId then
				x806001_MessageBox( sceneId, selfId, targetId, msg )
				x806001_MessageBox( sceneId, theID, targetId, msg )
			end
			i = i + 1
		end
	end
end

--**********************************
--¼ÇÂ¼Í¬Òâ½á°ÝÐÅÏ¢
--**********************************
function x806001_AgreeSwear( sceneId, selfId, targetId )
	LuaFnAgreeSwear( sceneId, selfId, selfId )
	local i = 0
	local TeamSizeSameScene = LuaFnGetTeamSceneMemberCount( sceneId, selfId )
	while i < TeamSizeSameScene do
		local theID = LuaFnGetTeamSceneMember( sceneId, selfId, i )
		LuaFnAgreeSwear( sceneId, theID, selfId )
		i = i + 1
	end
end

--**********************************
--²é¿´ÊÇ·ñËùÓÐÈË¶¼Í¬Òâ½á°Ý
--**********************************
function x806001_CheckIfAllAgreeSwear( sceneId, selfId, targetId )
	--¼ì²éÊÇ·ñËùÓÐÈË¶¼Í¬ÒâÁË
	if LuaFnIfAllTeamAgreeSwear(sceneId, selfId) == 0 then
		return 0
	end
	local i = 0
	local TeamSizeSameScene = LuaFnGetTeamSceneMemberCount( sceneId, selfId )
	while i < TeamSizeSameScene do
		local theID = LuaFnGetTeamSceneMember( sceneId, selfId, i )
		if LuaFnIfAllTeamAgreeSwear(sceneId, theID) == 0 then
			return 0
		end
		i = i + 1
	end
	return 1
end

--**********************************
--ÕæÊµµÄ½á°Ý²Ù×÷
--**********************************
function x806001_DoSwear( sceneId, selfId, targetId )
	local TeamLeaderID = GetTeamLeader( sceneId, selfId )
	
	--¶Ó³¤Ã»ÁË:(
	if TeamLeaderID == nil then
		return 0
	end
	
	local BrotherNum = LuaFnIsSweared(sceneId, TeamLeaderID)
	local TeamSizeSameScene = LuaFnGetTeamSceneMemberCount( sceneId, TeamLeaderID )
	
	--¼ì²éÊÇ·ñÒÑ¾­×é¶ÓÁË
	if BrotherNum == TeamSizeSameScene then
		return 0
	end

	--¼ì²é¶ÓÎéÊÇ·ñÓÐ±ä»¯
	if LuaFnVerifyTeamWithSnapshort( sceneId, TeamLeaderID ) == 0 then
		x806001_MessageBox( sceneId, TeamLeaderID, targetId, x806001_g_msg_swear["chn"] )
		return 0
	end
	
	--²é¿´¶ÓÔ±¼ä¹ØÏµÊÇ·ñÓÐ±ä»¯
	if x806001_CheckAccept( sceneId, TeamLeaderID, targetId ) == 0 then
		x806001_MessageBox( sceneId, TeamLeaderID, targetId, x806001_g_msg_swear["chn"] )
		return 0
	end
	
	--¼ì²é³É¹¦ÁË£¬¸Ï½ô¿ÛÑ¾10¸ö½ð×Ó
	--local Cost = LuaFnCostMoney( sceneId, TeamLeaderID, 100000 )
	--hzp 2008-12-9
	local jzCost, jbCost = LuaFnCostMoneyWithPriority( sceneId, TeamLeaderID, 100000 );	
	
	--Ã»¿Û³É¹¦£¿£¿
	--if Cost == nil or Cost <= 0 then
	if jzCost == -1 then
		local msg	= format( x806001_g_msg_swear["nom"], x806001_g_NeedMoney )
		x806001_MessageBox( sceneId, TeamLeaderID, targetId, msg )
		return 0
	end
	
	local Names = LuaFnGetName( sceneId, TeamLeaderID )
	
	--ÐÞ¸Ä¶Ó³¤ºÃÓÑÁÐ±í
	LuaFnAllTeamSwear( sceneId, TeamLeaderID )
	
	--ÐÞ¸ÄÆäËûÈËºÃÓÑÁÐ±í
	local i = 0
	while i < TeamSizeSameScene do
		local theID = LuaFnGetTeamSceneMember( sceneId, TeamLeaderID, i )
		LuaFnAllTeamSwear( sceneId, theID )
		Names = Names .. ",".. LuaFnGetName( sceneId, theID )
		i = i + 1
	end
	
	--ÈÃ¶Ó³¤Áì³ÆºÅ
	x806001_MessageBox( sceneId, TeamLeaderID, targetId, x806001_g_msg_swear["pro"] )
	i = 0
	while i < TeamSizeSameScene do
		local theID = LuaFnGetTeamSceneMember( sceneId, TeamLeaderID, i )
		x806001_MessageBox( sceneId, theID, targetId, x806001_g_msg_swear["pro"] )
		i = i + 1
	end
	
 		--ÏµÍ³¹ã²¥ÏûÏ¢
	local leaderObjId = selfId;
	local sAllUserName="";
		
	local TeammateCount = GetTeamMemberCount( sceneId, selfId );	
	local sUserName;

	local	nearteammembercount = GetNearTeamCount( sceneId, selfId) 
	for	i=0,nearteammembercount-1 do
		local idMem = GetNearTeamMember(sceneId, selfId, i)
		sUserName = GetName(sceneId, idMem);				
		local sUserName2 = format("#B#{_INFOUSR%s}#Y", sUserName);		
		sAllUserName = sAllUserName..sUserName2;		
		if i ~= nearteammembercount-1 then
			sAllUserName = sAllUserName.."¡¢"
		end			
	end
			
	local sMessage = format("#{JieBai_00}%s#{JieBai_01}", sAllUserName);	
	BroadMsgByChatPipe(sceneId, selfId, sMessage, 4);
	
end

--**********************************
--¼ì²âÁìÈ¡³ÆºÅ
--**********************************
function x806001_CheckDrawTitle( sceneId, selfId, targetId )

	--(1)ÊÇ·ñ×é¶Ó
	if LuaFnHasTeam( sceneId, selfId ) == 0 then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["caa"] )
		return 0
	end
	
	--È¡¶ÓÎéÈËÊý£¬ÈËÊý²»ÄÜÊÇ1¸ö
	local TeamSize = LuaFnGetTeamSize( sceneId, selfId )
	TotalTeamNum = TeamSize
	if TeamSize == 1 then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["caa"] )
		return 0
	end

	--È¡Í¬³¡¾°¶ÓÎéÈËÊý
	local TeamSizeSameScene = LuaFnGetTeamSceneMemberCount( sceneId, selfId )
	if TeamSizeSameScene+1 ~= TeamSize then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["caa"] )
		return 0
	end

	--(2)ÊÇ·ñ¶Ó³¤
	if LuaFnIsTeamLeader( sceneId, selfId ) ~= 1 then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["cac"] )
		return 0
	end
	
	--(3)ÊÇ·ñ½á°Ý¹ý
	local BrotherNum = LuaFnIsSweared(sceneId, selfId)
	if BrotherNum == 0 then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["cas"] )
		return 0
	end

	--(4)ÊÇ·ñ¶ÓÎéÖÐÓÐ²»ÊÇ½á°ÝÐÖµÜµÄ¶ÓÔ±
	local i = 0
	local theID = 0
	local Brothers = 0
	while i < TeamSizeSameScene do
		theID = LuaFnGetTeamSceneMember( sceneId, selfId, i )
		if LuaFnIsBrother(sceneId, selfId, theID) == 0 then
			x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["cab"] )
			return 0
		end
		Brothers = Brothers + 1
		i = i + 1
	end

	--(5)ÊÇ·ñËùÓÐ¶ÓÔ±¶¼À´ÁË
	if BrotherNum ~= Brothers then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["caa"] )
		return 0
	end

	--(6)ÊÇ·ñÓÐ×ã¹»µÄ½ðÇ®
	--hzp 2008-12-26
		local nMoneyJZ = GetMoneyJZ(sceneId, selfId);
		local nMoneyJB = LuaFnGetMoney(sceneId, selfId);
		local nMoneySelf = nMoneyJZ + nMoneyJB;
	--if LuaFnGetMoney( sceneId, selfId ) < x806001_g_DrawTitleNeedMoney then	
	if nMoneySelf < x806001_g_DrawTitleNeedMoney then	
		local msg	= format( x806001_g_msg_swear["nom"], x806001_g_DrawTitleNeedMoney )
		x806001_MessageBox( sceneId, selfId, targetId, msg )
		return 0
	end
	
	--(7)ÊÇ·ñÒÑ¾­Áì¹ý³ÆºÅÁË
	--ÁìÈ¡¹ý³ÆºÅºó£¬ÈÔÈ»¿ÉÒÔÁìÈ¡³ÆºÅ£¬ÓÃÓÚµ±½á°ÝÈËÊý·¢Éú±ä»¯Ê±£¬ÐÞ¸Ä½á°ÝÐÖµÜµÄ³ÆºÅ
	
	--local title = LuaFnGetJieBaiName( sceneId, selfId )
	--if title ~= nil then
		--x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["cat"] )
		--return 0
	--end
	
	--·µ»Ø¶ÓÎéÖÐ×ÜÈËÊý
	return TeamSize
end

--**********************************
--¼ì²âÐÞ¸Ä³ÆºÅ
--**********************************
function x806001_CheckChangeTitle( sceneId, selfId, targetId )

	--(1)ÊÇ·ñ½á°Ý¹ý
	local BrotherNum = LuaFnIsSweared(sceneId, selfId)
	if BrotherNum == 0 then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["ccs"] )
		return 0
	end
	
	--(2)ÊÇ·ñÁìÈ¡¹ý³ÆºÅ
	local title = LuaFnGetJieBaiName( sceneId, selfId )
	if title == nil then
		x806001_MessageBox( sceneId, selfId, targetId, x806001_g_msg_swear["can"] )
		return 0
	end
	
	--(3)ÊÇ·ñÓÐ×ã¹»µÄ½ðÇ®
	--hzp 2008-12-26
	local nMoneyJZ = GetMoneyJZ(sceneId, selfId);
	local nMoneyJB = LuaFnGetMoney(sceneId, selfId);
	local nMoneySelf = nMoneyJZ + nMoneyJB;
	--if LuaFnGetMoney( sceneId, selfId ) < x806001_g_ChangeTitleNeedMoney then	
	if nMoneySelf < x806001_g_ChangeTitleNeedMoney then	
		local msg	= format( x806001_g_msg_swear["nmm"], x806001_g_ChangeTitleNeedMoney )
		x806001_MessageBox( sceneId, selfId, targetId, msg )
		return 0
	end
	
	return 1

end

--**********************************
--µÈ´ýÆäËûÈËÈ·¶¨µÄ¶Ô»°´°¿ÚÐÅÏ¢ÌáÊ¾
--**********************************
function x806001_WaitSwear( sceneId, selfId, targetId )
	BeginEvent( sceneId )
		AddText( sceneId, x806001_g_msg_swear["wait"] )		
		AddNumText( sceneId, x806001_g_ScriptId, "Ta vçn chßa nghî là ta s¨ kªt bái...", 8, x806001_g_key["uncon"] )
	EndEvent( sceneId )
	DispatchEventList( sceneId, selfId, targetId )
end
