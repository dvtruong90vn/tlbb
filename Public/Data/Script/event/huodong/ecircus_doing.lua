--ÂíÏ·ÍÅ»î¶¯

--½Å±¾ºÅ
x808005_g_ScriptId			= 808005
x808005_g_ScriptId_Ctrl	= 808006	--»Øµ÷½Å±¾

x808005_g_PrizeBase			= 8000		-- ğÕt ğßşc´ó½±toÕ ğµ ¼¸ÂÊ»ùÊı
x808005_g_PrizeMoney		= 1000		--½ğÇ®½±Àø
x808005_g_Prize0				= 10141041--×øÆï
x808005_g_Prize1				= 30308024--ÆïÊõ
x808005_g_RoundMax			= 50			--mµt ÌìÖĞ¿ÉÒÔLînh toÕ ğµ ×î´ó»·Êı

--²Ù×÷¼¯
x808005_g_Key	=
{
	["chg"]			= 100,		--Ìá½»ÕäÊŞ,¶mµt »½±Àø
	["inf"]			= 101,		--¹ØÓÚ
}

--×Ö´®¼¯
x808005_g_Str	=
{
	--²»°üº¬×ªÒå×Ö·ûtoÕ ğµ ×Ö´®
	["inf2"]		= "  #Wngoài ra chï c¥n ğßa ra trân thú bäo bäo là ğßşc, còn thÑc ån Nhuª Tß s¨ tuÏ ch÷n mµt thÑ trong thÑc ån chï ğ¸nh các hÕ mang theo trên ngß¶i .",
	["ful"]			= "  Th§t ngÕi quá, hôm nay ğ¬ các hÕ tìm thÑc ån và trân thú nhi«u thª này, bên tÕi hÕ g¥n nhß ğã ğü. Hoan nghênh l¥n sau ğªn tìm tÕi hÕ.",
	["bty1"]		= "  #Wğa tÕ các hÕ cung c¤p thÑc ån cho trân thú, ğây là mµt chút lòng thành cüa tÕi hÕ, xin các hÕ nh§n l¤y.",
	["bty2"]		= "  #Wğa tÕ các hÕ ğã làm nhi«u chuy®n vì tÕi hÕ. — ğây có mµt con voi và mµt quy¬n sách dÕy các hÕ cách cßŞi voi, xin t£ng các hÕ. Voi nß¾c chúng tôi r¤t quı, xin các hÕ hãy chåm sóc nó tØ tª. #r #GTrß¾c khi cßŞi voi nh¤t thiªt phäi h÷c phß½ng pháp cßŞi#W.",

	--°üº¬×ªÒå×Ö·ûtoÕ ğµ ×Ö´®
	["inf1"]		= "  #WThÑ 2 và thÑ 6 hàng tu¥n ğem thÑc ån và trân thú bäo bäo ğªn tìm Nhuª Tß. M²i l¥n giao trân thú bäo bäo Nhu® Tß cûng l¤y mµt loÕi trong các thÑc ån các hÕ mang theo. M²i l¥n giao mµt Trân thú và mµt loÕi thÑc ån s¨ nh§n ğßşc #{_MONEY"..x808005_g_PrizeMoney.."}, ngoài ra có xác su¤t nh¤t ğ¸nh s¨ nh§n ğßşc Voi#G 2 ngß¶i cßŞi #W.",
	["inf_pet"]	= "  #WTrân thú bäo bäo Nhuª Tß thu mua có: #r#G%s#W.",
	["inf_itm"]	= "  #WNgoài ra hãy nh¾, khi mang trân thú bäo bäo ğªn nh¾ mang theo mµt loÕi thÑc ån b¤t kÏ, nªu không Nhuª Tß s¨ t× ch¯i nh§n trân thú bäo bäo. #r#WThÑc ån Nhuª Tß c¥n có: #r#G%s#W.",
	["ned_pet"]	= "  #WtÕi hÕ chï c¥n nhæng trân thú bäo bäo sau: #r#G%s#W.",
	["ned_itm"]	= "  #WTrân thú các hÕ ğßa cho tÕi hÕ là ğúng r°i, nhßng tÕi hÕ còn c¥n mµt loÕi thÑc ån b¤t kÏ sau: #r#G%s#W.",
	["msg_bty"]	= "#R#{_INFOUSR%s} mang trân thú bäo bäo và thÑc ån ğªn cho sÑ giä ğoàn xiªc ğ¬ ông ta xem, làm ph¥n thß·ng, ğßa cho ông ta #{_INFOUSR%s} mµt #{_INFOMSG%s} và mµt quy¬n sách kÛ nång cßŞi thú.",
}

--ÕäÊŞ¼¯
x808005_g_Pet	=
{
	[1]	= { id = 3099, name = "Tích D¸ch Bäo Bäo " },
	[2]	= { id = 3129, name = "NgÕc Ngß Bäo Bäo " },
	[3]	= { id = 3109, name = "Bi¬n BÑc Bäo Bäo " },
	[4]	= { id = 3119, name = "Ğß¶ng Lang Bäo Bäo " },
	[5]	= { id = 3139, name = "Miêu Ğ¥u ¿ng Bäo Bäo " },
	[6]	= { id = 3149, name = "Ch°n Bäo Bäo " },
	[7]	= { id = 3159, name = "H± Bäo Bäo " },
	[8]	= { id = 3169, name = "Dã Trß Bäo Bäo " },
}

--ÎïÆ·¼¯
x808005_g_Itm	=
{
	[1]	= { id = 30101064, name = "HÕnh Nhân Tô" },
	[2]	= { id = 30101054, name = "Bánh khoai" },
	[3]	= { id = 30101065, name = "Thanh Minh Ba" },
	[4]	= { id = 30101055, name = "Nhu M­ Cao" },
	[5]	= { id = 30101066, name = "Ba Tiêu Ham PhÕn" },
	[6]	= { id = 30101056, name = "Hß½ng Cô Thái Bao" },
	[7]	= { id = 30101084, name = "Quan Thang Bao" },
	[8]	= { id = 30101074, name = "Kiêu Ch¤p Ngß Phiªn" },
	[9]	= { id = 30101085, name = "LÕp Thiêu Hß½ng Loa" },
	[10]= { id = 30101075, name = "Mã Nghîa Thßşng Thø" },
	[11]= { id = 30101086, name = "Ph¤n Chßng Áp Nhøc" },
	[12]= { id = 30101076, name = "Bát Trân Thuçn Kê Thang" },
}

--**********************************
--ÈÎÎñÈë¿Úº¯Êı
--**********************************
function x808005_OnDefaultEvent( sceneId, selfId, targetId )

	--Ñ¡Ôñ°´Å¥
	local	key	= GetNumText()

	--Ìá½»ÕäÊŞºÍÊ³Îï
	if key == x808005_g_Key["chg"] then
		if CallScriptFunction( x808005_g_ScriptId_Ctrl, "IsActivityDoing", sceneId ) == 1 then
			--´ò¿ªÕäÊŞ½çÃæ
			str_1	= format( "  #WTÕi hÕ chï c¥n nhæng trân thú bäo bäo sau: #r #G%s#W.", x808005_MyGetBuyList( 0 ) )
			str_2	= format( "  #Wvà nhæng thÑc ån sau: #r #G%s#W.", x808005_MyGetBuyList( 1 ) )
			BeginEvent( sceneId )
				AddText( sceneId, str_1 )
				AddText( sceneId, str_2 )
			EndEvent( sceneId )
			DispatchMissionDemandInfo( sceneId, selfId, targetId, x808005_g_ScriptId, -1, 2 )
		else
			x808005_MyNotifyTip( sceneId, selfId, "Bây gi¶ không phäi là th¶i gian hoÕt ğµng!" )
		end

	--¹ØÓÚ
	elseif key == x808005_g_Key["inf"] then
		str_1	= format( x808005_g_Str["inf_pet"], x808005_MyGetBuyList( 0 ) )
		str_2	= format( x808005_g_Str["inf_itm"], x808005_MyGetBuyList( 1 ) )
		BeginEvent( sceneId )
			AddText( sceneId, x808005_g_Str["inf1"] )
			if str_1 ~= nil then
				AddText( sceneId, str_1 )
			end
			if str_2 ~= nil then
				AddText( sceneId, str_2 )
			end
			AddText( sceneId, x808005_g_Str["inf2"] )
		EndEvent( sceneId )
		DispatchEventList( sceneId, selfId, targetId )
	end

end

--**********************************
--ÁĞ¾ÙÊÂ¼ş
--**********************************
function x808005_OnEnumerate( sceneId, selfId, targetId )

	if CallScriptFunction( x808005_g_ScriptId_Ctrl, "IsActivityDoing", sceneId ) == 1 then
		AddNumText( sceneId, x808005_g_ScriptId, "— ch² tÕi hÕ có trân thú bäo bäo các hÕ c¥n.", 6, x808005_g_Key["chg"] )
	end
	AddNumText( sceneId, x808005_g_ScriptId, "Các hoÕt ğµng cüa ğoàn xiªc", 11, x808005_g_Key["inf"] )

end

--**********************************
--»î¶¯½±Àø
--**********************************
function x808005_MyOnBounty( sceneId, selfId, targetId, indexitm, indexpet )

	local	num_chg	= 0
	local	num_bty	= 0
	
	--µ±ÌìtoÕ ğµ »·Êı¿ØÖÆ
	--100000toÕ ğµ ±¶ÊıĞúngµ±Ç°Íê³ÉtoÕ ğµ »·Êı,Ğ¡ÓÚ100000toÕ ğµ ÊıĞúngÊ±¼ä
	--begin modified by zhangguoxin 090207
	local iDayCount	= GetMissionData( sceneId, selfId, MD_CIRCUS_DAYCOUNT )
	if iDayCount == nil or iDayCount < 0 then
		iDayCount			= 0
	end
	local iTime			= iDayCount - floor( iDayCount/100000 ) * 100000
	--local iDayTime	= floor( iTime/100 )									--ÉÏmµt ´Î½»»ò·ÅÆúÈÎÎñtoÕ ğµ Ê±¼ä(ÌìÊı)
	local iDayTime	= iTime																	--ÉÏmµt ´Î½»»ò·ÅÆúÈÎÎñtoÕ ğµ Ê±¼ä(ÌìÊı)
	--local iQuaTime	= iTime - floor( iTime/100 ) * 100			--ÉÏmµt ´Î½»»ò·ÅÆúÈÎÎñtoÕ ğµ Ê±¼ä(¿Ì)
	local iDayHuan	= floor( iDayCount/100000 )							--µ±ÌìÄÚÍê³ÉtoÕ ğµ S¯ l¥n nhi®m vø 
	--local CurTime		= GetHourTime()													--µ±Ç°Ê±¼ä
	--local CurDaytime= floor( CurTime/100 )									--µ±Ç°Ê±¼ä(Ìì)
	local CurDaytime = GetDayTime()														--µ±Ç°Ê±¼ä(Ìì)
	--local CurQuaTime = CurTime - floor( CurTime/100 ) * 100	--µ±Ç°Ê±¼ä(¿Ì)
	
	--ÉÏ´ÎHoàn t¤t nhi®m vøĞúngÍ¬mµt ÌìÄÚ
	if CurDaytime == iDayTime then
		iDayHuan			= iDayHuan + 1
		--iQuarterTime	= CurQuaTime
	--ÉÏ´ÎHoàn t¤t nhi®m vø²»TÕi Í¬mµt Ìì,ÖØÖÃ
	else
		iDayTime			= CurDaytime
		iQuarterTime	= 0
		iDayHuan			= 0
	end
	if iDayHuan > x808005_g_RoundMax then
		x808005_MyMsgBox( sceneId, selfId, targetId, x808005_g_Str["ful"] )
		return 0
	else
		--iDayCount			= iDayHuan * 100000 + iDayTime * 100 + iQuarterTime
		iDayCount			= iDayHuan * 100000 + iDayTime;
	end
	--end modified by zhangguoxin 090207
	
	--ÒªTÕi ±£Ö¤ÕäÊŞ¡¢ÎïÆ·Ìá½»¶¼ÕıÈ·toÕ ğµ ÇéĞÎÏÂ,ÔÙ½øĞĞÖğmµt É¾³ı
	if indexpet < 0 or indexpet >= 255 or LuaFnIsPetAvailable( sceneId, selfId, indexpet ) ~= 1 then
		x808005_MyNotifyTip( sceneId, selfId, "Vô hi®u trân thú!" )
		return 0
	end
	if indexitm < 0 or indexitm >= 255 or LuaFnIsItemAvailable( sceneId, selfId, indexitm ) ~= 1 then
		x808005_MyNotifyTip( sceneId, selfId, "Vô hi®u thÑc ån!" )
		return 0
	end
	--¼ì²éĞúng·ñĞúngËùĞèÕäÊŞ
	local	pet_id		= LuaFnGetPet_DataID( sceneId, selfId, indexpet )
	local	pet_ret		= 0
	local	pet_unt
	for i = 1, getn( x808005_g_Pet ) do
		pet_unt				= x808005_g_Pet[ i ]
		if pet_id == pet_unt.id then
			pet_ret			= 1
			break
		end
	end
	if pet_ret ~= 1 then
		str	= format( x808005_g_Str["ned_pet"], x808005_MyGetBuyList( 0 ) )
		x808005_MyMsgBox( sceneId, selfId, targetId, str )
		return 0
	end
	--¼ì²éĞúng·ñĞúngËùĞèÎïÆ·
	local	itm_id		= LuaFnGetItemTableIndexByIndex( sceneId, selfId, indexitm )
	local	itm_ret		= 0
	local	itm_unt
	for i = 1, getn( x808005_g_Itm ) do
		itm_unt				= x808005_g_Itm[ i ]
		if itm_id == itm_unt.id then
			itm_ret			= 1
			break
		end
	end
	if itm_ret ~= 1 then
		str	= format( x808005_g_Str["ned_itm"], x808005_MyGetBuyList( 1 ) )
		x808005_MyMsgBox( sceneId, selfId, targetId, str )
		return 0
	end

	--ÕäÊŞÌá½»
	if LuaFnDeletePet( sceneId, selfId, indexpet, 1 ) > 0 then
		x808005_MyNotifyTip( sceneId, selfId, "Các hÕ ğßa mµt con "..pet_unt.name.."." )
	else
		return 0
	end
	--ÎïÆ·Ìá½»
	if HaveItemInBag( sceneId, selfId, itm_id ) > 0 and
		LuaFnGetAvailableItemCount( sceneId, selfId, itm_id ) >= 1 and
		DelItem( sceneId, selfId, itm_id, 1 ) > 0 then
		x808005_MyNotifyTip( sceneId, selfId, "Các hÕ ğßa mµt loÕi "..itm_unt.name.."." )
	else
		return 0
	end

	if pet_ret == 1 and itm_ret == 1 then
		--³É¹¦¶mµt »mµt ´Î,¼ÆÊıÎŞÉÏÏŞ
		num_chg			= CallScriptFunction( x808005_g_ScriptId_Ctrl, "OnSuccChange", sceneId )
		--Ç®½±Àø
		AddMoney( sceneId, selfId, x808005_g_PrizeMoney )
		--³É¹¦ËÍ³ö
		x808005_MyMsgBox( sceneId, selfId, targetId, x808005_g_Str["bty1"] )
		--³É¹¦ËÍ³öºóÉèÖÃ»·Êı
		SetMissionData( sceneId, selfId, MD_CIRCUS_DAYCOUNT, iDayCount )
		--Add Log
		LogInfo			= format( "[CIRCUS]: x808005_MyOnBounty( sceneId=%d, GUID=%0X ), pet=%d, itm=%d, num_chg=%d, num_bty=%d, PRIZE_MONEY(%d)",
			sceneId,
			LuaFnObjId2Guid( sceneId, selfId ),
			pet_id, itm_id, num_chg, num_bty, x808005_g_PrizeMoney )
		MissionLog( sceneId, LogInfo )
	else
		return 0
	end

	--´óÏó¼¸ÂÊ½±Àø
	if random( x808005_g_PrizeBase ) == 1 and LuaFnGetPropertyBagSpace( sceneId, selfId ) >= 2 then
		--³É¹¦´ó½±mµt ´Î,¼ÆÊıÎŞÉÏÏŞ
		num_bty			= CallScriptFunction( x808005_g_ScriptId_Ctrl, "OnSuccPrize", sceneId )
		if num_bty > 0 then
			local	idBag0	= LuaFnTryRecieveItem( sceneId, selfId, x808005_g_Prize0, 1 )	--×øÆï
			local	idBag1	= LuaFnTryRecieveItem( sceneId, selfId, x808005_g_Prize1, 1 )	--ÆïÊõ
			local	szTran
			if idBag0 >= 0 and idBag1 >= 0 then
				szTran			= GetBagItemTransfer( sceneId, selfId, idBag0 )
				--³É¹¦ËÍ³ö
				x808005_MyMsgBox( sceneId, selfId, targetId, x808005_g_Str["bty2"] )
				if szTran ~= nil then
					str				= format( x808005_g_Str["msg_bty"], GetName( sceneId, selfId ), GetName( sceneId, selfId ), szTran )
					x808005_MyGlobalNews( sceneId, str )
				end
				--Add Log
				LogInfo			= format( "[CIRCUS]: x808005_MyOnBounty( sceneId=%d, GUID=%0X ), pet=%d, itm=%d, num_chg=%d, num_bty=%d, PRIZE_ITEM(%d,%d)",
					sceneId,
					LuaFnObjId2Guid( sceneId, selfId ),
					pet_id, itm_id, num_chg, num_bty, x808005_g_Prize0, x808005_g_Prize1 )
				MissionLog( sceneId, LogInfo )
			end
		end
	end
	return 1

end

--**********************************
--Íæ¼ÒÌá½»ÕäÊŞºótoÕ ğµ »Øµ÷º¯Êı
--**********************************
function x808005_OnMissionCheck( sceneId, selfId, npcid, scriptId, index1, index2, index3, indexpet )

	if indexpet >= 255 then
		--Ë÷ÒıÖµTr· v«255±íÊ¾¿Õ,Ã»Ìá½»ÕäÊŞ
		x808005_MyNotifyTip( sceneId, selfId, "Hãy kéo trân thú vào trong cØa s±!" )
	elseif index1 < 0 or index1 >= 255 then
		x808005_MyNotifyTip( sceneId, selfId, "Hãy kéo thÑc ån vào ô v§t ph¦m ğ¥u tiên!" )
	else
		x808005_MyOnBounty( sceneId, selfId, npcid, index1, indexpet )
	end

end

--**********************************
--»ñÈ¡ÊÕ¹ºÁĞ±í
--**********************************
function x808005_MyGetBuyList( type )

	local	str	= ""
	local	lst
	if type == 0 then
		lst			= x808005_g_Pet
	else
		lst			= x808005_g_Itm
	end

	for i = 1, getn( lst ) do
		if i ~= 1 then
			str		= str..", "
		end
		str		= str..lst[i].name
	end
	return str

end

--**********************************
--¶Ô»°¿òÌáÊ¾
--**********************************
function x808005_MyMsgBox( sceneId, selfId, targetId, str )

	BeginEvent( sceneId )
		AddText( sceneId, str )
	EndEvent( sceneId )
	DispatchEventList( sceneId, selfId, targetId )

end

--**********************************
--ĞÑÄ¿ÌáÊ¾
--**********************************
function x808005_MyNotifyTip( sceneId, selfId, str )

	BeginEvent( sceneId )
		AddText( sceneId, str )
	EndEvent( sceneId )
	DispatchMissionTips( sceneId, selfId )

end

--**********************************
--È«Çò¹«¸æ
--**********************************
function x808005_MyGlobalNews( sceneId, str )

	if str == nil then
		return
	end
	AddGlobalCountNews( sceneId, str )

end
