--ÈÎÎñÁ´

--MisDescBegin
--½Å±¾ºÅ
x229009_g_scriptId = 229009

--ÈÎÎñÎÄ±¾ÃèÊö
x229009_g_ExchangeItem ="Ð±i v§t ph¦m"
x229009_g_ExchangeTitle ="Ð±i danh hi®u"
x229009_g_MissionInfo ="Ð¬ c± vû các ð® tØ môn phái phát huy rÕng rõ cho môn phái mình, sß phø ðã chu¦n b¸ mµt s¯ ph¥n thß·ng, dùng #R400 #Wði¬m c¯ng hiªn môn phái là có th¬ ð±i"  --ÈÎÎñÃèÊö
x229009_g_MissionTarget =""
x229009_g_ContinueInfo =""			--Î´Hoàn t¤t nhi®m vøtoÕ ðµ npc¶Ô»°
x229009_g_MissionComplete =""	--Hoàn t¤t nhi®m vønpcËµ»°toÕ ðµ »°

--MisDescEnd

x229009_g_exchangeitembymenpaipoint_Index = 23

x229009_g_menpainpc_table =  {
	{menpaiid=MP_SHAOLIN,  menpainame="Thiªu Lâm", name="Huy«n T×",	 title="Phß½ng Trßþng Thiªu Lâm",	x=38, z=98},
	{menpaiid=MP_MINGJIAO, menpainame="Minh Giáo", name="Lâm Thª Trß¶ng", title="Minh Giáo Giáo Chü", 	x=98, z=52},
	{menpaiid=MP_GAIBANG,  menpainame="Cái Bang", name="T¯ng T×",	 title="Trß·ng Lão Cái Bang", 	x=91, z=63},
	{menpaiid=MP_WUDANG, 	 menpainame="Võ Ðang", name="Trß½ng Huy«n T¯", title="Chß·ng Môn Phái Võ Ðang",	x=73, z=82},
	{menpaiid=MP_EMEI, 		 menpainame="Nga My", name="MÕnh Thanh Thanh", title="Chß·ng Môn Phái Nga My",	x=96, z=73},
	{menpaiid=MP_DALI, 	   menpainame="Thiên Long", name="Bän Nhân",	 title="Phß½ng Trßþng Thiên Long Tñ",	x=96, z=66},
	{menpaiid=MP_XINGSU, 	 menpainame="Tinh Túc", name="Ðinh Xuân Thu", title="Chß·ng Môn Tinh Túc",	x=142, z=55},
	{menpaiid=MP_TIANSHAN, menpainame="Thiên S½n", name="Mai Kiªm",	 title="ÐÕi Sß Muµi Thiên S½n",	x=91, z=44},
	{menpaiid=MP_XIAOYAO,  menpainame="Tiêu Dao", name="Tô Tinh Hà", title="Quy«n Chß·ng Môn Tiêu Dao",	x=125, z=144},
}           

--ÄÐ
x229009_g_MaleTitleInfo = {
	{tlvl=1, mpp=0,    slt="Thiªu Lâm Hi®p SÛ", mjt="Minh Giáo Hi®p SÛ", gbt="Cái Bang Hi®p SÛ", wdt="Võ Ðang Hi®p SÛ", emt="Nga My Hi®p SÛ", xxt="Tinh Túc Hi®p SÛ", tlt="Thiên Long Hi®p SÛ", tst="Thiên S½n Hi®p SÛ", xyt="Tiêu Dao Hi®p SÛ"},
	{tlvl=2, mpp=1000, slt="Khôi Y Hµ Pháp", mjt="Th¸ Hoä Hi®p SÛ", gbt="Thanh Liên Ð® TØ", wdt="Thanh Minh Cß SÛ", emt="Thanh Phong Cß SÛ", xxt="Hành Ôn Lang Quân", tlt="Tàng Kinh Hi®p SÛ", tst="Dß½ng Thiên Bµ Chúng", xyt="Phù C¥m Cß SÛ"},
	{tlvl=3, mpp=2500, slt="Kim Thân La Hán", mjt="Hµ Giáo Pháp Vß½ng", gbt="Huy«n Võ Trß·ng Lão", wdt="Vô Vi Chân Nhân", emt="Ng÷c Long Hi®p SÛ", xxt="Thúc M®nh Phán Quan", tlt="Sùng Thánh Thiên Sß", tst="Thiên S½n Thß½ng ¿ng", xyt="LÕc Th¥n Hi®p SÛ"},
	{tlvl=4, mpp=5000, slt="Ð¸a TÕng B° Tát", mjt="Quang Minh Thánh SÑ", gbt="Chß·ng Bang Long Ð¥u", wdt="Bát Quái Chân Nhân", emt="Loan Phßþng Tiên Nhân", xxt="Ðµc Thü Y Tiên", tlt="Thiên Nam Long Vß½ng", tst="H²n Nguyên S½n Th¥n", xyt="Tiêu Dao Long Th¥n"},
}
--Å®	
x229009_g_femaleTitleInfo = {	
	{tlvl=1, mpp=0,	   slt="Thiªu Lâm Hi®p Næ", mjt="Minh Giáo Hi®p Næ", gbt="Cái Bang Hi®p Næ", wdt="Võ Ðang Hi®p Næ", emt="Nga My Hi®p Næ", xxt="Tinh Túc Hi®p Næ", tlt="Thiên Long Hi®p Næ", tst="Thiên S½n Hi®p Næ", xyt="Tiêu Dao Hi®p Næ"},
	{tlvl=2, mpp=1000, slt="BÕch Y Th¸ Giä", mjt="Th¸ Hoä Hi®p Næ", gbt="BÕch Liên Ð® TØ", wdt="BÕch Vân Cß SÛ", emt="Minh Nguy®t Cß SÛ", xxt="Hành ‘n Nß½ng TØ", tlt="Tàng Kinh Hi®p Næ", tst="HÕo Thiên Bµ Chúng", xyt="Thì Hoa Cß SÛ"},
	{tlvl=3, mpp=2500, slt="Ðµ Thª Quan Âm", mjt="Hµ Giáo Tán Nhân", gbt="Chu Tß¾c Trß·ng Lão", wdt="Thanh T¸nh Tán Nhân", emt="Kim Phßþng Hi®p Næ", xxt="ÐoÕt M®nh DÕ Xoa", tlt="Sùng Thánh Thiên Næ", tst="Thiên S½n Tuyªt Kê", xyt="Lång Ba Hi®p Næ"},
	{tlvl=4, mpp=5000, slt="Già Lam B° Tát", mjt="Quang Minh Thánh Næ", gbt="Chß·ng Bát Long Næ", wdt="Linh HÕc Chân Nhân", emt="Kim Phßþng Tiên TØ", xxt="Ðµc Thü Dßþc Vß½ng", tlt="Thiên Nam Long Næ", tst="H²n Nguyên Hoa Th¥n", xyt="Tiêu Dao Thánh Næ"},
}

x229009_g_shimentitle_bonusitem = {
	{menpaiid=MP_SHAOLIN,	bonusItem=10113004},
	{menpaiid=MP_MINGJIAO,	bonusItem=10113004},
	{menpaiid=MP_GAIBANG,	bonusItem=10113004},
	{menpaiid=MP_WUDANG,	bonusItem=10113004},
	{menpaiid=MP_EMEI, 		bonusItem=10113004},
	{menpaiid=MP_DALI, 		bonusItem=10113004},
	{menpaiid=MP_XINGSU,	bonusItem=10113004},
	{menpaiid=MP_TIANSHAN,	bonusItem=10113004},
	{menpaiid=MP_XIAOYAO,	bonusItem=10113004},
}

--**********************************
--ÊÂ¼þ½»»¥Èë¿Ú
--**********************************
function x229009_OnDefaultEvent( sceneId, selfId,targetId )
	--PrintStr("OnDefaultEvent...")
	for i, v in x229009_g_menpainpc_table do
		if v.name == GetName(sceneId, targetId) then
			if v.menpaiid == GetMenPai(sceneId, selfId) then
				--PrintNum(GetNumText())
				if 10 <= GetNumText() and GetNumText() <= 14 then
					--¶mµt »³ÆºÅ
					x229009_ExchangeTitleBymenpaipoint( sceneId, selfId,targetId, GetNumText()-10 )
				elseif 7 == GetNumText() then
				x229009_ExchangeItemBymenpaipoint( sceneId, selfId,targetId )
				break
				elseif 8 == GetNumText() then
					--Ìí¼Ó³ÆºÅ
					x229009_AddExchangeTitleList( sceneId, selfId,targetId )
					break
				end	
			else
				local str ="Ngß½i không phäi là ð® tØ bän môn, ta chï phøc vø cho ð® tØ môn phái"
				BeginEvent(sceneId)
					AddText(sceneId, str)
				EndEvent()
				DispatchMissionTips(sceneId, selfId)
				Msg2Player(  sceneId, selfId, str, MSG2PLAYER_PARA )		
			end	
		end
	end
end

--**********************************
--ÁÐ¾ÙÊÂ¼þ
--**********************************
function x229009_OnEnumerate( sceneId, selfId, targetId )
	--PrintStr("OnEnumerate...")
	AddNumText(sceneId,x229009_g_scriptId, x229009_g_ExchangeItem, 3, 7);
	AddNumText(sceneId,x229009_g_scriptId, x229009_g_ExchangeTitle, 3, 8);

end

function x229009_ExchangeItemBymenpaipointFn( sceneId, selfId,targetId, needPoint )
	
	if (needPoint < 0 ) then
		return
	end
	
	local menpaipoint = GetHumanMenpaiPoint(sceneId, selfId)
	if menpaipoint < 400 then
		local str ="Ði¬m c¯ng hiªn hi®n tÕi cüa ngß½i là " .. tostring(menpaipoint) ..", vçn không ðü 400 hãy c¯ lên"
		BeginEvent(sceneId)
			AddText(sceneId, str)
		EndEvent()
		DispatchMissionTips(sceneId, selfId)
		Msg2Player(  sceneId, selfId, str, MSG2PLAYER_PARA )		
	else
		local nItemId, strItemName, strItemDesc = GetOneMissionItem(x229009_g_exchangeitembymenpaipoint_Index)
		BeginAddItem(sceneId)
			AddItem(sceneId,nItemId, 1)
		local ret = EndAddItem(sceneId,selfId)
		if ret <= 0 then
			BeginEvent(sceneId)
				AddText(sceneId,"Tay näi cüa ngß½i ðã ð¥y, không th¬ ð±i ðßþc")
			EndEvent()
			DispatchMissionTips(sceneId, selfId)
		else
			AddItemListToHuman(sceneId, selfId)
			SetHumanMenpaiPoint(sceneId, selfId, menpaipoint-400)
			local str = format("Tr× 400 ði¬m ðµ c¯ng hiªn môn phái, ngß½i ðã ðÕt ðßþc %s", strItemName)
			Msg2Player(  sceneId, selfId, str, MSG2PLAYER_PARA )	
			
			str = format("Các hÕ ðÕt ðßþc %s.", strItemName)
			BeginEvent(sceneId)
				AddText(sceneId, str)
			EndEvent()
			DispatchMissionTips(sceneId, selfId)
				
		end
	end	
	
end

function x229009_ExchangeItemBymenpaipoint( sceneId, selfId,targetId )
	BeginUICommand(sceneId)
		UICommand_AddInt(sceneId,x229009_g_scriptId);
		UICommand_AddInt(sceneId,targetId);
		UICommand_AddString(sceneId,"ExchangeItemBymenpaipointFn");
		UICommand_AddString(sceneId,x229009_g_MissionInfo);
	EndUICommand(sceneId)
	DispatchUICommand(sceneId,selfId, 24)

end

--/////////////////////////////////////////////////////////////////////////////////

function x229009_GetCurShimenTitleLevel(menpai, title )  --, titleinfo)
	local titlelevel = 0
	if menpai == MP_SHAOLIN then
		for i=1, 4 do
			if title == x229009_g_MaleTitleInfo[i].slt then
				titlelevel = x229009_g_MaleTitleInfo[i].tlvl
				return titlelevel
			end
			if title == x229009_g_femaleTitleInfo[i].slt then
				titlelevel = x229009_g_femaleTitleInfo[i].tlvl
				return titlelevel
			end
		end	
	elseif menpai == MP_MINGJIAO then
		for i=1, 4 do
			if title == x229009_g_MaleTitleInfo[i].mjt then
				titlelevel = x229009_g_MaleTitleInfo[i].tlvl
				return titlelevel
			end
			if title == x229009_g_femaleTitleInfo[i].mjt then
				titlelevel = x229009_g_femaleTitleInfo[i].tlvl
				return titlelevel
			end
		end	
	elseif menpai == MP_GAIBANG then
		for i=1, 4 do
			if title == x229009_g_MaleTitleInfo[i].gbt then
				titlelevel = x229009_g_MaleTitleInfo[i].tlvl
				return titlelevel
			end
			if title == x229009_g_femaleTitleInfo[i].gbt then
				titlelevel = x229009_g_femaleTitleInfo[i].tlvl
				return titlelevel
			end
		end	
	elseif menpai == MP_WUDANG then
		for i=1, 4 do
			if title == x229009_g_MaleTitleInfo[i].wdt then
				titlelevel = x229009_g_MaleTitleInfo[i].tlvl
				return titlelevel
			end
			if title == x229009_g_femaleTitleInfo[i].wdt then
				titlelevel = x229009_g_femaleTitleInfo[i].tlvl
				return titlelevel
			end
		end	
	elseif menpai == MP_EMEI then
		for i=1, 4 do
			if title == x229009_g_MaleTitleInfo[i].emt then
				titlelevel = x229009_g_MaleTitleInfo[i].tlvl
				return titlelevel
			end
			if title == x229009_g_femaleTitleInfo[i].emt then
				titlelevel = x229009_g_femaleTitleInfo[i].tlvl
				return titlelevel
			end
		end	
	elseif menpai == MP_DALI then
		for i=1, 4 do
			if title == x229009_g_MaleTitleInfo[i].tlt then
				titlelevel = x229009_g_MaleTitleInfo[i].tlvl
				return titlelevel
			end
			if title == x229009_g_femaleTitleInfo[i].tlt then
				titlelevel = x229009_g_femaleTitleInfo[i].tlvl
				return titlelevel
			end
		end	
	elseif menpai == MP_XINGSU then
		for i=1, 4 do
			if title == x229009_g_MaleTitleInfo[i].xxt then
				titlelevel = x229009_g_MaleTitleInfo[i].tlvl
				return titlelevel
			end
			if title == x229009_g_femaleTitleInfo[i].xxt then
				titlelevel = x229009_g_femaleTitleInfo[i].tlvl
				return titlelevel
			end
		end	
	elseif menpai == MP_TIANSHAN then
		for i=1, 4 do
			if title == x229009_g_MaleTitleInfo[i].tst then
				titlelevel = x229009_g_MaleTitleInfo[i].tlvl
				return titlelevel
			end
			if title == x229009_g_femaleTitleInfo[i].tst then
				titlelevel = x229009_g_femaleTitleInfo[i].tlvl
				return titlelevel
			end
		end	
	elseif menpai == MP_XIAOYAO then
		for i=1, 4 do
			if title == x229009_g_MaleTitleInfo[i].xyt then
				titlelevel = x229009_g_MaleTitleInfo[i].tlvl
				return titlelevel
			end
			if title == x229009_g_femaleTitleInfo[i].xyt then
				titlelevel = x229009_g_femaleTitleInfo[i].tlvl
				return titlelevel
			end
		end	
	end
	
	return titlelevel
end

function x229009_GetSelectedTitle(menpai, titleinfo, level)
	if level < 1 or level > 4 then
		return 0, 0,""
	end
	
	local title =""
	if menpai == MP_SHAOLIN then
		title = titleinfo[level].slt
	elseif menpai == MP_MINGJIAO then
		title = titleinfo[level].mjt
	elseif menpai == MP_GAIBANG then
		title = titleinfo[level].gbt
	elseif menpai == MP_WUDANG then
		title = titleinfo[level].wdt
	elseif menpai == MP_EMEI then
		title = titleinfo[level].emt
	elseif menpai == MP_DALI then
		title = titleinfo[level].tlt
	elseif menpai == MP_XINGSU then
		title = titleinfo[level].xxt
	elseif menpai == MP_TIANSHAN then
		title = titleinfo[level].tst
	elseif menpai == MP_XIAOYAO then
		title = titleinfo[level].xyt
	end
	
	return titleinfo[level].tlvl, titleinfo[level].mpp, title
end

function x229009_AddExchangeTitleList(sceneId, selfId, targetId)
	--PrintStr("AddExchangeTitleList...")
	-- ði¬mµ½ÃÅÅÉ
	local level = GetLevel(sceneId, selfId)
	local menpai = GetMenPai(sceneId, selfId)
	--local shimentitle = GetShimenTitle(sceneId, selfId)
	--ÄÐÅ®ÅÐ¶Ï
	local titleinfo
	local sex = GetSex(sceneId, selfId)
	if 1 == sex then
		titleinfo = x229009_g_MaleTitleInfo
	elseif 0 == sex then
		titleinfo = x229009_g_femaleTitleInfo
	end

	local step = 10
	BeginEvent(sceneId)
	
	if menpai == MP_SHAOLIN then
		for i=1, 4 do
			local seltitlelvl, needpoint, seltitle = x229009_GetSelectedTitle(menpai, titleinfo, i)
			local str = seltitle .." c¥n " .. needpoint .." ði¬m c¯ng hiªn sß môn"
			AddNumText(sceneId,x229009_g_scriptId, str, 3, i+step)
		end
	elseif menpai == MP_MINGJIAO then
		for i=1, 4 do
			local seltitlelvl, needpoint, seltitle = x229009_GetSelectedTitle(menpai, titleinfo, i)
			local str = seltitle .." c¥n " .. needpoint .." ði¬m c¯ng hiªn sß môn"
			AddNumText(sceneId,x229009_g_scriptId, str, 3, i+step)
		end
	elseif menpai == MP_GAIBANG then
		for i=1, 4 do
			local seltitlelvl, needpoint, seltitle = x229009_GetSelectedTitle(menpai, titleinfo, i)
			local str = seltitle .." c¥n " .. needpoint .." ði¬m c¯ng hiªn sß môn"
			AddNumText(sceneId,x229009_g_scriptId, str, 3, i+step)
		end
	elseif menpai == MP_WUDANG then
		for i=1, 4 do
			local seltitlelvl, needpoint, seltitle = x229009_GetSelectedTitle(menpai, titleinfo, i)
			local str = seltitle .." c¥n " .. needpoint .." ði¬m c¯ng hiªn sß môn"
			AddNumText(sceneId,x229009_g_scriptId, str, 3, i+step)
		end
	elseif menpai == MP_EMEI then
		for i=1, 4 do
			local seltitlelvl, needpoint, seltitle = x229009_GetSelectedTitle(menpai, titleinfo, i)
			local str = seltitle .." c¥n " .. needpoint .." ði¬m c¯ng hiªn sß môn"
			AddNumText(sceneId,x229009_g_scriptId, str, 3, i+step)
		end
	elseif menpai == MP_DALI then
		for i=1, 4 do
			local seltitlelvl, needpoint, seltitle = x229009_GetSelectedTitle(menpai, titleinfo, i)
			local str = seltitle .." c¥n " .. needpoint .." ði¬m c¯ng hiªn sß môn"
			AddNumText(sceneId,x229009_g_scriptId, str, 3, i+step)
		end
	elseif menpai == MP_XINGSU then
		for i=1, 4 do
			local seltitlelvl, needpoint, seltitle = x229009_GetSelectedTitle(menpai, titleinfo, i)
			local str = seltitle .." c¥n " .. needpoint .." ði¬m c¯ng hiªn sß môn"
			AddNumText(sceneId,x229009_g_scriptId, str, 3, i+step)
		end
	elseif menpai == MP_TIANSHAN then
		for i=1, 4 do
			local seltitlelvl, needpoint, seltitle = x229009_GetSelectedTitle(menpai, titleinfo, i)
			local str = seltitle .." c¥n " .. needpoint .." ði¬m c¯ng hiªn sß môn"
			AddNumText(sceneId,x229009_g_scriptId, str, 3, i+step)
		end
	elseif menpai == MP_XIAOYAO then
		for i=1, 4 do
			local seltitlelvl, needpoint, seltitle = x229009_GetSelectedTitle(menpai, titleinfo, i)
			local str = seltitle .." c¥n " .. needpoint .." ði¬m c¯ng hiªn sß môn"
			AddNumText(sceneId,x229009_g_scriptId, str, 3, i+step)
		end
	end
	
	EndEvent()
	
	DispatchEventList(sceneId,selfId,targetId)
end

function x229009_GetShimenTitle_BonusItem(sceneId, selfId)
	local menpai = GetMenPai(sceneId, selfId)
	for i, v in x229009_g_shimentitle_bonusitem do
		if v.menpaiid == menpai then
			return v.bonusItem
		end
	end
	return 0
end

function x229009_ExchangeTitleBymenpaipoint( sceneId, selfId,targetId, level )
	--PrintStr("ExchangeTitleBymenpaipoint")
	--SetHumanMenpaiPoint(sceneId, selfId, 1000000)
	local titleinfo
	local menpai = GetMenPai(sceneId, selfId)
	local sex = GetSex(sceneId, selfId)
	if 1 == sex then
		titleinfo = x229009_g_MaleTitleInfo
	elseif 0 == sex then
		titleinfo = x229009_g_femaleTitleInfo
	end
	local title = GetShimenTitle(sceneId, selfId)
	--PrintStr("title=" .. title)
	local seltitlelvl, needpoint, seltitle = x229009_GetSelectedTitle(menpai, titleinfo, level)
	local curtitlelvl = x229009_GetCurShimenTitleLevel(menpai, title)
	
	--PrintStr("seltitlelvl=" .. seltitlelvl)
	--PrintStr("curtitlelvl=" .. curtitlelvl)
	
	local str
	if seltitlelvl < curtitlelvl then
		str ="Ngß½i ðã có danh xßng môn phái c¤p cao, không c¥n ð±i næa"
	elseif seltitlelvl == curtitlelvl then
		str ="Ngß½i ðã có danh xßng này, không c¥n ð±i næa"
	elseif seltitlelvl > curtitlelvl then
		local menpaipoint = GetHumanMenpaiPoint(sceneId, selfId)
		--PrintStr("menpaipoint=" .. menpaipoint)
		--PrintStr("needpoint=" .. needpoint)
		if needpoint <= menpaipoint then
			if seltitlelvl == 2 then
				BeginAddItem(sceneId)
					AddItem(sceneId, x229009_GetShimenTitle_BonusItem(sceneId, selfId), 1)
				local ret = EndAddItem(sceneId,selfId)
				if ret > 0 then
					AddItemListToHuman(sceneId, selfId)
					str ="Chúc m×ng ngß½i ðã ðÕt ðßþc #Y" .. seltitle .."#W danh xßng, hy v÷ng tiªp tøc vì b±n môn n² lñc phát huy danh tiªng. Ðây là 1 bµ y trang cüa b±n môn, coi nhß là mµt ph¥n thß·ng cüa sß phø ban cho ngß½i cho nhæng v¤t vä ðã qua"
					SetShimenTitle(sceneId, selfId, seltitle)
					LuaFnDispatchAllTitle(sceneId, selfId)
					SetHumanMenpaiPoint(sceneId, selfId, menpaipoint-needpoint)
				else
					str ="Tay näi cüa ngß½i ðã ð¥y, vi sß chu¦n b¸ chút quà cho ngß½i. SØa soÕn tay näi xong, hãy t¾i tìm ta"
				end	
			else
				str ="Chúc m×ng ngß½i ðã ðÕt ðßþc #Y" .. seltitle .."#W danh xßng, hy v÷ng tiªp tøc vì b±n môn n² lñc phát huy danh tiªng"
				SetShimenTitle(sceneId, selfId, seltitle)
				LuaFnDispatchAllTitle(sceneId, selfId)
				SetHumanMenpaiPoint(sceneId, selfId, menpaipoint-needpoint)
			end
		else
			str ="Ðµ c¯ng hiªn môn phái cüa ngß½i hi®n không ðü, không th¬ ð±i ðßþc"			
		end
	end
	BeginEvent(sceneId)
		AddText(sceneId, str)
	EndEvent()
	DispatchEventList(sceneId,selfId,targetId)	
end

